# properties/management/commands/load_metro_stations.py
from django.core.management.base import BaseCommand
from properties.models import MetroStation
from django.contrib.gis.geos import Point
import requests
from django.conf import settings
import logging
import re
import time
from collections import defaultdict

logger = logging.getLogger(__name__)

CITIES_WITH_METRO = [
    'Москва',
]

# Полный словарь соответствия названий линий и их цветов
LINE_COLORS = {
    # Метрополитен
    'Сокольническая': '#FF0000',
    'Замоскворецкая': '#008000',
    'Арбатско-Покровская': '#0000FF',
    'Филёвская': '#00BFFF',
    'Кольцевая': '#A52A2A',
    'Калужско-Рижская': '#FFA500',
    'Таганско-Краснопресненская': '#800080',
    'Калининская': '#FFC0CB',
    'Серпуховско-Тимирязевская': '#808080',
    'Люблинско-Дмитровская': '#7CFC00',
    'Бутовская': '#8DD8D8',
    'Солнцевская': '#8DD8D8',
    'Некрасовская': '#FF69B4',
    'Большая кольцевая': '#8B4513',
    'Троицкая': '#00CED1',

    # МЦК
    'МЦК': '#8B4513',

    # МЦД
    'МЦД-1': '#DAA520',  # Белорусско-Савёловский
    'МЦД-2': '#FF00FF',  # Курско-Рижский
    'МЦД-3': '#FFEFD5',  # Ленинградско-Казанский
    'МЦД-4': '#98FF98',  # Калужско-Нижегородский
    'МЦД-5': '#00FF7F',  # Ярославско-Павелецкий

    # Монорельс
    'Монорельс': '#8B008B',
}

# Полный словарь всех станций московского метро с указанием линии и цвета
SPECIAL_STATIONS = {
    # Сокольническая линия (1)
    'Библиотека имени Ленина': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Бульвар Рокоссовского': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Воробьёвы горы': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Комсомольская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Красносельская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Красные ворота': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Кропоткинская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Лубянка': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Охотный Ряд': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Парк культуры': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Преображенская площадь': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Проспект Вернадского': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Румянцево': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Саларьево': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Сокольники': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Спортивная': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Тропарёво': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Университет': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Фрунзенская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Черкизовская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Чистые пруды': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Юго-Западная': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},

    # Новые станции Сокольнической линии
    'Филатов Луг': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Прокшино': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Ольховая': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Коммунарка': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Потапово': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},
    'Новомосковская': {'line': 'Сокольническая линия', 'line_color': '#FF0000'},

    # Замоскворецкая линия (2)
    'Автозаводская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Алма-Атинская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Аэропорт': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Беломорская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Белорусская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Динамо': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Маяковская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Новокузнецкая': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Павелецкая': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Речной вокзал': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Сокол': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Театральная': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Тверская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Технопарк': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Царицыно': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Кантемировская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Каширская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Коломенская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Красногвардейская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Орехово': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Домодедовская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Войковская': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Водный стадион': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},
    'Ховрино': {'line': 'Замоскворецкая линия', 'line_color': '#008000'},

    # Арбатско-Покровская линия (3)
    'Арбатская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Бауманская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Измайловская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},

    'Митино': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},

    'Партизанская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Первомайская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Площадь Революции': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Пятницкое шоссе': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Семёновская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Славянский бульвар': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},

    'Щёлковская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Электрозаводская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Кунцевская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Молодёжная': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Крылатское': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Строгино': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Мякинино': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},
    'Волоколамская': {'line': 'Арбатско-Покровская линия', 'line_color': '#0000FF'},

    # Филёвская линия (4)
    'Александровский сад': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Выставочная': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Киевская': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Кутузовская': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Международная': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Пионерская': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Смоленская': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Студенческая': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Фили': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Багратионовская': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Филевский парк': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},
    'Москва-Сити': {'line': 'Филёвская линия', 'line_color': '#00BFFF'},


    # Кольцевая линия (5)

    'Добрынинская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},

    'Краснопресненская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},
    'Курская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},
    'Новослободская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},
    'Октябрьская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},

    'Проспект Мира': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},
    'Таганская': {'line': 'Кольцевая линия', 'line_color': '#A52A2A'},

    # Калужско-Рижская линия (6)
    'Академическая': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Алексеевская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Бабушкинская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Беляево': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Ботанический сад': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'ВДНХ': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Калужская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Китай-город': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Коньково': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Ленинский проспект': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Медведково': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Новоясеневская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Новые Черёмушки': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Профсоюзная': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Рижская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Свиблово': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Сухаревская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Тёплый Стан': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Третьяковская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Тургеневская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Шаболовская': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},
    'Ясенево': {'line': 'Калужско-Рижская линия', 'line_color': '#FFA500'},

    # Таганско-Краснопресненская линия (7)
    'Баррикадная': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Беговая': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Волгоградский проспект': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Выхино': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Жулебино': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Котельники': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Кузнецкий мост': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Кузьминки': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Лермонтовский проспект': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Октябрьское поле': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Планерная': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Полежаевская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Пролетарская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Пушкинская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Рязанский проспект': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Спартак': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Сходненская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Текстильщики': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Тушинская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Улица 1905 года': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},
    'Щукинская': {'line': 'Таганско-Краснопресненская линия', 'line_color': '#800080'},

    # Калининско-Солнцевская линия (8)
    'Авиамоторная': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Аэропорт Внуково': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Боровское шоссе': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Говорово': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Деловой центр': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Ломоносовский проспект': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Марксистская': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Минская': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Мичуринский проспект': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Новогиреево': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Новокосино': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Новопеределкино': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Озёрная': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Парк Победы': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Перово': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Площадь Ильича': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Пыхтино': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Раменки': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Рассказовка': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},
    'Солнцево': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},

    'Шоссе Энтузиастов': {'line': 'Калининско-Солнцевская линия', 'line_color': '#FFD700'},

    # Серпуховско-Тимирязевская линия (9)
    'Алтуфьево': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Аннино': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Бибирево': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Боровицкая': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Бульвар Дмитрия Донского': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Владыкино': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Дмитровская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Менделеевская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Нагатинская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Нагорная': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Нахимовский проспект': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Отрадное': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Петровско-Разумовская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Полянка': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Пражская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Савеловская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Севастопольская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Серпуховская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Тимирязевская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Тульская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Улица академика Янгеля': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Цветной бульвар': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Чертановская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Чеховская': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},
    'Южная': {'line': 'Серпуховско-Тимирязевская линия', 'line_color': '#808080'},

    # Люблинско-Дмитровская линия (10)
    'Борисово': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Братиславская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Бутырская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Верхние Лихоборы': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Волжская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Достоевская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Дубровка': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Зябликово': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Кожуховская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Крестьянская застава': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Лианозово': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Люблино': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Марьина Роща': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Марьино': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Окружная': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Печатники': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Римская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Селигерская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Сретенский бульвар': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Трубная': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Физтех': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Фонвизинская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Чкаловская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Шипиловская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},
    'Яхромская': {'line': 'Люблинско-Дмитровская линия', 'line_color': '#7CFC00'},

    # Большая кольцевая линия (11)
    'Аминьевская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Варшавская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Воронцовская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Давыдково': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Зюзино': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Каховская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Кленовый бульвар': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Лефортово': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Мнёвники': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Нагатинский Затон': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Народное Ополчение': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Нижегородская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Новаторская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Петровский парк': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Терехово': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'Хорошёвская': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},
    'ЦСКА': {'line': 'Большая кольцевая линия', 'line_color': '#8B4513'},


    # Бутовская линия (12)
    'Битцевский парк': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Бульвар адмирала Ушакова': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Бунинская Аллея': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Лесопарковая': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Улица Горчакова': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Улица Скобелевская': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},
    'Улица Старокачаловская': {'line': 'Бутовская линия', 'line_color': '#8DD8D8'},

    # Некрасовская линия (15)
    'Косино': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Лухмановская': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Некрасовка': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Окская': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Стахановская': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Улица Дмитриевского': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},
    'Юго-Восточная': {'line': 'Некрасовская линия', 'line_color': '#FF69B4'},

    # Троицкая линия (17)

    'Университет Дружбы Народов': {'line': 'Троицкая линия', 'line_color': '#00CED1'},

    # МЦК (14)
    'Андроновка': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Балтийская': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Белокаменная': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Верхние Котлы': {'line': 'МЦК', 'line_color': '#8B4513'},
    'ЗИЛ': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Зорге': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Измайлово': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Коптево': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Крымская': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Лихоборы': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Локомотив': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Лужники': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Новохохловская': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Панфиловская': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Площадь Гагарина': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Ростокино': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Соколиная Гора': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Стрешнево': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Угрешская': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Хорошёво': {'line': 'МЦК', 'line_color': '#8B4513'},
    'Шелепиха': {'line': 'МЦК', 'line_color': '#8B4513'},

    # МЦД-1 (D1)
    'Бескудниково': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Дегунино': {'line': 'МЦД-1', 'line_color': '#DAA520'},

    'Тестовская': {'line': 'МЦД-1', 'line_color': '#DAA520'},


    # МЦД-2 (D2)

    'Площадь трёх вокзалов': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    'Красный Балтиец': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Гражданская': {'line': 'МЦД-2', 'line_color': '#FF00FF'},


    # МЦД-3 (D3)

    'Митьково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    'Сортировочная': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},


    # МЦД-4 (D4)
    'Реутов': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Серп и Молот': {'line': 'МЦД-4', 'line_color': '#98FF98'},

    'Каланчёвская': {'line': 'МЦД-4', 'line_color': '#98FF98'},




    # Троицкая линия
    'Генерала Тюленева': {'line': 'Троицкая линия', 'line_color': '#00CED1'},
    'Корниловская': {'line': 'Троицкая линия', 'line_color': '#00CED1'},

    'Тютчевская': {'line': 'Троицкая линия', 'line_color': '#00CED1'},

    # Монорельс
    'Выставочный центр': {'line': 'Монорельс', 'line_color': '#8B008B'},
    'Телецентр': {'line': 'Монорельс', 'line_color': '#8B008B'},
    'Улица Академика Королёва': {'line': 'Монорельс', 'line_color': '#8B008B'},
    'Улица Милашенкова': {'line': 'Монорельс', 'line_color': '#8B008B'},
    'Улица Сергея Эйзенштейна': {'line': 'Монорельс', 'line_color': '#8B008B'},



    # МЦД-1
    'Баковка': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Водники': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Долгопрудная': {'line': 'МЦД-1', 'line_color': '#DAA520'},

    'Лобня': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Марк': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Немчиновка': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Новодачная': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Одинцово': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Рабочий Посёлок': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Сетунь': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Сколково': {'line': 'МЦД-1', 'line_color': '#DAA520'},

    'Хлебниково': {'line': 'МЦД-1', 'line_color': '#DAA520'},
    'Шереметьевская': {'line': 'МЦД-1', 'line_color': '#DAA520'},

    # МЦД-2
    'Аникеевка': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Битца': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Бутово': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    'Депо': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Калитники': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Красногорская': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Красный Строитель': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Курьяново': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    'Москва-Товарная': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Москворечье': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Нахабино': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Опалиха': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Остафьево': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Павшино': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Пенягино': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Перерва': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Подольск': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Покровское': {'line': 'МЦД-2', 'line_color': '#FF00FF'},
    'Силикатная': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    'Трикотажная': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    'Щербинка': {'line': 'МЦД-2', 'line_color': '#FF00FF'},

    # МЦД-3
    'Быково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Вешняки': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    'Грачёвская': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Есенинская': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Зеленоград-Крюково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Ильинская': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Ипподром': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    'Красково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Кратово': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Левобережная': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    'Люберцы': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Малаховка': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Молжаниново': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Моссельмаш': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Новоподрезково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Останкино': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Отдых': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Панки': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    'Плющево': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Подрезково': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Раменское': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Сходня': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Томилино': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Удельная': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Ухтомская': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Фабричная': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Фирсановская': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},
    'Химки': {'line': 'МЦД-3', 'line_color': '#FFEFD5'},

    # МЦД-4
    'Апрелевка': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Внуково': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Железнодорожная': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Кокошкино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Крёкшино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Кусково': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Кучино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Лесной Городок': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Матвеевская': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Мещерская': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Мичуринец': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Никольское': {'line': 'МЦД-4', 'line_color': '#98FF98'},

    'Ольгино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Очаково': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Переделкино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Победа': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Поклонная': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Санино': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Солнечная': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Толстопальцево': {'line': 'МЦД-4', 'line_color': '#98FF98'},
    'Чухлинка': {'line': 'МЦД-4', 'line_color': '#98FF98'},
}

# Словарь нормализации названий станций
STATION_NAME_MAPPING = {
    # Москва
    'Улица Подбельского': 'Бульвар Рокоссовского',
    'Кировская': 'Чистые пруды',
    'Мясницкая': 'Чистые пруды',
    'Дзержинская': 'Лубянка',
    'Охотный ряд': 'Охотный Ряд',
    'Станция имени Л. М. Кагановича': 'Охотный Ряд',
    'Проспект Маркса': 'Охотный Ряд',
    'Дворец Советов': 'Кропоткинская',
    'Парк культуры имени Горького': 'Парк культуры',
    'Ленинские горы': 'Воробьёвы горы',
    'Ленино': 'Царицыно',
    'Завод имени Сталина': 'Автозаводская',
    'Завод имени Лихачева': 'Автозаводская',
    'Площадь Свердлова': 'Театральная',
    'Горьковская': 'Тверская',
    'Арбатская площадь': 'Арбатская',
    'Спартаковская': 'Бауманская',
    'Сталинская': 'Семеновская',
    'Стадион народов': 'Партизанская',
    'Измайловская': 'Партизанская',
    'Измайловский парк': 'Партизанская',
    'Стадион им. Сталина': 'Партизанская',
    'Улица Коминтерна': 'Александровский сад',
    'Им. Коминтерна': 'Александровский сад',
    'Калининская': 'Александровский сад',
    'Воздвиженка': 'Александровский сад',
    'Деловой центр': 'Выставочная',
    'Ботанический сад': 'Проспект Мира',
    'Калужская': 'Октябрьская',
    'Серпуховская': 'Добрынинская',
    'ВСХВ': 'ВДНХ',
    'Мир': 'Алексеевская',
    'Щербаковская': 'Алексеевская',
    'Ново-Алексеевская': 'Алексеевская',
    'Колхозная': 'Сухаревская',
    'Площадь Ногина': 'Китай-город',
    'Ждановская': 'Выхино',
    'Битцевский парк': 'Новоясеневская',

    # Станции с приставкой "станция"
    'станция метро Беговая': 'Беговая',
    'станция метро Марьина Роща': 'Марьина Роща',
    'станция метро Курская': 'Курская',
    'станция метро Савёловская': 'Савёловская',
    'станция метро Лужники': 'Лужники',
    'станция метро Рижская': 'Рижская',
    'станция метро Белорусская': 'Белорусская',
    'станция метро Серп и Молот': 'Серп и Молот',
    'станция метро Митьково': 'Митьково',
    'станция метро Нижегородская': 'Нижегородская',
    'станция метро Лефортово': 'Лефортово',
    'станция Беговая': 'Беговая',
    'станция Марьина Роща': 'Марьина Роща',
    'станция Курская': 'Курская',
    'станция Савёловская': 'Савёловская',
    'станция Лужники': 'Лужники',
    'станция Рижская': 'Рижская',
    'станция Белорусская': 'Белорусская',
    'станция Серп и Молот': 'Серп и Молот',
    'станция Митьково': 'Митьково',
    'станция Нижегородская': 'Нижегородская',
    'станция Лефортово': 'Лефортово',

    # Другие варианты названий
    'метро Беговая': 'Беговая',
    'метро Марьина Роща': 'Марьина Роща',
    'метро Курская': 'Курская',
    'метро Савёловская': 'Савёловская',
    'метро Лужники': 'Лужники',
    'метро Рижская': 'Рижская',
    'метро Белорусская': 'Белорусская',
    'метро Серп и Молот': 'Серп и Молот',
    'метро Митьково': 'Митьково',
    'метро Нижегородская': 'Нижегородская',
    'метро Лефортово': 'Лефортово',
    'метро Динамо': 'Динамо',
    'метро Маяковская': 'Маяковская',
    'метро Новокузнецкая': 'Новокузнецкая',
    'метро Тверская': 'Тверская',
    'метро Театральная': 'Театральная',
    'метро Марксистская': 'Марксистская',
    'метро Площадь Ильича': 'Площадь Ильича',
    'метро Третьяковская': 'Третьяковская',
    'метро Октябрьская': 'Октябрьская',
    'метро Проспект Мира': 'Проспект Мира',
    'метро Сухаревская': 'Сухаревская',
    'метро Тургеневская': 'Тургеневская',
    'метро Шаболовская': 'Шаболовская',
    'метро Добрынинская': 'Добрынинская',
    'метро Киевская': 'Киевская',
    'метро Комсомольская': 'Комсомольская',
    'метро Краснопресненская': 'Краснопресненская',
    'метро Новослободская': 'Новослободская',
    'метро Павелецкая': 'Павелецкая',
    'метро Баррикадная': 'Баррикадная',
    'метро Китай-город': 'Китай-город',
    'метро Кузнецкий Мост': 'Кузнецкий мост',
    'метро Пролетарская': 'Пролетарская',
    'метро Пушкинская': 'Пушкинская',
    'метро Таганская': 'Таганская',
    'метро Достоевская': 'Достоевская',
    'метро Крестьянская Застава': 'Крестьянская застава',
    'метро Римская': 'Римская',
    'метро Сретенский бульвар': 'Сретенский бульвар',
    'метро Трубная': 'Трубная',
    'метро Чкаловская': 'Чкаловская',
    'метро Боровицкая': 'Боровицкая',
    'метро Менделеевская': 'Менделеевская',
    'метро Полянка': 'Полянка',
    'метро Цветной бульвар': 'Цветной бульвар',
    'метро Чеховская': 'Чеховская',
    'метро Библиотека имени Ленина': 'Библиотека имени Ленина',
    'метро Красносельская': 'Красносельская',
    'метро Красные Ворота': 'Красные ворота',
    'метро Кропоткинская': 'Кропоткинская',
    'метро Лубянка': 'Лубянка',
    'метро Спортивная': 'Спортивная',
    'метро Фрунзенская': 'Фрунзенская',
    'метро Александровский сад': 'Александровский сад',
    'метро Арбатская': 'Арбатская',
    'метро Смоленская': 'Смоленская',
    'метро Студенческая': 'Студенческая',
    'метро Площадь Революции': 'Площадь Революции',
}

NON_METRO_KEYWORDS = [
    'аэропорт', 'аэродром', 'вокзал', 'трасса', 'шоссе', 'автодорога',
    'дорога', 'километр', 'территория', 'улица', 'посёлок', 'поселок',
    'село', 'деревня', 'квартал', 'корпус', 'здание', 'терминал',
    'СНТ', 'СДТ', 'ЖК', 'Женерал', 'Эвбанк', 'Триштау', 'Эштрейту',
    'Дендропарк', 'Гора', 'река', 'речной', 'М-', 'Р-', 'К-', 'А-'
]


class Command(BaseCommand):
    help = 'Load and update metro stations from Yandex API with line information'

    def remove_duplicate_stations(self):
        """Удаляет дубликаты станций с префиксами 'метро' и 'станция'"""
        deleted_count = 0

        # Получаем все станции
        all_stations = MetroStation.objects.all()

        # Создаем словарь для группировки станций по нормализованным именам
        stations_dict = defaultdict(list)

        for station in all_stations:
            # Нормализуем имя станции
            normalized_name = self.normalize_station_name(station.name)
            stations_dict[normalized_name].append(station)

        # Обрабатываем группы станций
        for normalized_name, stations in stations_dict.items():
            if len(stations) > 1:
                # Находим "основную" станцию (без префиксов)
                main_station = None
                prefixed_stations = []

                for station in stations:
                    if station.name.lower().startswith(('метро ', 'станция ')):
                        prefixed_stations.append(station)
                    else:
                        main_station = station

                # Если нашли основную станцию и есть станции с префиксами
                if main_station and prefixed_stations:
                    for prefixed_station in prefixed_stations:
                        # Обновляем данные основной станции, если нужно
                        if not main_station.line and prefixed_station.line:
                            main_station.line = prefixed_station.line
                        if not main_station.line_color and prefixed_station.line_color:
                            main_station.line_color = prefixed_station.line_color
                        if not main_station.coordinates and prefixed_station.coordinates:
                            main_station.coordinates = prefixed_station.coordinates

                        # Удаляем станцию с префиксом
                        prefixed_station.delete()
                        deleted_count += 1

                    # Сохраняем обновленную основную станцию
                    main_station.save()

        return deleted_count

    def normalize_station_name(self, name):
        """Нормализует название станции, удаляя префиксы"""
        name = re.sub(r'^(метро|станция)\s+', '', name, flags=re.IGNORECASE).strip()
        return name

    def handle(self, *args, **options):
        self.cleanup_and_normalize_stations()

        stats = defaultdict(int)
        missing_data = {
            'line': [],
            'color': []
        }

        for city in CITIES_WITH_METRO:
            self.stdout.write(f"\nProcessing city: {city}", style_func=self.style.HTTP_INFO)
            try:
                # Получаем координаты города
                city_url = f"https://geocode-maps.yandex.ru/1.x/?apikey={settings.YANDEX_GEOCODER_API_KEY}&format=json&geocode={city}"
                self.stdout.write(f"Fetching city coordinates: {city_url}", style_func=self.style.SQL_FIELD)
                city_response = requests.get(city_url)
                city_response.raise_for_status()
                city_data = city_response.json()

                # Извлекаем координаты города
                city_pos = city_data['response']['GeoObjectCollection']['featureMember'][0]['GeoObject']['Point']['pos']
                lon, lat = map(float, city_pos.split())
                self.stdout.write(f"City coordinates: lon={lon}, lat={lat}", style_func=self.style.SQL_FIELD)

                # Используем несколько точек для поиска, чтобы покрыть всю Москву
                search_points = [
                    (lon, lat),  # Центр
                    (37.617, 55.755),  # Центр (альтернативные координаты)
                    (37.7, 55.8),  # Северо-запад
                    (37.8, 55.7),  # Северо-восток
                    (37.6, 55.6),  # Юго-запад
                    (37.9, 55.6)  # Юго-восток
                ]

                processed_stations = set()

                for point_lon, point_lat in search_points:
                    # Ищем метро с увеличенным радиусом
                    metro_url = f"https://geocode-maps.yandex.ru/1.x/?apikey={settings.YANDEX_GEOCODER_API_KEY}&format=json&geocode={point_lon},{point_lat}&kind=metro&results=500&spn=0.5,0.5"
                    self.stdout.write(f"Fetching metro stations: {metro_url}", style_func=self.style.SQL_FIELD)
                    metro_response = requests.get(metro_url)
                    metro_response.raise_for_status()
                    metro_data = metro_response.json()

                    features = metro_data.get('response', {}).get('GeoObjectCollection', {}).get('featureMember', [])
                    if not features:
                        self.stdout.write(
                            self.style.WARNING(f"No metro stations found for point {point_lon},{point_lat}"))
                        continue

                    for feature in features:
                        geo_object = feature.get('GeoObject', {})
                        station_name = geo_object.get('name', '')
                        pos = geo_object.get('Point', {}).get('pos', '')
                        description = geo_object.get('description', '')

                        if not station_name or not pos:
                            continue

                        if self.is_non_metro_station(station_name):
                            self.stdout.write(f"Skipping non-metro station: {station_name}",
                                              style_func=self.style.WARNING)
                            continue

                        self.stdout.write(f"\nProcessing station: {station_name}", style_func=self.style.HTTP_INFO)
                        self.stdout.write(f"Description: {description}", style_func=self.style.SQL_FIELD)

                        # Проверка дубликатов
                        station_key = f"{city}:{station_name}"
                        if station_key in processed_stations:
                            self.stdout.write(f"Skipping duplicate station: {station_name}",
                                              style_func=self.style.WARNING)
                            continue
                        processed_stations.add(station_key)

                        # Определение линии и цвета
                        line_name, line_color = self.get_line_info(station_name, description, city)

                        if not line_name:
                            stats['no_line'] += 1
                            missing_data['line'].append(f"{city}: {station_name}")
                            logger.warning(f"No line info for station: {station_name} (description: {description})")

                        if not line_color:
                            stats['no_color'] += 1
                            missing_data['color'].append(f"{city}: {station_name} (line: {line_name})")

                        # Сохранение станции
                        lon, lat = map(float, pos.split())
                        obj, created = MetroStation.objects.update_or_create(
                            city=city,
                            name=station_name,
                            defaults={
                                'line': line_name,
                                'line_color': line_color,
                                'coordinates': Point(lon, lat, srid=4326)
                            }
                        )

                        action = "Added" if created else "Updated"
                        self.stdout.write(f"{action} station: {station_name} (line: {line_name}, color: {line_color})",
                                          style_func=self.style.SUCCESS)
                        stats['processed'] += 1
                        time.sleep(0.1)

            except Exception as e:
                logger.error(f"Error loading metro stations for {city}: {str(e)}")
                self.stdout.write(self.style.ERROR(f"Error processing {city}: {str(e)}"))

        deleted_duplicates = self.remove_duplicate_stations()
        self.stdout.write(self.style.SUCCESS(f"\nRemoved {deleted_duplicates} duplicate stations"))

        # Вывод статистики
        self.print_stats(stats, missing_data)

    # Улучшаем метод get_line_info для лучшего определения станций
    def get_line_info(self, original_name, description, city):
        """Получает информацию о линии и цвете для станции с учетом города"""
        # Сначала проверяем специальные случаи
        if 'МЦК' in (description or '') or 'Московское центральное кольцо' in (description or ''):
            return 'МЦК', '#8B4513'
        if 'МЦД-1' in (description or ''):
            return 'МЦД-1', '#DAA520'
        if 'МЦД-2' in (description or ''):
            return 'МЦД-2', '#FF00FF'
        if 'МЦД-3' in (description or ''):
            return 'МЦД-3', '#FFEFD5'
        if 'МЦД-4' in (description or ''):
            return 'МЦД-4', '#98FF98'

        # Нормализация названия
        cleaned_name = re.sub(r'станция метро|метро', '', original_name, flags=re.IGNORECASE).strip()
        normalized_name = STATION_NAME_MAPPING.get(cleaned_name, cleaned_name)

        # 1. Проверка SPECIAL_STATIONS в порядке: оригинальное -> очищенное -> нормализованное
        for name in [original_name, cleaned_name, normalized_name]:
            if name in SPECIAL_STATIONS:
                self.stdout.write(f"Found in SPECIAL_STATIONS: {name}", style_func=self.style.SUCCESS)
                return SPECIAL_STATIONS[name]['line'], SPECIAL_STATIONS[name]['line_color']

        # 2. Если не найдено в SPECIAL_STATIONS, парсим из описания
        if description:
            self.stdout.write(f"Checking description: {description}", style_func=self.style.SQL_FIELD)

            # Поиск информации о линии в описании
            line_match = re.search(
                r'(\w+ линия|\d+ линия|МЦК|МЦД-\d+|Большая кольцевая линия|Калининско-Солнцевская линия|Троицкая линия|Бутовская линия|Некрасовская линия)',
                description
            )
            if line_match:
                line_name = line_match.group(1)
                line_key = line_name.replace(' линия', '').strip()

                self.stdout.write(f"Found line in description: {line_name}", style_func=self.style.SQL_FIELD)

                # Обработка числовых линий (СПб)
                if line_key.isdigit() and city == 'Санкт-Петербург':
                    line_number = int(line_key)
                    spb_lines = {
                        1: 'Кировско-Выборгская',
                        2: 'Московско-Петроградская',
                        3: 'Невско-Василеостровская',
                        4: 'Правобережная',
                        5: 'Фрунзенско-Приморская'
                    }
                    if line_number in spb_lines:
                        line_key = spb_lines[line_number]
                        line_name = f"{line_key} линия"

                # Поиск альтернативных названий
                if line_key not in LINE_COLORS:
                    for key in LINE_COLORS:
                        if key in line_key or line_key in key:
                            line_key = key
                            break

                # Форматирование названия линии
                if line_name.endswith('линия') and line_key in LINE_COLORS:
                    line_name = f"{line_key} линия"

                return line_name, LINE_COLORS.get(line_key)

        self.stdout.write(
            f"No line info found for station: {original_name} (cleaned: {cleaned_name}, normalized: {normalized_name})",
            style_func=self.style.WARNING)
        return None, None

    def cleanup_and_normalize_stations(self):
        """Нормализация названий и удаление нестандартных станций"""
        normalized = deleted = 0

        for old_name, new_name in STATION_NAME_MAPPING.items():
            stations = MetroStation.objects.filter(name=old_name)
            for station in stations:
                existing = MetroStation.objects.filter(city=station.city, name=new_name).first()
                if existing:
                    existing.line = station.line or existing.line
                    existing.line_color = station.line_color or existing.line_color
                    existing.coordinates = station.coordinates or existing.coordinates
                    existing.save()
                    station.delete()
                    deleted += 1
                else:
                    station.name = new_name
                    station.save()
                    normalized += 1

        # Удаление нестандартных станций
        for station in MetroStation.objects.all():
            if self.is_non_metro_station(station.name):
                station.delete()
                deleted += 1

        self.stdout.write(self.style.SUCCESS(
            f"\nNormalized {normalized} names, deleted {deleted} non-standard stations"
        ))

    def print_stats(self, stats, missing_data):
        """Выводит итоговую статистику"""
        self.stdout.write("\n" + "=" * 50)
        self.stdout.write(self.style.SUCCESS(f"Processed {stats['processed']} stations"))
        self.stdout.write(self.style.WARNING(f"Stations without line info: {stats['no_line']}"))
        self.stdout.write(self.style.WARNING(f"Stations without color info: {stats['no_color']}"))

        if missing_data['line']:
            self.stdout.write("\nStations missing line information:")
            for station in missing_data['line'][:20]:  # Ограничиваем вывод
                self.stdout.write(f" - {station}")
            if len(missing_data['line']) > 20:
                self.stdout.write(f" ... and {len(missing_data['line']) - 20} more")

        if missing_data['color']:
            self.stdout.write("\nStations missing color information:")
            for station in missing_data['color'][:20]:
                self.stdout.write(f" - {station}")
            if len(missing_data['color']) > 20:
                self.stdout.write(f" ... and {len(missing_data['color']) - 20} more")

        self.stdout.write("=" * 50 + "\n")

    # Обновляем метод is_non_metro_station для исключения всех станций метро
    def is_non_metro_station(self, name):
        """Проверяет, является ли название станцией метро"""
        name_lower = name.lower()

        # Проверяем сначала по списку всех станций
        for station in SPECIAL_STATIONS:
            if station.lower() in name_lower:
                return False

        # Исключения для станций, которые содержат ключевые слова, но являются станциями метро
        exceptions = {
            'локомотив', 'измайлово', 'бульвар рокоссовского', 'белокаменная',
            'ростокино', 'шоссе энтузиастов', 'ботанический сад', 'андроновка',
            'новохохловская', 'угрешская', 'дубровка', 'автозаводская', 'зил',
            'крымская', 'верхние котлы', 'площадь гагарина', 'улица 1905 года',
            'улица академика янгеля', 'улица скобелевская', 'улица старокачаловская',
            'улица горчакова', 'улица дмитриевского', 'улица сергея эйзенштейна',
            'улица милашенкова', 'улица академика королёва', 'бульвар адмирала ушакова',
            'бульвар дмитрия донского', 'славянский бульвар', 'сретенский бульвар',
            'кленовый бульвар', 'цветной бульвар', 'боровское шоссе', 'пятницкое шоссе'
        }

        if any(ex in name_lower for ex in exceptions):
            return False

        return any(keyword.lower() in name_lower for keyword in NON_METRO_KEYWORDS)