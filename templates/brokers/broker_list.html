{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Брокеры недвижимости | RealEstatePro{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Заголовок -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Выберите своего брокера</h1>
        <p class="text-gray-600 mt-2">Найдите идеального специалиста для ваших нужд</p>
    </div>

    <!-- Мобильная кнопка открытия фильтров -->
    <div class="lg:hidden mb-4">
        <button class="w-full bg-gradient-to-r from-purple-600 to-teal-500 text-white py-3 px-4 rounded-lg hover:from-purple-700 hover:to-teal-600 transition-colors font-medium flex items-center justify-center" id="mobile-filters-btn">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
            Фильтры
            {% if request.GET.search or request.GET.rating or request.GET.experience or request.GET.services or request.GET.specialization %}
            <span class="ml-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">!</span>
            {% endif %}
        </button>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Боковая панель с фильтрами (десктоп) -->
        <div class="lg:w-1/4 hidden lg:block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-6">
                <!-- Форма фильтров (встроенная вместо include) -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Фильтры</h2>
                    <a href="{% url 'broker-list' %}" class="text-sm text-purple-600 hover:text-purple-800 transition-colors">
                        Сбросить все
                    </a>
                </div>

                <form method="get" class="space-y-6">
                    <!-- Поиск по имени -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Поиск по имени</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </span>
                            <input type="text" name="search" value="{{ request.GET.search }}"
                                   class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Введите имя...">
                        </div>
                    </div>

                    <!-- Рейтинг -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Минимальный рейтинг</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" name="rating" min="0" max="5" step="0.5"
                                   value="{{ request.GET.rating|default:'0' }}"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                   id="ratingSlider">
                            <span id="ratingValue" class="text-sm font-medium text-gray-700 w-10 text-center">
                                {{ request.GET.rating|default:'0' }}
                            </span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0</span>
                            <span class="flex items-center">
                                <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                5
                            </span>
                        </div>
                    </div>

                    <!-- Опыт работы -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Опыт работы</label>
                        <select name="experience" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">Все уровни опыта</option>
                            <option value="0-2" {% if request.GET.experience == "0-2" %}selected{% endif %}>Менее 2 лет</option>
                            <option value="2-5" {% if request.GET.experience == "2-5" %}selected{% endif %}>2-5 лет</option>
                            <option value="5-10" {% if request.GET.experience == "5-10" %}selected{% endif %}>5-10 лет</option>
                            <option value="10+" {% if request.GET.experience == "10+" %}selected{% endif %}>Более 10 лет</option>
                        </select>
                    </div>

                    <!-- Услуги -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 mb-3 flex items-center justify-between">
                            <span>Услуги</span>
                            <span class="text-xs text-gray-500 font-normal">Выберите одну или несколько</span>
                        </h3>
                        <div class="space-y-2">
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="services" value="consultation"
                                       {% if "consultation" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Консультации</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="services" value="selection"
                                       {% if "selection" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Подбор объекта</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="services" value="transaction"
                                       {% if "transaction" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Проведение сделок</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="services" value="legal"
                                       {% if "legal" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Юридическое сопровождение</span>
                            </label>
                        </div>
                    </div>

                    <!-- Специализация -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 mb-3 flex items-center justify-between">
                            <span>Специализация</span>
                            <span class="text-xs text-gray-500 font-normal">Выберите одну или несколько</span>
                        </h3>
                        <div class="space-y-2">
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="specialization" value="residential"
                                       {% if "residential" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Жилая недвижимость</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="specialization" value="commercial"
                                       {% if "commercial" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Коммерческая недвижимость</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="specialization" value="country"
                                       {% if "country" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Загородная недвижимость</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="specialization" value="rent"
                                       {% if "rent" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Аренда</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="specialization" value="mortgage"
                                       {% if "mortgage" in request.GET.getlist %}checked{% endif %}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="ml-3 text-sm text-gray-700">Ипотека</span>
                            </label>
                        </div>
                    </div>

                    <!-- Кнопка применения фильтров -->
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-teal-500 text-white py-3 px-4 rounded-lg hover:from-purple-700 hover:to-teal-600 transition-colors font-medium flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        Применить фильтры
                    </button>
                </form>
            </div>
        </div>

        <!-- Мобильное меню фильтров -->
        <div class="mobile-catalog-dropdown lg:hidden fixed top-0 left-0 right-0 bottom-0 bg-white z-50 overflow-y-auto transform -translate-x-full transition-transform duration-300" id="mobile-filters-dropdown">
            <div class="sticky top-0 bg-white border-b border-gray-200 z-10">
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-xl font-semibold text-gray-900">Фильтры</h2>
                    <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors" id="mobile-filters-close">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-4">
                <!-- Мобильная форма фильтров -->
                <form method="get" class="space-y-6">
                    <!-- Поиск по имени -->
                    <div class="mobile-filter-section">
                        <div class="flex justify-between items-center py-3 border-b border-gray-200">
                            <span class="font-medium text-gray-900">Поиск по имени</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div class="mobile-filter-content pt-3" style="display: none;">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </span>
                                <input type="text" name="search" value="{{ request.GET.search }}"
                                       class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       placeholder="Введите имя...">
                            </div>
                        </div>
                    </div>

                    <!-- Рейтинг -->
                    <div class="mobile-filter-section">
                        <div class="flex justify-between items-center py-3 border-b border-gray-200">
                            <span class="font-medium text-gray-900">Рейтинг</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div class="mobile-filter-content pt-3" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Минимальный рейтинг</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" name="rating" min="0" max="5" step="0.5"
                                       value="{{ request.GET.rating|default:'0' }}"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       id="ratingSliderMobile">
                                <span id="ratingValueMobile" class="text-sm font-medium text-gray-700 w-10 text-center">
                                    {{ request.GET.rating|default:'0' }}
                                </span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    5
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Опыт работы -->
                    <div class="mobile-filter-section">
                        <div class="flex justify-between items-center py-3 border-b border-gray-200">
                            <span class="font-medium text-gray-900">Опыт работы</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div class="mobile-filter-content pt-3" style="display: none;">
                            <select name="experience" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Все уровни опыта</option>
                                <option value="0-2" {% if request.GET.experience == "0-2" %}selected{% endif %}>Менее 2 лет</option>
                                <option value="2-5" {% if request.GET.experience == "2-5" %}selected{% endif %}>2-5 лет</option>
                                <option value="5-10" {% if request.GET.experience == "5-10" %}selected{% endif %}>5-10 лет</option>
                                <option value="10+" {% if request.GET.experience == "10+" %}selected{% endif %}>Более 10 лет</option>
                            </select>
                        </div>
                    </div>

                    <!-- Услуги -->
                    <div class="mobile-filter-section">
                        <div class="flex justify-between items-center py-3 border-b border-gray-200">
                            <span class="font-medium text-gray-900">Услуги</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div class="mobile-filter-content pt-3" style="display: none;">
                            <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="services" value="consultation"
                                           {% if "consultation" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Консультации</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="services" value="selection"
                                           {% if "selection" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Подбор объекта</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="services" value="transaction"
                                           {% if "transaction" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Проведение сделок</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="services" value="legal"
                                           {% if "legal" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Юридическое сопровождение</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Специализация -->
                    <div class="mobile-filter-section">
                        <div class="flex justify-between items-center py-3 border-b border-gray-200">
                            <span class="font-medium text-gray-900">Специализация</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div class="mobile-filter-content pt-3" style="display: none;">
                            <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="specialization" value="residential"
                                           {% if "residential" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Жилая недвижимость</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="specialization" value="commercial"
                                           {% if "commercial" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Коммерческая недвижимость</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="specialization" value="country"
                                           {% if "country" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Загородная недвижимость</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="specialization" value="rent"
                                           {% if "rent" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Аренда</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" name="specialization" value="mortgage"
                                           {% if "mortgage" in request.GET.getlist %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-gray-700">Ипотека</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="sticky bottom-0 bg-white pt-4 pb-6 border-t border-gray-200 mt-6">
                        <div class="flex gap-3">
                            <a href="{% url 'broker-list' %}" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium text-center">
                                Сбросить
                            </a>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-teal-500 text-white py-3 px-4 rounded-lg hover:from-purple-700 hover:to-teal-600 transition-colors font-medium flex items-center justify-center">
                                Применить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Оверлей для мобильного меню -->
        <div class="overlay lg:hidden" id="mobile-filters-overlay" style="display: none;"></div>

        <!-- Основной контент -->
        <div class="lg:w-3/4">
            <!-- Статистика и сортировка -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 flex flex-col sm:flex-row justify-between items-center">
                <p class="text-gray-600 text-sm mb-2 sm:mb-0">
                    Найдено <span class="font-semibold">{{ brokers.count }}</span> брокеров
                </p>
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 mr-2">Сортировка:</span>
                    <select class="text-sm border border-gray-300 rounded-lg px-3 py-1 focus:outline-none focus:ring-1 focus:ring-purple-500">
                        <option>По рейтингу</option>
                        <option>По опыту</option>
                        <option>По имени</option>
                    </select>
                </div>
            </div>

            <!-- Список брокеров -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for broker in brokers %}
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100 overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-start space-x-4">
                            <!-- Аватар -->
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-100 to-teal-50 flex items-center justify-center border-2 border-white shadow-md overflow-hidden">
                                    {% if broker.user.avatar %}
                                        <img src="{{ broker.user.avatar.url }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Информация -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 truncate">{{ broker.user.get_full_name }}</h3>

                                        <!-- Рейтинг -->
                                        <div class="flex items-center mt-1">
                                            <div class="flex items-center">
                                                {% with rating=broker.rating|default:0 %}
                                                {% for i in "12345"|make_list %}
                                                    {% if forloop.counter <= rating %}
                                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                        </svg>
                                                    {% else %}
                                                        <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                        </svg>
                                                    {% endif %}
                                                {% endfor %}
                                                {% endwith %}
                                            </div>
                                            <span class="ml-1 text-sm text-gray-600">{{ broker.rating|default:"0.0" }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Специализация -->
                                {% if broker.specializations %}
                                <p class="text-purple-600 text-sm font-medium mt-2">
                                    {% for spec in broker.get_specializations_display %}
                                        {% if forloop.first %}{{ spec }}{% endif %}
                                    {% endfor %}
                                    {% if broker.specializations|length > 1 %} +{{ broker.specializations|length|add:"-1" }}{% endif %}
                                </p>
                                {% endif %}

                                <!-- Опыт -->
                                <div class="flex items-center mt-2 text-gray-600 text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Опыт: {{ broker.experience }} лет
                                </div>

                                <!-- Услуги -->
                                <div class="mt-3 flex flex-wrap gap-1">
                                    {% for service in broker.get_services_display|slice:":3" %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        {{ service }}
                                    </span>
                                    {% endfor %}
                                    {% if broker.services|length > 3 %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        +{{ broker.services|length|add:"-3" }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Футер карточки -->
                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-900">
                            {% if broker.hourly_rate %}
                                от {{ broker.hourly_rate }} ₽/час
                            {% else %}
                                Цена по запросу
                            {% endif %}
                        </span>
                        <a href="{% url 'broker-detail' broker.pk %}"
                           class="px-4 py-2 bg-gradient-to-r from-purple-600 to-teal-500 text-white text-sm font-medium rounded-lg hover:from-purple-700 hover:to-teal-600 transition-colors">
                            Подробнее
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-2 text-center py-12">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Брокеры не найдены</h3>
                    <p class="text-gray-600">Попробуйте изменить параметры фильтрации</p>
                </div>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            {% if is_paginated %}
            <div class="mt-8 flex justify-center">
                <nav class="flex items-center space-x-2">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                       class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
                        Назад
                    </a>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <span class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-teal-500 text-white font-medium">
                            {{ num }}
                        </span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                       class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
                        Вперед
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Мобильное меню фильтров - реализация 1 в 1 как в base.html
    document.addEventListener('DOMContentLoaded', function() {
        // Элементы мобильного меню фильтров
        const mobileFiltersBtn = document.getElementById('mobile-filters-btn');
        const mobileFiltersDropdown = document.getElementById('mobile-filters-dropdown');
        const mobileFiltersClose = document.getElementById('mobile-filters-close');
        const mobileFiltersOverlay = document.getElementById('mobile-filters-overlay');

        // Функции для открытия/закрытия меню фильтров
        function openFilters() {
            mobileFiltersDropdown.classList.add('active');
            mobileFiltersOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFilters() {
            mobileFiltersDropdown.classList.remove('active');
            mobileFiltersOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Обработчики событий для мобильного меню фильтров
        if (mobileFiltersBtn) mobileFiltersBtn.addEventListener('click', openFilters);
        if (mobileFiltersClose) mobileFiltersClose.addEventListener('click', closeFilters);
        if (mobileFiltersOverlay) mobileFiltersOverlay.addEventListener('click', closeFilters);

        // Обработчики для аккордеона фильтров - как в base.html
        document.querySelectorAll('.mobile-filter-section > div:first-child').forEach(header => {
            header.addEventListener('click', function() {
                const categoryItem = this.parentElement;
                const content = categoryItem.querySelector('.mobile-filter-content');
                const icon = this.querySelector('.fa-chevron-down');

                // Закрываем все остальные открытые категории
                document.querySelectorAll('.mobile-filter-section').forEach(item => {
                    if (item !== categoryItem) {
                        item.classList.remove('active');
                        item.querySelector('.mobile-filter-content').style.display = 'none';
                        item.querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';
                    }
                });

                // Переключаем текущую категорию
                categoryItem.classList.toggle('active');
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(90deg)';
                }
            });
        });

        // Обновление значения рейтинга для мобильной версии
        const ratingSliderMobile = document.getElementById('ratingSliderMobile');
        const ratingValueMobile = document.getElementById('ratingValueMobile');

        if (ratingSliderMobile && ratingValueMobile) {
            ratingSliderMobile.addEventListener('input', function() {
                ratingValueMobile.textContent = this.value;
            });
        }

        // Обновление значения рейтинга для десктопной версии
        const ratingSlider = document.getElementById('ratingSlider');
        const ratingValue = document.getElementById('ratingValue');

        if (ratingSlider && ratingValue) {
            ratingSlider.addEventListener('input', function() {
                ratingValue.textContent = this.value;
            });
        }

        // Плавная анимация применения фильтров
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    const originalText = submitButton.innerHTML;
                    submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Применяем...';
                    submitButton.disabled = true;

                    // Закрываем мобильное меню после отправки формы
                    if (window.innerWidth < 1024) {
                        setTimeout(closeFilters, 500);
                    }

                    // Восстанавливаем кнопку через 2 секунды на случай ошибки
                    setTimeout(() => {
                        submitButton.innerHTML = originalText;
                        submitButton.disabled = false;
                    }, 2000);
                }
            });
        });

        // Автоматическое открытие соответствующих секций при наличии активных фильтров
        function openActiveFilterSections() {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('search')) {
                openSection('Поиск по имени');
            }
            if (urlParams.has('rating') && urlParams.get('rating') !== '0') {
                openSection('Рейтинг');
            }
            if (urlParams.has('experience')) {
                openSection('Опыт работы');
            }
            if (urlParams.has('services')) {
                openSection('Услуги');
            }
            if (urlParams.has('specialization')) {
                openSection('Специализация');
            }
        }

        function openSection(sectionName) {
            document.querySelectorAll('.mobile-filter-section').forEach(section => {
                const header = section.querySelector('.font-medium');
                if (header && header.textContent.trim() === sectionName) {
                    const content = section.querySelector('.mobile-filter-content');
                    const icon = section.querySelector('.fa-chevron-down');

                    section.classList.add('active');
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(90deg)';
                }
            });
        }

        // Открываем активные секции при загрузке страницы
        openActiveFilterSections();
    });

    // Функция для показа уведомлений (как в base.html)
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}