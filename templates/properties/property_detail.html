{% extends 'base.html' %}
{% load property_filters %}
{% block title %}{{ property.title }} | RealEstatePro{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css">
<style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–π */
    .animate-block {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .animate-block.reveal {
        opacity: 1;
        transform: translateY(0);
    }

    /* –°—Ç–∏–ª–∏ –∫–∞—Ä—É—Å–µ–ª–∏ */
    .swiper {
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
        border-radius: 1rem;
        overflow: hidden;
        background-color: #f5f5f5;
    }

    @media (min-width: 768px) {
        .swiper {
            height: 500px;
        }
    }

    .swiper-slide {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: zoom-in;
        height: 100%;
        width: 100%;
        background-color: white;
        overflow: hidden;
    }

    .swiper-slide img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        background-color: white;
        margin: 0 auto;
        display: block;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: none;
        backdrop-filter: none;
        width: auto;
        height: auto;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 24px;
        font-weight: 700;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    @media (min-width: 768px) {
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 32px;
        }
    }

    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    @media (min-width: 768px) {
        .close-modal {
            top: 25px;
            right: 35px;
            font-size: 40px;
        }
    }

    @keyframes zoomIn {
        from {transform: scale(0.9); opacity: 0;}
        to {transform: scale(1); opacity: 1;}
    }

    .modal-opened { animation: zoomIn 0.3s ease-out; }

    .scrollable-description {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .scrollable-description::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar {
            width: 6px;
        }
    }

    .contact-sidebar {
        height: fit-content;
        max-height: 500px;
        position: sticky;
        top: 20px;
        padding: 1rem;
    }

    @media (max-width: 767px) {
        .contact-sidebar {
            margin-top: 2rem;
            position: static;
        }
    }

    .btn-primary {
        border-radius: 9999px;
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: #ffffff;
        border: 2px solid transparent;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
        box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
    }

    .btn-outline {
        border-radius: 9999px;
        border: 2px solid #0a0202;
        color: #34495e;
        justify-content: center;
        text-align: center;
        width: 100%;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    @media (min-width: 768px) {
        .btn-primary,
        .btn-outline {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }
    }

    .params-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 380px) {
        .params-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 640px) {
        .params-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .params-grid > div {
        padding: 1rem;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .scrollable-description::-webkit-scrollbar,
    .scrollable-section::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar,
        .scrollable-section::-webkit-scrollbar {
            width: 6px;
        }
    }

    .scrollable-description::-webkit-scrollbar-button,
    .scrollable-section::-webkit-scrollbar-button {
        display: none;
    }

    .scrollable-description::-webkit-scrollbar-track,
    .scrollable-section::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
        margin: 2px 0;
    }

    .scrollable-description::-webkit-scrollbar-thumb,
    .scrollable-section::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .scrollable-description::-webkit-scrollbar-thumb:hover,
    .scrollable-section::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .scrollable-description,
    .scrollable-section {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
    #map-container {
        width: 100%;
        height: 400px;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }

    #map, #map-view {
        width: 100%;
        height: 100%;
    }

    .address-display {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ */
    .edit-address-container {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .search-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 300px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-results {
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 5px;
        display: none;
    }

    .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .search-result-item:hover {
        background-color: #f5f5f5;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 640px) {
        #map-container, #map-view-container {
            height: 300px;
        }
        .search-container {
            width: 200px;
        }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .messages-overlay {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }

    .message-alert {
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .message-alert:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    .message-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .message-error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .message-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .message-info {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
    }

    .message-icon {
        font-size: 1.2em;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
        line-height: 1.4;
    }

    .message-close {
        background: none;
        border: none;
        color: white;
        opacity: 0.7;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: opacity 0.2s;
        flex-shrink: 0;
    }

    .message-close:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .messages-overlay {
            bottom: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
        }

        .message-alert {
            min-width: auto;
            max-width: none;
            padding: 14px 16px;
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spin {
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    #map-fallback {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
    text-align: center;
    }

    #map-fallback p {
        margin-bottom: 0.5rem;
    }

    #map-fallback button {
        margin-top: 0.5rem;
    }

    /* –¶–≤–µ—Ç —Ü–µ–Ω—ã */
    .text-blue-600 {
        color: #7b61ff !important;
    }

    /* –ö–Ω–æ–ø–∫–∏ –∫–∞—Ä—Ç—ã */
    .map-controls button {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .map-controls button:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
    }

    /* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ */
    #save-address-btn {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #save-address-btn:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
        box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
    }
</style>

<div class="registration-container">
    <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border-2 border-gray-100">
        <!-- –ö–∞—Ä—É—Å–µ–ª—å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
        <div class="animate-block swiper mb-6 md:mb-8">
            <div class="swiper-wrapper">
                <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <div class="swiper-slide">
                    <img src="{{ property.main_image.url }}"
                         alt="{{ property.title }}"
                         loading="lazy">
                </div>
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                {% for image in property.images.all %}
                    {% if not image.is_main %}
                    <div class="swiper-slide">
                        <img src="{{ image.image.url }}"
                             alt="–§–æ—Ç–æ –æ–±—ä–µ–∫—Ç–∞ {{ forloop.counter }}"
                             loading="lazy">
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div id="imageModal" class="image-modal">
            <span class="close-modal">&times;</span>
            <img class="modal-content" id="expandedImg">
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="lg:col-span-2">

                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ü–µ–Ω–∞ -->
                <div class="animate-block">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">{{ property.title }}</h1>
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-4 mb-4 md:mb-6">
                        <span class="text-2xl font-bold text-blue-600">
                            {% if property.is_rental == 'monthly' %}
                                {{ property.monthly_price|space_format }} ‚ÇΩ/–º–µ—Å—è—Ü
                            {% elif property.is_rental == 'daily' %}
                                {{ property.daily_price|space_format }} ‚ÇΩ/—Å—É—Ç–∫–∏
                            {% else %}
                                {{ property.price|space_format }} ‚ÇΩ
                            {% endif %}
                        </span>
                        {% if property.is_featured %}
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 md:px-3 md:py-1 rounded-full text-sm">
                            ‚òÖ Premium
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-4 mb-4 md:mb-8 params-grid">
                    <!-- –ì–æ—Ä–æ–¥ -->
                    {% if property.location %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–ì–æ—Ä–æ–¥</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.location }}</div>
                    </div>
                    {% endif %}

                    <!-- –ê–¥—Ä–µ—Å -->
                    {% if property.address %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–ê–¥—Ä–µ—Å</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.address }}</div>
                    </div>
                    {% endif %}

                    <!-- –ö–æ–º–Ω–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–ö–æ–º–Ω–∞—Ç</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.rooms }}</div>
                    </div>
                    {% endif %}
{% if property.distance_to_center %}
<div class="bg-gray-50 p-4 rounded-lg">
    <div class="text-xs md:text-sm text-gray-500">–î–æ —Ü–µ–Ω—Ç—Ä–∞</div>
    <div class="text-lg md:text-xl font-bold">{{ property.distance_to_center|floatformat:2 }} –∫–º</div>
</div>
{% endif %}

                    <!-- –≠—Ç–∞–∂ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                        {% if property.floor and property.total_floors %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">–≠—Ç–∞–∂</div>
                            <div class="text-lg md:text-xl font-bold">
                                {{ property.floor }}/{{ property.total_floors }}
                            </div>
                        </div>
                        {% elif property.floor %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">–≠—Ç–∞–∂</div>
                            <div class="text-lg md:text-xl font-bold">{{ property.floor }}</div>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.total_area }} –º¬≤</div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.living_area }} –º¬≤</div>
                    </div>

                    <!-- –ì–æ–¥ —Å–¥–∞—á–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫) -->
                    {% if property.property_type.name == 'new_flat' and property.delivery_year %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–ì–æ–¥ —Å–¥–∞—á–∏</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.delivery_year }}</div>
                    </div>
                    {% endif %}

                    <!-- –ú–µ—Ç—Ä–æ -->
                    {% if property.metro_station and property.metro_station != "–ù–µ —É–∫–∞–∑–∞–Ω–æ" %}
<div class="bg-gray-50 p-4 rounded-lg">
    <div class="text-xs md:text-sm text-gray-500">–ú–µ—Ç—Ä–æ</div>
    <div class="text-lg md:text-xl font-bold">
        {{ property.metro_station|strip_metro }}
    </div>
</div>
{% endif %}

                    <!-- –û—Ç–¥–µ–ª–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–û—Ç–¥–µ–ª–∫–∞</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.has_finishing|yesno:"–° –æ—Ç–¥–µ–ª–∫–æ–π,–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏" }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- –°—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏ -->
                    {% if property.property_type.name == 'new_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">–°—Ç–∞—Ç—É—Å</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.is_delivered|yesno:"–°–¥–∞–Ω,–ù–µ —Å–¥–∞–Ω" }}
                        </div>
                    </div>
                    {% endif %}
                </div>

            <!-- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ -->
<!-- –í —Å–µ–∫—Ü–∏–∏ –∫–∞—Ä—Ç—ã (–∑–∞–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫) -->
<!-- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ -->
<div class="animate-block mb-6 md:mb-8">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ</h2>

    {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±—Ä–æ–∫–µ—Ä–æ–≤, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤) -->
    <div class="edit-address-container mb-6">
        <h3 class="text-xl font-semibold mb-4">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">–ì–æ—Ä–æ–¥</label>
            <input type="text" id="city-input" class="w-full px-3 py-2 border rounded-lg"
                   value="{{ property.location|default:'' }}" placeholder="–ì–æ—Ä–æ–¥ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button type="button" id="locate-me" class="px-2 py-1 rounded text-sm">
                    <i class="bi bi-geo-alt"></i> –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                </button>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤..." id="search-objects">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
        <div class="address-display" id="address-display">
            {{ property.address|default:"–ê–¥—Ä–µ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω" }}
        </div>

        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">–ú–µ—Ç—Ä–æ</label>
            <input type="text" id="metro-input" class="w-full px-3 py-2 border rounded-lg"
                   placeholder="–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
                   value="{{ property.metro_station|default:'' }}">
        </div>

        <div class="mt-4 flex justify-end">
            <button id="save-address-btn" class="px-4 py-2 rounded-lg">
                –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç
            </button>
        </div>
    </div>
    {% endif %}

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
{% if not request.user == property.broker.user and not request.user == property.developer and not request.user.is_admin %}
<div id="map-view-container" style="width: 100%; height: 400px; margin-bottom: 1rem; border-radius: 0.5rem; overflow: hidden;">
    <div id="map-view"></div>
    <div id="map-fallback" style="display: none; padding: 20px; text-align: center;">
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É.</p>
        <button onclick="retryMapLoading()" class="btn-primary mt-2">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
        <p class="text-sm text-gray-500 mt-2">–ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
    </div>
    {% if property.address %}
        <div class="address-display mt-4">
            <strong>–ê–¥—Ä–µ—Å:</strong> {{ property.address }}
            {% if property.metro_station and property.metro_station != "–ù–µ —É–∫–∞–∑–∞–Ω–æ" %}
                <br><strong>–ú–µ—Ç—Ä–æ:</strong> {{ property.metro_station|strip_metro }}
            {% endif %}
        </div>
    {% endif %}
</div>
{% endif %}
</div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ -->
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
                <div class="scrollable-description prose max-w-none text-sm md:text-base">
                    {{ property.description|linebreaks }}
                </div>

                <!-- –ö–∞—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–∞ -->

            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="animate-block contact-sidebar bg-gray-50 p-4 md:p-6 rounded-xl mt-6 md:mt-0">
                <div class="contact-content">
                    <div class="mb-4 md:mb-6">
                        <h3 class="text-lg md:text-xl font-bold">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    </div>

                    <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
                        {% if property.broker.user.avatar %}
                            <img src="{{ property.broker.user.avatar.url }}"
                                 class="w-12 h-12 md:w-16 md:h-16 rounded-full object-cover">
                        {% else %}
                            <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-purple-100 to-cyan-100 flex items-center justify-center">
                                <i class="bi bi-person text-xl md:text-2xl" style="color: #7b61ff;"></i>
                            </div>
                        {% endif %}
                        <div>
                            <div class="font-medium text-base md:text-lg">
                                {{ property.broker.user.get_full_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}
                            </div>
                            <div class="text-xs md:text-sm text-gray-500">
                                {% if property.broker.user.is_admin %}
                                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                {% else %}
                                    –ë—Ä–æ–∫–µ—Ä –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 md:mt-8 flex flex-col gap-4">
                        {% if user.is_authenticated and user.user_type == 'client' %}
                           <a href="{% url 'properties:contact_broker' broker_id=property.broker.id property_id=property.id %}"
   class="btn-primary transition-colors">
   <i class="bi bi-chat-left-text mr-2"></i> –ù–∞–ø–∏—Å–∞—Ç—å –±—Ä–æ–∫–µ—Ä—É
</a>
                        {% elif not user.is_authenticated %}
                            <a href="{% url 'login' %}?next={{ request.path }}"
                               class="btn-primary transition-colors">
                               <i class="bi bi-chat-left-text mr-2"></i> –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å
                            </a>
                        {% else %}
                            <button class="btn-primary opacity-50 cursor-not-allowed" disabled>
                                <i class="bi bi-chat-left-text mr-2"></i> –ó–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
                            </button>
                        {% endif %}

                        {% if not is_broker %}
                            <form method="POST" action="{% url 'properties:property-favorite' property.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" class="btn-outline hover:border-blue-600 hover:text-blue-600 w-full text-center">
                                    <i class="bi bi-heart{% if is_favorite %}-fill text-red-500{% endif %} mr-2"></i>
                                    <span>
                                        {% if is_favorite %}
                                            –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                                        {% else %}
                                            –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                                        {% endif %}
                                    </span>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É -->
<div class="messages-overlay" id="global-messages-overlay">
    {% for message in messages %}
        <div class="message-alert message-{{ message.tags|default:'info' }}">
            <div class="message-icon">
                {% if message.tags == 'success' %}
                    <i class="bi bi-check-circle-fill"></i>
                {% elif message.tags == 'error' %}
                    <i class="bi bi-exclamation-circle-fill"></i>
                {% elif message.tags == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill"></i>
                {% else %}
                    <i class="bi bi-info-circle-fill"></i>
                {% endif %}
            </div>
            <div class="message-content">
                {{ message }}
            </div>
            <button class="message-close" onclick="this.parentElement.remove()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    {% endfor %}
</div>

<script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
<script>
// ==============================
// –°–ò–°–¢–ï–ú–ê –ö–†–ê–°–ò–í–´–• –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
// ==============================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showGlobalMessage(message, type = 'info') {
    const container = document.getElementById('global-messages-overlay');
    if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    const messageElement = document.createElement('div');
    messageElement.className = `message-alert message-${type}`;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É —Å–æ–æ–±—â–µ–Ω–∏—è
    let iconClass = 'bi bi-info-circle-fill';
    if (type === 'success') iconClass = 'bi bi-check-circle-fill';
    else if (type === 'error') iconClass = 'bi bi-exclamation-circle-fill';
    else if (type === 'warning') iconClass = 'bi bi-exclamation-triangle-fill';

    messageElement.innerHTML = `
        <div class="message-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="message-content">
            ${message}
        </div>
        <button class="message-close">
            <i class="bi bi-x-lg"></i>
        </button>
    `;

    container.appendChild(messageElement);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        messageElement.style.animation = 'slideInRight 0.3s ease-out';
    }, 10);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
    const closeBtn = messageElement.querySelector('.message-close');
    closeBtn.addEventListener('click', function() {
        closeMessage(messageElement);
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (messageElement.parentNode) {
            closeMessage(messageElement);
        }
    }, 5000);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    messageElement.addEventListener('click', function(e) {
        if (!e.target.classList.contains('message-close') && !e.target.closest('.message-close')) {
            closeMessage(messageElement);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
function closeMessage(messageElement) {
    messageElement.style.animation = 'slideOutRight 0.3s ease-in forwards';
    setTimeout(() => {
        if (messageElement.parentNode) {
            messageElement.remove();
        }
    }, 300);
}

// ==============================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–û–†–ú
// ==============================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ —Å –∫—Ä–∞—Å–∏–≤—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
function setupFavorites() {
    document.querySelectorAll('form[action*="favorite"]').forEach(form => {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ submit
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        newForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const icon = newForm.querySelector('i');
            const text = newForm.querySelector('span');
            const button = newForm.querySelector('button');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
            button.disabled = true;

            try {
                const response = await fetch(newForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': newForm.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('Favorite response:', data);

                if (data.status === 'added') {
                    icon.classList.add('bi-heart-fill', 'text-red-500');
                    icon.classList.remove('bi-heart');
                    text.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ';
                    showGlobalMessage('–û–±—ä–µ–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è', 'success');
                } else if (data.status === 'removed') {
                    icon.classList.remove('bi-heart-fill', 'text-red-500');
                    icon.classList.add('bi-heart');
                    text.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                    showGlobalMessage('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'info');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showGlobalMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        });
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
function setupAddressSaving() {
    const saveBtn = document.getElementById('save-address-btn');
    if (!saveBtn) return;

    saveBtn.addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            let coords = [55.751574, 37.617635]; // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (editPlacemark) {
                const yandexCoords = editPlacemark.geometry.getCoordinates();
                console.log('Saving Yandex coordinates:', yandexCoords);
                coords = [yandexCoords[1], yandexCoords[0]];
                console.log('Converted to PostGIS format:', coords);
            }

            const response = await fetch('{% url "properties:update_property_address" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    property_id: {{ property.id }},
                    city: document.getElementById('city-input').value,
                    address: document.getElementById('address-display').textContent,
                    metro_station: document.getElementById('metro-input').value,
                    coordinates: coords.join(','),
                    _method: 'PATCH'
                })
            });

            const data = await response.json();
            console.log('Server response:', data);

            if (data.status === 'success') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (typeof viewMap !== 'undefined') {
                    const newCoords = [data.coordinates.y, data.coordinates.x];
                    console.log('Updating view map with:', newCoords);
                    viewMap.setCenter(newCoords, 15);

                    if (viewPlacemark) {
                        viewMap.geoObjects.remove(viewPlacemark);
                    }

                    viewPlacemark = new ymaps.Placemark(newCoords, {}, {
                        preset: 'islands#redDotIcon',
                        draggable: false
                    });
                    viewMap.geoObjects.add(viewPlacemark);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
                const addressParamElement = document.querySelector('.params-grid div:nth-child(2) .text-lg');
                if (addressParamElement) {
                    addressParamElement.textContent = data.address;
                }

                showGlobalMessage('‚úÖ –ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ', 'success');
            } else {
                throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showGlobalMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
}

// ==============================
// –ü–†–û–í–ï–†–ö–ê URL –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
// ==============================

function checkUrlForNotifications() {
    const urlParams = new URLSearchParams(window.location.search);

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞
    if (urlParams.get('creation_success') === '1') {
        showGlobalMessage(
            'üéâ –û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.',
            'success'
        );

        // –û—á–∏—â–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
    if (urlParams.get('contact_paid') === '1') {
        showGlobalMessage(
            '‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —Å –±—Ä–æ–∫–µ—Ä–æ–º –æ–ø–ª–∞—á–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.',
            'success'
        );
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }
}

// ==============================
// –ö–ê–†–¢–´ –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø
// ==============================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ Django-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
const coordinates_json = '{{ coordinates_json|escapejs }}' || null;
const metro_coordinates_json = '{{ metro_coordinates_json|escapejs }}' || null;
const property_address = '{{ property.address|escapejs }}' || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
const metro_station = '{{ property.metro_station|escapejs }}' || '–ú–µ—Ç—Ä–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';

let viewMap, viewPlacemark;
let editMap, editPlacemark;
let searchResults = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function initViewMap() {
    console.log('[MAP] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');

    try {
        let coords = [55.751574, 37.617635]; // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        if (coordinates_json) {
            const coordsData = JSON.parse(coordinates_json);
            coords = [coordsData.y, coordsData.x];
            console.log('[MAP] –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', coords);
        }

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        viewMap = new ymaps.Map('map-view', {
            center: coords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É
        viewPlacemark = new ymaps.Placemark(coords, {
            hintContent: property_address,
            balloonContent: property_address
        }, {
            preset: 'islands#redDotIcon',
            draggable: false
        });

        viewMap.geoObjects.add(viewPlacemark);
        console.log('[MAP] –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–æ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (metro_coordinates_json) {
            try {
                const metroCoordsData = JSON.parse(metro_coordinates_json);
                const metroCoords = [metroCoordsData.y, metroCoordsData.x];
                const metroPlacemark = new ymaps.Placemark(metroCoords, {
                    hintContent: metro_station,
                    balloonContent: `–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ: ${metro_station}`
                }, {
                    preset: 'islands#blueCircleDotIcon',
                    iconColor: '#1e88e5'
                });
                viewMap.geoObjects.add(metroPlacemark);

                // –õ–∏–Ω–∏—è –æ—Ç –æ–±—ä–µ–∫—Ç–∞ –¥–æ –º–µ—Ç—Ä–æ
                const polyline = new ymaps.Polyline(
                    [coords, metroCoords],
                    {},
                    {
                        strokeColor: "#1e88e5",
                        strokeWidth: 3,
                        strokeOpacity: 0.5
                    }
                );
                viewMap.geoObjects.add(polyline);
            } catch (e) {
                console.error('[MAP] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–æ:', e);
            }
        }

    } catch (error) {
        console.error('[MAP] –û—à–∏–±–∫–∞:', error);
        document.getElementById('map-fallback').style.display = 'block';
        showGlobalMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É', 'error');
        throw error;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function initEditMap() {
    console.log('[DEBUG] –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');

    let initialCoords = [55.751574, 37.617635]; // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    {% if coordinates_json %}
        try {
            const coordsData = JSON.parse('{{ coordinates_json|escapejs }}');
            initialCoords = [coordsData.y, coordsData.x];
            console.log('[DEBUG] Edit map initial coordinates:', initialCoords);
        } catch (e) {
            console.error('[DEBUG] Error parsing coordinates:', e);
        }
    {% endif %}

    ymaps.ready(function() {
        console.log('[DEBUG] YMaps ready, creating edit map...');
        editMap = new ymaps.Map('map', {
            center: initialCoords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        editPlacemark = new ymaps.Placemark(initialCoords, {}, {
            preset: 'islands#redDotIcon',
            draggable: true
        });
        editMap.geoObjects.add(editPlacemark);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        editMap.events.add('click', function(e) {
            const coords = e.get('coords');
            console.log('[DEBUG] Map click coordinates:', coords);
            updatePlacemark(coords);
            getAddress(coords);
            findNearestMetro(coords);
            showGlobalMessage('üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤—ã–±—Ä–∞–Ω–æ', 'info');
        });

        // –ö–Ω–æ–ø–∫–∞ "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
        document.getElementById('locate-me').addEventListener('click', function() {
            if (navigator.geolocation) {
                showGlobalMessage('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...', 'info');
                navigator.geolocation.getCurrentPosition(function(position) {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    console.log('[DEBUG] Geolocation coordinates:', coords);
                    editMap.setCenter(coords, 15);
                    updatePlacemark(coords);
                    getAddress(coords);
                    findNearestMetro(coords);
                    showGlobalMessage('‚úÖ –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');
                }, function(error) {
                    showGlobalMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
                });
            } else {
                showGlobalMessage('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', 'error');
            }
        });

        // –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤
        const searchInput = document.getElementById('search-objects');
        const searchResultsContainer = document.getElementById('search-results');

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 3) {
                searchResultsContainer.style.display = 'none';
                return;
            }

            searchObjects(query);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
        searchResultsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('search-result-item')) {
                const index = e.target.dataset.index;
                const result = searchResults[index];

                const coords = result.geometry.coordinates;
                editMap.setCenter(coords, 15);
                updatePlacemark(coords);
                getAddress(coords);
                findNearestMetro(coords);

                searchInput.value = result.properties.name;
                searchResultsContainer.style.display = 'none';
                showGlobalMessage('üìç –û–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ', 'success');
            }
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    function updatePlacemark(coords) {
        if (editPlacemark) {
            editMap.geoObjects.remove(editPlacemark);
        }

        editPlacemark = new ymaps.Placemark(coords, {}, {
            preset: 'islands#redDotIcon',
            draggable: true
        });

        editMap.geoObjects.add(editPlacemark);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
        editPlacemark.events.add('dragend', function() {
            const newCoords = editPlacemark.geometry.getCoordinates();
            getAddress(newCoords);
            findNearestMetro(newCoords);
            showGlobalMessage('üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'info');
        });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
    function getAddress(coords) {
        ymaps.geocode(coords).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            if (firstGeoObject) {
                const address = firstGeoObject.getAddressLine();
                document.getElementById('address-display').textContent = address;

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –≥–æ—Ä–æ–¥ –∏–∑ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö
                const city = firstGeoObject.getLocalities()[0];
                if (city) {
                    document.getElementById('city-input').value = city;
                }
            }
        });
    }

    // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ –º–µ—Ç—Ä–æ
    function findNearestMetro(coords) {
        ymaps.geocode(coords, { kind: 'metro' }).then(function(res) {
            const metro = res.geoObjects.get(0);
            if (metro) {
                document.getElementById('metro-input').value =
                    metro.properties.get('name');
            }
        });
    }

    // –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ API –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç
    function searchObjects(query) {
        ymaps.geocode(query).then(function(res) {
            searchResults = res.geoObjects.toArray().map(item => ({
                properties: {
                    name: item.properties.get('name') || item.properties.get('text'),
                    description: item.properties.get('description')
                },
                geometry: {
                    coordinates: item.geometry.getCoordinates()
                }
            }));
            displaySearchResults(searchResults);
    });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function displaySearchResults(results) {
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="search-result-item">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            container.style.display = 'block';
            return;
        }

        results.forEach((result, index) => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.dataset.index = index;

            const name = result.properties.name || '–û–±—ä–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const description = result.properties.description ?
                `<small class="text-gray-500">${result.properties.description}</small>` : '';

            item.innerHTML = `<strong>${name}</strong><br>${description}`;
            container.appendChild(item);
        });

        container.style.display = 'block';
    }

    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            document.getElementById('search-results').style.display = 'none';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã
function retryMapLoading() {
    console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã...');
    showGlobalMessage('üîÑ –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É...', 'info');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// ==============================
// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ==============================

// –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('reveal');
        }
    });
}, { threshold: 0.1 });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≤–∞–π–ø–µ—Ä–∞
function initSwiper() {
    const swiper = new Swiper('.swiper', {
        loop: true,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        keyboard: { enabled: true },
        effect: 'slide',
        speed: 500,
        preloadImages: false,
        lazy: {
            loadPrevNext: true,
        },
    });

    return swiper;
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function setupModal() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('expandedImg');
    const closeBtn = document.querySelector('.close-modal');

    document.querySelectorAll('.swiper-slide img').forEach(img => {
        img.addEventListener('click', () => {
            modal.style.display = 'flex';
            modalImg.src = img.src;
            modalImg.classList.add('modal-opened');
        });
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        modalImg.classList.remove('modal-opened');
    });

    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            modalImg.classList.remove('modal-opened');
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
            modalImg.classList.remove('modal-opened');
        }
    });
}

// ==============================
// –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ==============================

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded: –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–π
    document.querySelectorAll('.animate-block').forEach(element => {
        observer.observe(element);
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ URL
    checkUrlForNotifications();

    try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø–µ—Ä–∞ –∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const swiper = initSwiper();
        setupModal();
        setupFavorites();
        setupAddressSaving();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç
        ymaps.ready(function() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–±—Ä–æ–∫–µ—Ä–æ–≤/–Ω–µ-–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤/–Ω–µ-–∞–¥–º–∏–Ω–æ–≤
                const isEditor = {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}true{% else %}false{% endif %};

                if (!isEditor) {
                    if (coordinates_json) {
                        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...');
                        initViewMap();
                    } else {
                        console.log('–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                        showGlobalMessage('üìç –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ –ø–æ–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω', 'warning');
                        document.getElementById('map-fallback').style.display = 'block';
                    }
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±—Ä–æ–∫–µ—Ä–æ–≤/–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤/–∞–¥–º–∏–Ω–æ–≤
                {% if request.user.is_authenticated %}
                    {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
                        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
                        initEditMap();

                    {% endif %}
                {% endif %}
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç:', e);
                showGlobalMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç—ã', 'error');
                document.getElementById('map-fallback').style.display = 'block';
            }
        });

    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–ª–æ–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
        showGlobalMessage('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error');
    }
});
</script>
{% endblock %}