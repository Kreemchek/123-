{% extends 'base.html' %}
{% load property_filters %}
{% block title %}{{ property.title }} | RealEstatePro{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css">
<style>
    /* Анимация для секций */
    .animate-block {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .animate-block.reveal {
        opacity: 1;
        transform: translateY(0);
    }

    /* Стили карусели */
    .swiper {
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
        border-radius: 1rem;
        overflow: hidden;
        background-color: #f5f5f5;
    }

    @media (min-width: 768px) {
        .swiper {
            height: 500px;
        }
    }

    .swiper-slide {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: zoom-in;
        height: 100%;
        width: 100%;
        background-color: white;
        overflow: hidden;
    }

    .swiper-slide img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        background-color: white;
        margin: 0 auto;
        display: block;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: none;
        backdrop-filter: none;
        width: auto;
        height: auto;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 24px;
        font-weight: 700;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    @media (min-width: 768px) {
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 32px;
        }
    }

    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    @media (min-width: 768px) {
        .close-modal {
            top: 25px;
            right: 35px;
            font-size: 40px;
        }
    }

    @keyframes zoomIn {
        from {transform: scale(0.9); opacity: 0;}
        to {transform: scale(1); opacity: 1;}
    }

    .modal-opened { animation: zoomIn 0.3s ease-out; }

    .scrollable-description {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .scrollable-description::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar {
            width: 6px;
        }
    }

    .contact-sidebar {
        height: fit-content;
        max-height: 500px;
        position: sticky;
        top: 20px;
        padding: 1rem;
    }

    @media (max-width: 767px) {
        .contact-sidebar {
            margin-top: 2rem;
            position: static;
        }
    }

    .btn-primary {
        border-radius: 9999px;
        background: #0060f4;
        color: #ffffff;
        border: 2px solid transparent;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-outline {
        border-radius: 9999px;
        border: 2px solid #0a0202;
        color: #34495e;
        justify-content: center;
        text-align: center;
        width: 100%;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    @media (min-width: 768px) {
        .btn-primary,
        .btn-outline {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }
    }

    .params-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 380px) {
        .params-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 640px) {
        .params-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .params-grid > div {
        padding: 1rem;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .scrollable-description::-webkit-scrollbar,
    .scrollable-section::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar,
        .scrollable-section::-webkit-scrollbar {
            width: 6px;
        }
    }

    .scrollable-description::-webkit-scrollbar-button,
    .scrollable-section::-webkit-scrollbar-button {
        display: none;
    }

    .scrollable-description::-webkit-scrollbar-track,
    .scrollable-section::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
        margin: 2px 0;
    }

    .scrollable-description::-webkit-scrollbar-thumb,
    .scrollable-section::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .scrollable-description::-webkit-scrollbar-thumb:hover,
    .scrollable-section::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .scrollable-description,
    .scrollable-section {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    /* Стили для карты */
    #map-container {
        width: 100%;
        height: 400px;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }

    #map, #map-view {
        width: 100%;
        height: 100%;
    }

    .address-display {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    /* Стили для редактирования адреса */
    .edit-address-container {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .search-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 300px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-results {
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 5px;
        display: none;
    }

    .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .search-result-item:hover {
        background-color: #f5f5f5;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 640px) {
        #map-container, #map-view-container {
            height: 300px;
        }
        .search-container {
            width: 200px;
        }
    }

    /* Стили для уведомлений */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast.success {
        background-color: #10b981;
    }

    .toast.error {
        background-color: #ef4444;
    }

    /* Анимация спиннера */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spin {
        animation: spin 1s linear infinite;
        display: inline-block;
    }
</style>

<div class="registration-container">
    <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border-2 border-gray-100">
        <!-- Карусель с анимацией -->
        <div class="animate-block swiper mb-6 md:mb-8">
            <div class="swiper-wrapper">
                <!-- Основное изображение -->
                <div class="swiper-slide">
                    <img src="{{ property.main_image.url }}"
                         alt="{{ property.title }}"
                         loading="lazy">
                </div>
                <!-- Дополнительные изображения -->
                {% for image in property.images.all %}
                    {% if not image.is_main %}
                    <div class="swiper-slide">
                        <img src="{{ image.image.url }}"
                             alt="Фото объекта {{ forloop.counter }}"
                             loading="lazy">
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>

        <!-- Модальное окно -->
        <div id="imageModal" class="image-modal">
            <span class="close-modal">&times;</span>
            <img class="modal-content" id="expandedImg">
        </div>

        <!-- Основная информация -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            <!-- Левая колонка -->
            <div class="lg:col-span-2">
                <!-- Заголовок и цена -->
                <div class="animate-block">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">{{ property.title }}</h1>
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-4 mb-4 md:mb-6">
                        <span class="text-2xl font-bold text-blue-600">
                            {% if property.is_rental == 'monthly' %}
                                {{ property.monthly_price|space_format }} ₽/месяц
                            {% elif property.is_rental == 'daily' %}
                                {{ property.daily_price|space_format }} ₽/сутки
                            {% else %}
                                {{ property.price|space_format }} ₽
                            {% endif %}
                        </span>
                        {% if property.is_featured %}
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 md:px-3 md:py-1 rounded-full text-sm">
                            ★ Premium
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Параметры -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-4 mb-4 md:mb-8 params-grid">
                    <!-- Город -->
                    {% if property.location %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Город</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.location }}</div>
                    </div>
                    {% endif %}

                    <!-- Адрес -->
                    {% if property.address %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Адрес</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.address }}</div>
                    </div>
                    {% endif %}

                    <!-- Комнаты (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Комнат</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.rooms }}</div>
                    </div>
                    {% endif %}

                    <!-- Этаж (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                        {% if property.floor and property.total_floors %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">Этаж</div>
                            <div class="text-lg md:text-xl font-bold">
                                {{ property.floor }}/{{ property.total_floors }}
                            </div>
                        </div>
                        {% elif property.floor %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">Этаж</div>
                            <div class="text-lg md:text-xl font-bold">{{ property.floor }}</div>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- Общая площадь -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Общая площадь</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.total_area }} м²</div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Жилая площадь</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.living_area }} м²</div>
                    </div>

                    <!-- Год сдачи (только для новостроек) -->
                    {% if property.property_type.name == 'new_flat' and property.delivery_year %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Год сдачи</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.delivery_year }}</div>
                    </div>
                    {% endif %}

                    <!-- Метро -->
                    {% if property.metro_station and property.metro_station != "Не указано" %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Метро</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.metro_station }}</div>
                    </div>
                    {% endif %}

                    <!-- Отделка (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Отделка</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.has_finishing|yesno:"С отделкой,Без отделки" }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Статус сдачи -->
                    {% if property.property_type.name == 'new_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Статус</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.is_delivered|yesno:"Сдан,Не сдан" }}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Описание объекта -->
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">Описание</h2>
                <div class="scrollable-description prose max-w-none text-sm md:text-base">
                    {{ property.description|linebreaks }}
                </div>

                <!-- Карта объекта -->
                <div class="animate-block mb-6 md:mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">Расположение на карте</h2>

                    <!-- Форма редактирования адреса -->
                    {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
                    <div class="edit-address-container mb-6">
                        <h3 class="text-xl font-semibold mb-4">Укажите адрес объекта</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Город</label>
                            <input type="text" id="city-input" class="w-full px-3 py-2 border rounded-lg"
                                   value="{{ property.location|default:'' }}" placeholder="Город будет определен автоматически">
                        </div>

                        <div id="map-container">
                            <div id="map"></div>
                            <div class="map-controls">
                                <button type="button" id="locate-me" class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                                    <i class="bi bi-geo-alt"></i> Мое местоположение
                                </button>
                            </div>
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Поиск объектов..." id="search-objects">
                                <div class="search-results" id="search-results"></div>
                            </div>
                        </div>
                        <div class="address-display" id="address-display">
                            {{ property.address|default:"Адрес не выбран" }}
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Метро</label>
                            <input type="text" id="metro-input" class="w-full px-3 py-2 border rounded-lg"
                                   placeholder="Станция метро будет определена автоматически"
                                   value="{{ property.metro_station|default:'' }}">
                        </div>

                        <div class="mt-4 flex justify-end">
                            <button id="save-address-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Сохранить изменения
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Отображение карты для всех пользователей -->
                    <div id="map-view-container">
                        <div id="map-view"></div>
                    </div>
                    <div class="address-display" id="address-view-display">
                        {{ property.address|default:"Адрес не указан" }}
                    </div>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="animate-block contact-sidebar bg-gray-50 p-4 md:p-6 rounded-xl mt-6 md:mt-0">
                <div class="contact-content">
                    <div class="mb-4 md:mb-6">
                        <h3 class="text-lg md:text-xl font-bold">Контактная информация</h3>
                    </div>

                    <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
                        {% if property.broker.user.avatar %}
                            <img src="{{ property.broker.user.avatar.url }}"
                                 class="w-12 h-12 md:w-16 md:h-16 rounded-full object-cover">
                        {% else %}
                            <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="bi bi-person text-xl md:text-2xl text-blue-600"></i>
                            </div>
                        {% endif %}
                        <div>
                            <div class="font-medium text-base md:text-lg">
                                {{ property.broker.user.get_full_name|default:"Не указано" }}
                            </div>
                            <div class="text-xs md:text-sm text-gray-500">
                                {% if property.broker.user.is_admin %}
                                    Администратор
                                {% else %}
                                    Брокер по недвижимости
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 md:mt-8 flex flex-col gap-4">
                        {% if user.is_authenticated and user.user_type == 'client' %}
                            <a href="{% url 'contact_broker' broker_id=property.broker.id property_id=property.id %}"
                               class="btn-primary hover:bg-blue-700 transition-colors">
                               <i class="bi bi-chat-left-text mr-2"></i> Написать (1 руб.)
                            </a>
                        {% elif not user.is_authenticated %}
                            <a href="{% url 'login' %}?next={{ request.path }}"
                               class="btn-primary hover:bg-blue-700 transition-colors">
                               <i class="bi bi-chat-left-text mr-2"></i> Войдите, чтобы написать
                            </a>
                        {% else %}
                            <button class="btn-primary opacity-50 cursor-not-allowed" disabled>
                                <i class="bi bi-chat-left-text mr-2"></i> Запросы только для клиентов
                            </button>
                        {% endif %}

                        {% if not is_broker %}
                            <form method="POST" action="{% url 'property-favorite' property.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" class="btn-outline hover:border-blue-600 hover:text-blue-600 w-full text-center">
                                    <i class="bi bi-heart{% if is_favorite %}-fill text-red-500{% endif %} mr-2"></i>
                                    <span>
                                        {% if is_favorite %}
                                            Удалить из избранного
                                        {% else %}
                                            Добавить в избранное
                                        {% endif %}
                                    </span>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
<script>
    // Анимация при скролле
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('reveal');
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.animate-block').forEach(element => {
        observer.observe(element);
    });

    // Функция для инициализации свайпера
    function initSwiper() {
        const swiper = new Swiper('.swiper', {
            loop: true,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            keyboard: { enabled: true },
            effect: 'slide',
            speed: 500,
            preloadImages: false,
            lazy: {
                loadPrevNext: true,
            },
        });

        return swiper;
    }

    // Модальное окно
    function setupModal() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('expandedImg');
        const closeBtn = document.querySelector('.close-modal');

        document.querySelectorAll('.swiper-slide img').forEach(img => {
            img.addEventListener('click', () => {
                modal.style.display = 'flex';
                modalImg.src = img.src;
                modalImg.classList.add('modal-opened');
            });
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            modalImg.classList.remove('modal-opened');
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                modalImg.classList.remove('modal-opened');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                modal.style.display = 'none';
                modalImg.classList.remove('modal-opened');
            }
        });
    }

    // Обработка избранного
    function setupFavorites() {
        document.querySelectorAll('form[action*="favorite"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const icon = form.querySelector('i');
                const text = form.querySelector('span');

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Accept': 'application/json',
                        },
                    });
                    const data = await response.json();

                    if (data.status === 'added') {
                        icon.classList.add('bi-heart-fill', 'text-red-500');
                        icon.classList.remove('bi-heart');
                        text.textContent = 'Удалить из избранного';
                    } else {
                        icon.classList.remove('bi-heart-fill', 'text-red-500');
                        icon.classList.add('bi-heart');
                        text.textContent = 'Добавить в избранное';
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                }
            });
        });
    }

    // Инициализация карты для просмотра
    let viewMap, viewPlacemark;

  function initViewMap() {
    let coords = [55.751574, 37.617635]; // Москва по умолчанию

    {% if coordinates_json %}
        try {
            const coordsData = JSON.parse('{{ coordinates_json|escapejs }}');
            coords = [coordsData.y, coordsData.x];
            console.log('InitViewMap - Coordinates:', coords);
        } catch (e) {
            console.error('Error parsing coordinates:', e);
        }
    {% endif %}

    ymaps.ready(function() {
        viewMap = new ymaps.Map('map-view', {
            center: coords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        viewPlacemark = new ymaps.Placemark(coords, {
            hintContent: '{{ property.address|escapejs }}'
        }, {
            preset: 'islands#redDotIcon',
            draggable: false
        });
        viewMap.geoObjects.add(viewPlacemark);

        {% if metro_coordinates_json %}
            try {
                const metroCoordsData = JSON.parse('{{ metro_coordinates_json|escapejs }}');
                const metroCoords = [metroCoordsData.y, metroCoordsData.x];
                const metroPlacemark = new ymaps.Placemark(metroCoords, {
                    hintContent: '{{ property.metro_station|escapejs }}'
                }, {
                    preset: 'islands#blueCircleDotIcon',
                    iconColor: '#1e88e5'
                });
                viewMap.geoObjects.add(metroPlacemark);

                const polyline = new ymaps.Polyline(
                    [coords, metroCoords],
                    {},
                    {
                        strokeColor: "#1e88e5",
                        strokeWidth: 3,
                        strokeOpacity: 0.5
                    }
                );
                viewMap.geoObjects.add(polyline);
            } catch (e) {
                console.error('Error parsing metro coordinates:', e);
            }
        {% endif %}
    });
}


    // Инициализация карты для редактирования
    let editMap, editPlacemark;
    let searchResults = [];

    function initEditMap() {
    let initialCoords = [55.751574, 37.617635]; // Москва по умолчанию

    {% if coordinates_json %}
        try {
            const coordsData = JSON.parse('{{ coordinates_json|escapejs }}');
            initialCoords = [coordsData.y, coordsData.x];
            console.log('InitEditMap - Initial coordinates:', initialCoords);
        } catch (e) {
            console.error('Error parsing coordinates:', e);
        }
    {% endif %}

    ymaps.ready(function() {
        editMap = new ymaps.Map('map', {
            center: initialCoords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        editPlacemark = new ymaps.Placemark(initialCoords, {}, {
            preset: 'islands#redDotIcon',
            draggable: true
        });
        editMap.geoObjects.add(editPlacemark);

            // Обработчик клика по карте
            editMap.events.add('click', function(e) {
                const coords = e.get('coords'); // Получаем [широта, долгота] от Яндекс
                console.log('Map click coordinates:', coords);
                updatePlacemark(coords);
                getAddress(coords);
                findNearestMetro(coords);
            });

            // Кнопка "Мое местоположение"
            document.getElementById('locate-me').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        // Получаем [широта, долгота] от браузера
                        const coords = [position.coords.latitude, position.coords.longitude];
                        console.log('Geolocation coordinates:', coords);
                        editMap.setCenter(coords, 15);
                        updatePlacemark(coords);
                        getAddress(coords);
                        findNearestMetro(coords);
                    }, function(error) {
                        showToast('Не удалось определить ваше местоположение: ' + error.message, 'error');
                    });
                } else {
                    showToast('Ваш браузер не поддерживает геолокацию', 'error');
                }
            });

            // Поиск объектов
            const searchInput = document.getElementById('search-objects');
            const searchResultsContainer = document.getElementById('search-results');

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value;
                if (query.length < 3) {
                    searchResultsContainer.style.display = 'none';
                    return;
                }

                searchObjects(query);
            });

            // Обработчик выбора результата поиска
            searchResultsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('search-result-item')) {
                    const index = e.target.dataset.index;
                    const result = searchResults[index];

                    const coords = result.geometry.coordinates;
                    editMap.setCenter(coords, 15);
                    updatePlacemark(coords);
                    getAddress(coords);
                    findNearestMetro(coords);

                    searchInput.value = result.properties.name;
                    searchResultsContainer.style.display = 'none';
                }
            });
        });

        // Обновление метки на карте
        function updatePlacemark(coords) {
            if (editPlacemark) {
                editMap.geoObjects.remove(editPlacemark);
            }

            editPlacemark = new ymaps.Placemark(coords, {}, {
                preset: 'islands#redDotIcon',
                draggable: true
            });

            editMap.geoObjects.add(editPlacemark);

            // Обработчик перемещения метки
            editPlacemark.events.add('dragend', function() {
                const newCoords = editPlacemark.geometry.getCoordinates();
                getAddress(newCoords);
                findNearestMetro(newCoords);
            });
        }

        // Получение адреса по координатам
        function getAddress(coords) {
            ymaps.geocode(coords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    const address = firstGeoObject.getAddressLine();
                    document.getElementById('address-display').textContent = address;

                    // Автоматически заполняем город из геоданных
                    const city = firstGeoObject.getLocalities()[0];
                    if (city) {
                        document.getElementById('city-input').value = city;
                    }
                }
            });
        }

        // Поиск ближайшего метро
        function findNearestMetro(coords) {
            ymaps.geocode(coords, { kind: 'metro' }).then(function(res) {
                const metro = res.geoObjects.get(0);
                if (metro) {
                    document.getElementById('metro-input').value =
                        metro.properties.get('name');
                }
            });
        }

        // Поиск объектов через API Яндекс Карт
        function searchObjects(query) {
            ymaps.geocode(query).then(function(res) {
                searchResults = res.geoObjects.toArray().map(item => ({
                    properties: {
                        name: item.properties.get('name') || item.properties.get('text'),
                        description: item.properties.get('description')
                    },
                    geometry: {
                        coordinates: item.geometry.getCoordinates()
                    }
                }));
                displaySearchResults(searchResults);
            });
        }

        // Отображение результатов поиска
        function displaySearchResults(results) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item">Ничего не найдено</div>';
                container.style.display = 'block';
                return;
            }

            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.dataset.index = index;

                const name = result.properties.name || 'Объект без названия';
                const description = result.properties.description ?
                    `<small class="text-gray-500">${result.properties.description}</small>` : '';

                item.innerHTML = `<strong>${name}</strong><br>${description}`;
                container.appendChild(item);
            });

            container.style.display = 'block';
        }

        // Скрываем результаты поиска при клике вне поля
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });
    }

    // Функция для показа уведомлений
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Показываем уведомление
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Удаляем через 3 секунды
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }

    // Обработчик сохранения адреса
    document.getElementById('save-address-btn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Сохранение...';

     try {
        let coords = [55.751574, 37.617635]; // Москва по умолчанию
        if (editPlacemark) {
            const yandexCoords = editPlacemark.geometry.getCoordinates();
            console.log('Saving Yandex coordinates:', yandexCoords);

            // Конвертируем в формат для PostGIS: [долгота, широта]
            coords = [yandexCoords[1], yandexCoords[0]];
            console.log('Converted to PostGIS format:', coords);
        }

        const response = await fetch('{% url "properties:update_property_address" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                property_id: {{ property.id }},
                city: document.getElementById('city-input').value,
                address: document.getElementById('address-display').textContent,
                metro_station: document.getElementById('metro-input').value,
                coordinates: coords.join(','),
                _method: 'PATCH'
            })
        });

        const data = await response.json();
        console.log('Server response:', data);

        if (data.status === 'success') {
            // Обновляем карту просмотра
            if (typeof viewMap !== 'undefined') {
                const newCoords = [data.coordinates.y, data.coordinates.x];
                console.log('Updating view map with:', newCoords);
                viewMap.setCenter(newCoords, 15);

                if (viewPlacemark) {
                    viewMap.geoObjects.remove(viewPlacemark);
                }

                viewPlacemark = new ymaps.Placemark(newCoords, {}, {
                    preset: 'islands#redDotIcon',
                    draggable: false
                });
                viewMap.geoObjects.add(viewPlacemark);
            }

            document.getElementById('address-view-display').textContent = data.address;
            showToast('Адрес успешно сохранен!', 'success');
        } else {
            throw new Error(data.message || 'Неизвестная ошибка');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showToast(`Ошибка: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
    // Основная инициализация
    document.addEventListener('DOMContentLoaded', function() {
        const swiper = initSwiper();
        setupModal();
        setupFavorites();
        ymaps.ready(initViewMap);

        // Инициализируем карту редактирования только для авторизованных пользователей с правами
        {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
            ymaps.ready(initEditMap);
        {% endif %}
    });
</script>
{% endblock %}