{% extends 'base.html' %}
{% load property_filters %}
{% block title %}{{ property.title }} | RealEstatePro{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css">
<style>
    /* Анимация для секций */
    .animate-block {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .animate-block.reveal {
        opacity: 1;
        transform: translateY(0);
    }

    /* Стили карусели */
    .swiper {
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
        border-radius: 1rem;
        overflow: hidden;
        background-color: #f5f5f5;
    }

    @media (min-width: 768px) {
        .swiper {
            height: 500px;
        }
    }

    .swiper-slide {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: zoom-in;
        height: 100%;
        width: 100%;
        background-color: white;
        overflow: hidden;
    }

    .swiper-slide img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        background-color: white;
        margin: 0 auto;
        display: block;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: none;
        backdrop-filter: none;
        width: auto;
        height: auto;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 24px;
        font-weight: 700;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    @media (min-width: 768px) {
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 32px;
        }
    }

    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    @media (min-width: 768px) {
        .close-modal {
            top: 25px;
            right: 35px;
            font-size: 40px;
        }
    }

    @keyframes zoomIn {
        from {transform: scale(0.9); opacity: 0;}
        to {transform: scale(1); opacity: 1;}
    }

    .modal-opened { animation: zoomIn 0.3s ease-out; }

    .scrollable-description {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .scrollable-description::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar {
            width: 6px;
        }
    }

    .contact-sidebar {
        height: fit-content;
        max-height: 500px;
        position: sticky;
        top: 20px;
        padding: 1rem;
    }

    @media (max-width: 767px) {
        .contact-sidebar {
            margin-top: 2rem;
            position: static;
        }
    }

    .btn-primary {
        border-radius: 9999px;
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: #ffffff;
        border: 2px solid transparent;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
        box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
    }

    .btn-outline {
        border-radius: 9999px;
        border: 2px solid #0a0202;
        color: #34495e;
        justify-content: center;
        text-align: center;
        width: 100%;
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    @media (min-width: 768px) {
        .btn-primary,
        .btn-outline {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }
    }

    .params-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 380px) {
        .params-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 640px) {
        .params-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .params-grid > div {
        padding: 1rem;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .scrollable-description::-webkit-scrollbar,
    .scrollable-section::-webkit-scrollbar {
        width: 4px;
    }

    @media (min-width: 768px) {
        .scrollable-description::-webkit-scrollbar,
        .scrollable-section::-webkit-scrollbar {
            width: 6px;
        }
    }

    .scrollable-description::-webkit-scrollbar-button,
    .scrollable-section::-webkit-scrollbar-button {
        display: none;
    }

    .scrollable-description::-webkit-scrollbar-track,
    .scrollable-section::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
        margin: 2px 0;
    }

    .scrollable-description::-webkit-scrollbar-thumb,
    .scrollable-section::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .scrollable-description::-webkit-scrollbar-thumb:hover,
    .scrollable-section::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .scrollable-description,
    .scrollable-section {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    /* Стили для карты */
    #map-container {
        width: 100%;
        height: 400px;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }

    #map, #map-view {
        width: 100%;
        height: 100%;
    }

    .address-display {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    /* Стили для редактирования адреса */
    .edit-address-container {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .search-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 300px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-results {
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 5px;
        display: none;
    }

    .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .search-result-item:hover {
        background-color: #f5f5f5;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 640px) {
        #map-container, #map-view-container {
            height: 300px;
        }
        .search-container {
            width: 200px;
        }
    }

    /* Стили для уведомлений */
    .messages-overlay {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }

    .message-alert {
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .message-alert:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    .message-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .message-error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .message-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .message-info {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
    }

    .message-icon {
        font-size: 1.2em;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
        line-height: 1.4;
    }

    .message-close {
        background: none;
        border: none;
        color: white;
        opacity: 0.7;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: opacity 0.2s;
        flex-shrink: 0;
    }

    .message-close:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .messages-overlay {
            bottom: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
        }

        .message-alert {
            min-width: auto;
            max-width: none;
            padding: 14px 16px;
        }
    }

    /* Анимация спиннера */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spin {
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    #map-fallback {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
    text-align: center;
    }

    #map-fallback p {
        margin-bottom: 0.5rem;
    }

    #map-fallback button {
        margin-top: 0.5rem;
    }

    /* Цвет цены */
    .text-blue-600 {
        color: #7b61ff !important;
    }

    /* Кнопки карты */
    .map-controls button {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .map-controls button:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
    }

    /* Кнопка сохранения адреса */
    #save-address-btn {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #save-address-btn:hover {
        background: linear-gradient(135deg, #6a52e0, #2bb7c5);
        box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
    }
</style>

<div class="registration-container">
    <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border-2 border-gray-100">
        <!-- Карусель с анимацией -->
        <div class="animate-block swiper mb-6 md:mb-8">
            <div class="swiper-wrapper">
                <!-- Основное изображение -->
                <div class="swiper-slide">
                    <img src="{{ property.main_image.url }}"
                         alt="{{ property.title }}"
                         loading="lazy">
                </div>
                <!-- Дополнительные изображения -->
                {% for image in property.images.all %}
                    {% if not image.is_main %}
                    <div class="swiper-slide">
                        <img src="{{ image.image.url }}"
                             alt="Фото объекта {{ forloop.counter }}"
                             loading="lazy">
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>

        <!-- Модальное окно -->
        <div id="imageModal" class="image-modal">
            <span class="close-modal">&times;</span>
            <img class="modal-content" id="expandedImg">
        </div>

        <!-- Основная информация -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            <!-- Левая колонка -->
            <div class="lg:col-span-2">

                <!-- Заголовок и цена -->
                <div class="animate-block">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">{{ property.title }}</h1>
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-4 mb-4 md:mb-6">
                        <span class="text-2xl font-bold text-blue-600">
                            {% if property.is_rental == 'monthly' %}
                                {{ property.monthly_price|space_format }} ₽/месяц
                            {% elif property.is_rental == 'daily' %}
                                {{ property.daily_price|space_format }} ₽/сутки
                            {% else %}
                                {{ property.price|space_format }} ₽
                            {% endif %}
                        </span>
                        {% if property.is_featured %}
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 md:px-3 md:py-1 rounded-full text-sm">
                            ★ Premium
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Параметры -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-4 mb-4 md:mb-8 params-grid">
                    <!-- Город -->
                    {% if property.location %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Город</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.location }}</div>
                    </div>
                    {% endif %}

                    <!-- Адрес -->
                    {% if property.address %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Адрес</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.address }}</div>
                    </div>
                    {% endif %}

                    <!-- Комнаты (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Комнат</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.rooms }}</div>
                    </div>
                    {% endif %}
{% if property.distance_to_center %}
<div class="bg-gray-50 p-4 rounded-lg">
    <div class="text-xs md:text-sm text-gray-500">До центра</div>
    <div class="text-lg md:text-xl font-bold">{{ property.distance_to_center|floatformat:2 }} км</div>
</div>
{% endif %}

                    <!-- Этаж (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                        {% if property.floor and property.total_floors %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">Этаж</div>
                            <div class="text-lg md:text-xl font-bold">
                                {{ property.floor }}/{{ property.total_floors }}
                            </div>
                        </div>
                        {% elif property.floor %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs md:text-sm text-gray-500">Этаж</div>
                            <div class="text-lg md:text-xl font-bold">{{ property.floor }}</div>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- Общая площадь -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Общая площадь</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.total_area }} м²</div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Жилая площадь</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.living_area }} м²</div>
                    </div>

                    <!-- Год сдачи (только для новостроек) -->
                    {% if property.property_type.name == 'new_flat' and property.delivery_year %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Год сдачи</div>
                        <div class="text-lg md:text-xl font-bold">{{ property.delivery_year }}</div>
                    </div>
                    {% endif %}

                    <!-- Метро -->
                    {% if property.metro_station and property.metro_station != "Не указано" %}
<div class="bg-gray-50 p-4 rounded-lg">
    <div class="text-xs md:text-sm text-gray-500">Метро</div>
    <div class="text-lg md:text-xl font-bold">
        {{ property.metro_station|strip_metro }}
    </div>
</div>
{% endif %}

                    <!-- Отделка (только для квартир) -->
                    {% if property.property_type.name == 'new_flat' or property.property_type.name == 'resale_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Отделка</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.has_finishing|yesno:"С отделкой,Без отделки" }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Статус сдачи -->
                    {% if property.property_type.name == 'new_flat' %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs md:text-sm text-gray-500">Статус</div>
                        <div class="text-lg md:text-xl font-bold">
                            {{ property.is_delivered|yesno:"Сдан,Не сдан" }}
                        </div>
                    </div>
                    {% endif %}
                </div>

            <!-- Расположение на карте -->
<!-- В секции карты (замените текущий блок) -->
<!-- Расположение на карте -->
<div class="animate-block mb-6 md:mb-8">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">Расположение на карте</h2>

    {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
    <!-- Форма редактирования адреса (только для брокеров, застройщиков и админов) -->
    <div class="edit-address-container mb-6">
        <h3 class="text-xl font-semibold mb-4">Укажите адрес объекта</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Город</label>
            <input type="text" id="city-input" class="w-full px-3 py-2 border rounded-lg"
                   value="{{ property.location|default:'' }}" placeholder="Город будет определен автоматически">
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button type="button" id="locate-me" class="px-2 py-1 rounded text-sm">
                    <i class="bi bi-geo-alt"></i> Мое местоположение
                </button>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Поиск объектов..." id="search-objects">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
        <div class="address-display" id="address-display">
            {{ property.address|default:"Адрес не выбран" }}
        </div>

        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Метро</label>
            <input type="text" id="metro-input" class="w-full px-3 py-2 border rounded-lg"
                   placeholder="Станция метро будет определена автоматически"
                   value="{{ property.metro_station|default:'' }}">
        </div>

        <div class="mt-4 flex justify-end">
            <button id="save-address-btn" class="px-4 py-2 rounded-lg">
                Опубликовать объект
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Отображение карты для всех пользователей -->
<!-- Отображение карты для всех пользователей -->
<!-- Отображение карты для всех пользователей -->
{% if not request.user == property.broker.user and not request.user == property.developer and not request.user.is_admin %}
<div id="map-view-container" style="width: 100%; height: 400px; margin-bottom: 1rem; border-radius: 0.5rem; overflow: hidden;">
    <div id="map-view"></div>
    <div id="map-fallback" style="display: none; padding: 20px; text-align: center;">
        <p>Не удалось загрузить карту.</p>
        <button onclick="retryMapLoading()" class="btn-primary mt-2">
            Попробовать снова
        </button>
        <p class="text-sm text-gray-500 mt-2">Или обновите страницу</p>
    </div>
    {% if property.address %}
        <div class="address-display mt-4">
            <strong>Адрес:</strong> {{ property.address }}
            {% if property.metro_station and property.metro_station != "Не указано" %}
                <br><strong>Метро:</strong> {{ property.metro_station|strip_metro }}
            {% endif %}
        </div>
    {% endif %}
</div>
{% endif %}
</div>

                <!-- Описание объекта -->
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4">Описание</h2>
                <div class="scrollable-description prose max-w-none text-sm md:text-base">
                    {{ property.description|linebreaks }}
                </div>

                <!-- Карта объекта -->

            </div>

            <!-- Правая колонка -->
            <div class="animate-block contact-sidebar bg-gray-50 p-4 md:p-6 rounded-xl mt-6 md:mt-0">
                <div class="contact-content">
                    <div class="mb-4 md:mb-6">
                        <h3 class="text-lg md:text-xl font-bold">Контактная информация</h3>
                    </div>

                    <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
                        {% if property.broker.user.avatar %}
                            <img src="{{ property.broker.user.avatar.url }}"
                                 class="w-12 h-12 md:w-16 md:h-16 rounded-full object-cover">
                        {% else %}
                            <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-purple-100 to-cyan-100 flex items-center justify-center">
                                <i class="bi bi-person text-xl md:text-2xl" style="color: #7b61ff;"></i>
                            </div>
                        {% endif %}
                        <div>
                            <div class="font-medium text-base md:text-lg">
                                {{ property.broker.user.get_full_name|default:"Не указано" }}
                            </div>
                            <div class="text-xs md:text-sm text-gray-500">
                                {% if property.broker.user.is_admin %}
                                    Администратор
                                {% else %}
                                    Брокер по недвижимости
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 md:mt-8 flex flex-col gap-4">
                        {% if user.is_authenticated and user.user_type == 'client' %}
                           <a href="{% url 'properties:contact_broker' broker_id=property.broker.id property_id=property.id %}"
   class="btn-primary transition-colors">
   <i class="bi bi-chat-left-text mr-2"></i> Написать (1 руб.)
</a>
                        {% elif not user.is_authenticated %}
                            <a href="{% url 'login' %}?next={{ request.path }}"
                               class="btn-primary transition-colors">
                               <i class="bi bi-chat-left-text mr-2"></i> Войдите, чтобы написать
                            </a>
                        {% else %}
                            <button class="btn-primary opacity-50 cursor-not-allowed" disabled>
                                <i class="bi bi-chat-left-text mr-2"></i> Запросы только для клиентов
                            </button>
                        {% endif %}

                        {% if not is_broker %}
                            <form method="POST" action="{% url 'properties:property-favorite' property.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" class="btn-outline hover:border-blue-600 hover:text-blue-600 w-full text-center">
                                    <i class="bi bi-heart{% if is_favorite %}-fill text-red-500{% endif %} mr-2"></i>
                                    <span>
                                        {% if is_favorite %}
                                            Удалить из избранного
                                        {% else %}
                                            Добавить в избранное
                                        {% endif %}
                                    </span>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Контейнер для всех уведомлений в правом нижнем углу -->
<div class="messages-overlay" id="global-messages-overlay">
    {% for message in messages %}
        <div class="message-alert message-{{ message.tags|default:'info' }}">
            <div class="message-icon">
                {% if message.tags == 'success' %}
                    <i class="bi bi-check-circle-fill"></i>
                {% elif message.tags == 'error' %}
                    <i class="bi bi-exclamation-circle-fill"></i>
                {% elif message.tags == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill"></i>
                {% else %}
                    <i class="bi bi-info-circle-fill"></i>
                {% endif %}
            </div>
            <div class="message-content">
                {{ message }}
            </div>
            <button class="message-close" onclick="this.parentElement.remove()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    {% endfor %}
</div>

<script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
<script>
// Функция для показа глобальных уведомлений
function showGlobalMessage(message, type = 'info') {
    const container = document.getElementById('global-messages-overlay');
    if (!container) {
        console.error('Контейнер для глобальных уведомлений не найден');
        return;
    }

    const messageElement = document.createElement('div');
    messageElement.className = `message-alert message-${type}`;

    // Определяем иконку по типу сообщения
    let iconClass = 'bi bi-info-circle-fill';
    if (type === 'success') iconClass = 'bi bi-check-circle-fill';
    else if (type === 'error') iconClass = 'bi bi-exclamation-circle-fill';
    else if (type === 'warning') iconClass = 'bi bi-exclamation-triangle-fill';

    messageElement.innerHTML = `
        <div class="message-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="message-content">
            ${message}
        </div>
        <button class="message-close">
            <i class="bi bi-x-lg"></i>
        </button>
    `;

    container.appendChild(messageElement);

    // Анимация появления
    setTimeout(() => {
        messageElement.style.animation = 'slideInRight 0.3s ease-out';
    }, 10);

    // Обработчик закрытия
    const closeBtn = messageElement.querySelector('.message-close');
    closeBtn.addEventListener('click', function() {
        closeMessage(messageElement);
    });

    // Автоматическое закрытие через 8 секунд (дольше для важных сообщений)
    setTimeout(() => {
        if (messageElement.parentNode) {
            closeMessage(messageElement);
        }
    }, 8000);

    // Закрытие при клике на сообщение
    messageElement.addEventListener('click', function(e) {
        if (!e.target.classList.contains('message-close') && !e.target.closest('.message-close')) {
            closeMessage(messageElement);
        }
    });
}

// Функция закрытия сообщения с анимацией
function closeMessage(messageElement) {
    messageElement.style.animation = 'slideOutRight 0.3s ease-in forwards';
    setTimeout(() => {
        if (messageElement.parentNode) {
            messageElement.remove();
        }
    }, 300);
}

// Проверка URL параметров для показа уведомлений
function checkUrlForNotifications() {
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('creation_success') === '1') {
        const price = urlParams.get('price') || '0';
        showGlobalMessage(
            `Объект успешно создан! С вашего баланса списано ${price} ₽. Теперь заполните адрес объекта на карте.`,
            'success'
        );

        // Очищаем URL параметры без перезагрузки страницы
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }
}

// Обновить существующую функцию showToast для использования глобальных уведомлений
function showToast(message, type = 'info') {
    showGlobalMessage(message, type);
}

// Функция для повторной попытки загрузки карты
function loadMapWithRetry(attempt = 0) {
    if (attempt > 2) {
        console.error('Превышено количество попыток загрузки карты');
        document.getElementById('map-fallback').style.display = 'block';
        return;
    }

    if (typeof ymaps === 'undefined') {
        console.log('API Яндекс.Карт еще не загружен, попытка', attempt + 1);
        setTimeout(() => loadMapWithRetry(attempt + 1), 1000);
        return;
    }

    try {
        if (coordinates_json) {
            console.log('Инициализация карты для всех пользователей');
            initViewMap();
        } else {
            console.log('Координаты отсутствуют');
            document.getElementById('map-fallback').style.display = 'block';
            showGlobalMessage('Адрес объекта не указан', 'warning');
        }
    } catch (e) {
        console.error('Ошибка инициализации карты:', e);
        document.getElementById('map-fallback').style.display = 'block';
        showGlobalMessage('Ошибка загрузки карты', 'error');
    }
}

// Инициализация после загрузки API
ymaps.ready(function() {
    console.log('API Яндекс.Карт загружен');
    loadMapWithRetry();
});

// Анимация при скролле
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('reveal');
        }
    });
}, { threshold: 0.1 });

document.querySelectorAll('.animate-block').forEach(element => {
    observer.observe(element);
});

// Функция для инициализации свайпера
function initSwiper() {
    const swiper = new Swiper('.swiper', {
        loop: true,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        keyboard: { enabled: true },
        effect: 'slide',
        speed: 500,
        preloadImages: false,
        lazy: {
            loadPrevNext: true,
        },
    });

    return swiper;
}

// Модальное окно
function setupModal() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('expandedImg');
    const closeBtn = document.querySelector('.close-modal');

    document.querySelectorAll('.swiper-slide img').forEach(img => {
        img.addEventListener('click', () => {
            modal.style.display = 'flex';
            modalImg.src = img.src;
            modalImg.classList.add('modal-opened');
        });
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        modalImg.classList.remove('modal-opened');
    });

    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            modalImg.classList.remove('modal-opened');
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
            modalImg.classList.remove('modal-opened');
        }
    });
}

// Обработка избранного
function setupFavorites() {
    document.querySelectorAll('form[action*="favorite"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const icon = form.querySelector('i');
            const text = form.querySelector('span');

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json',
                    },
                });
                const data = await response.json();

                if (data.status === 'added') {
                    icon.classList.add('bi-heart-fill', 'text-red-500');
                    icon.classList.remove('bi-heart');
                    text.textContent = 'Удалить из избранного';
                } else {
                    icon.classList.remove('bi-heart-fill', 'text-red-500');
                    icon.classList.add('bi-heart');
                    text.textContent = 'Добавить в избранное';
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        });
    });
}

// Инициализация карты для просмотра
// Инициализация переменных из Django-контекста
const coordinates_json = '{{ coordinates_json|escapejs }}' || null;
const metro_coordinates_json = '{{ metro_coordinates_json|escapejs }}' || null;
const property_address = '{{ property.address|escapejs }}' || 'Адрес не указан';
const metro_station = '{{ property.metro_station|escapejs }}' || 'Метро не указано';

function initViewMap() {
    console.log('[MAP] Инициализация карты просмотра');

    try {
        let coords = [55.751574, 37.617635]; // Москва по умолчанию

        if (coordinates_json) {
            const coordsData = JSON.parse(coordinates_json);
            coords = [coordsData.y, coordsData.x];
            console.log('[MAP] Координаты:', coords);
        }

        // Создаем карту
        viewMap = new ymaps.Map('map-view', {
            center: coords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        // Добавляем метку
        viewPlacemark = new ymaps.Placemark(coords, {
            hintContent: property_address
        }, {
            preset: 'islands#redDotIcon',
            draggable: false
        });

        viewMap.geoObjects.add(viewPlacemark);
        console.log('[MAP] Карта успешно инициализирована');

        // Добавляем метро если есть
        if (metro_coordinates_json) {
            try {
                const metroCoordsData = JSON.parse(metro_coordinates_json);
                const metroCoords = [metroCoordsData.y, metroCoordsData.x];
                const metroPlacemark = new ymaps.Placemark(metroCoords, {
                    hintContent: metro_station
                }, {
                    preset: 'islands#blueCircleDotIcon',
                    iconColor: '#1e88e5'
                });
                viewMap.geoObjects.add(metroPlacemark);

                const polyline = new ymaps.Polyline(
                    [coords, metroCoords],
                    {},
                    {
                        strokeColor: "#1e88e5",
                        strokeWidth: 3,
                        strokeOpacity: 0.5
                    }
                );
                viewMap.geoObjects.add(polyline);
            } catch (e) {
                console.error('[MAP] Ошибка загрузки метро:', e);
            }
        }

    } catch (error) {
        console.error('[MAP] Ошибка:', error);
        document.getElementById('map-fallback').style.display = 'block';
        throw error;
    }
}

// Инициализация после загрузки API
ymaps.ready(function() {
    console.log('API Яндекс.Карт загружен');

    if (coordinates_json) {
        initViewMap();
    } else {
        document.getElementById('map-fallback').style.display = 'block';
    }
});

// Инициализация карты для редактирования
let editMap, editPlacemark;
let searchResults = [];

function initEditMap() {
    console.log('[DEBUG] Начало инициализации карты редактирования');

    let initialCoords = [55.751574, 37.617635]; // Москва по умолчанию

    {% if coordinates_json %}
        try {
            const coordsData = JSON.parse('{{ coordinates_json|escapejs }}');
            initialCoords = [coordsData.y, coordsData.x];
            console.log('[DEBUG] Edit map initial coordinates:', initialCoords);
        } catch (e) {
            console.error('[DEBUG] Error parsing coordinates:', e);
        }
    {% endif %}

    ymaps.ready(function() {
        console.log('[DEBUG] YMaps ready, creating edit map...');
        editMap = new ymaps.Map('map', {
            center: initialCoords,
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl']
        });

        editPlacemark = new ymaps.Placemark(initialCoords, {}, {
            preset: 'islands#redDotIcon',
            draggable: true
        });
        editMap.geoObjects.add(editPlacemark);

        // Обработчик клика по карте
        editMap.events.add('click', function(e) {
            const coords = e.get('coords');
            console.log('[DEBUG] Map click coordinates:', coords);
            updatePlacemark(coords);
            getAddress(coords);
            findNearestMetro(coords);
        });

        // Кнопка "Мое местоположение"
        document.getElementById('locate-me').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    console.log('[DEBUG] Geolocation coordinates:', coords);
                    editMap.setCenter(coords, 15);
                    updatePlacemark(coords);
                    getAddress(coords);
                    findNearestMetro(coords);
                }, function(error) {
                    showGlobalMessage('Не удалось определить ваше местоположение: ' + error.message, 'error');
                });
            } else {
                showGlobalMessage('Ваш браузер не поддерживает геолокацию', 'error');
            }
        });

        // Поиск объектов
        const searchInput = document.getElementById('search-objects');
        const searchResultsContainer = document.getElementById('search-results');

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 3) {
                searchResultsContainer.style.display = 'none';
                return;
            }

            searchObjects(query);
        });

        // Обработчик выбора результата поиска
        searchResultsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('search-result-item')) {
                const index = e.target.dataset.index;
                const result = searchResults[index];

                const coords = result.geometry.coordinates;
                editMap.setCenter(coords, 15);
                updatePlacemark(coords);
                getAddress(coords);
                findNearestMetro(coords);

                searchInput.value = result.properties.name;
                searchResultsContainer.style.display = 'none';
            }
        });
    });

    // Обновление метки на карте
    function updatePlacemark(coords) {
        if (editPlacemark) {
            editMap.geoObjects.remove(editPlacemark);
        }

        editPlacemark = new ymaps.Placemark(coords, {}, {
            preset: 'islands#redDotIcon',
            draggable: true
        });

        editMap.geoObjects.add(editPlacemark);

        // Обработчик перемещения метки
        editPlacemark.events.add('dragend', function() {
            const newCoords = editPlacemark.geometry.getCoordinates();
            getAddress(newCoords);
            findNearestMetro(newCoords);
        });
    }

    // Получение адреса по координатам
    function getAddress(coords) {
        ymaps.geocode(coords).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            if (firstGeoObject) {
                const address = firstGeoObject.getAddressLine();
                document.getElementById('address-display').textContent = address;

                // Автоматически заполняем город из геоданных
                const city = firstGeoObject.getLocalities()[0];
                if (city) {
                    document.getElementById('city-input').value = city;
                }
            }
        });
    }

    // Поиск ближайшего метро
    function findNearestMetro(coords) {
        ymaps.geocode(coords, { kind: 'metro' }).then(function(res) {
            const metro = res.geoObjects.get(0);
            if (metro) {
                document.getElementById('metro-input').value =
                    metro.properties.get('name');
            }
        });
    }

    // Поиск объектов через API Яндекс Карт
    function searchObjects(query) {
        ymaps.geocode(query).then(function(res) {
            searchResults = res.geoObjects.toArray().map(item => ({
                properties: {
                    name: item.properties.get('name') || item.properties.get('text'),
                    description: item.properties.get('description')
                },
                geometry: {
                    coordinates: item.geometry.getCoordinates()
                }
            }));
            displaySearchResults(searchResults);
        });
    }

    // Отображение результатов поиска
    function displaySearchResults(results) {
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="search-result-item">Ничего не найдено</div>';
            container.style.display = 'block';
            return;
        }

        results.forEach((result, index) => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.dataset.index = index;

            const name = result.properties.name || 'Объект без названия';
            const description = result.properties.description ?
                `<small class="text-gray-500">${result.properties.description}</small>` : '';

            item.innerHTML = `<strong>${name}</strong><br>${description}`;
            container.appendChild(item);
        });

        container.style.display = 'block';
    }

    // Скрываем результаты поиска при клике вне поля
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            document.getElementById('search-results').style.display = 'none';
        }
    });
}

// Обработчик сохранения адреса
document.getElementById('save-address-btn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Сохранение...';

    try {
        let coords = [55.751574, 37.617635]; // Москва по умолчанию
        if (editPlacemark) {
            const yandexCoords = editPlacemark.geometry.getCoordinates();
            console.log('Saving Yandex coordinates:', yandexCoords);
            coords = [yandexCoords[1], yandexCoords[0]];
            console.log('Converted to PostGIS format:', coords);
        }

        const response = await fetch('{% url "properties:update_property_address" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                property_id: {{ property.id }},
                city: document.getElementById('city-input').value,
                address: document.getElementById('address-display').textContent,
                metro_station: document.getElementById('metro-input').value,
                coordinates: coords.join(','),
                _method: 'PATCH'
            })
        });

        const data = await response.json();
        console.log('Server response:', data);

        if (data.status === 'success') {
            // Обновляем карту просмотра
            if (typeof viewMap !== 'undefined') {
                const newCoords = [data.coordinates.y, data.coordinates.x];
                console.log('Updating view map with:', newCoords);
                viewMap.setCenter(newCoords, 15);

                if (viewPlacemark) {
                    viewMap.geoObjects.remove(viewPlacemark);
                }

                viewPlacemark = new ymaps.Placemark(newCoords, {}, {
                    preset: 'islands#redDotIcon',
                    draggable: false
                });
                viewMap.geoObjects.add(viewPlacemark);
            }

            // Обновляем адрес в параметрах
            const addressParamElement = document.querySelector('.params-grid div:nth-child(2) .text-lg');
            if (addressParamElement) {
                addressParamElement.textContent = data.address;
            }

            showGlobalMessage('Адрес успешно сохранен!', 'success');
        } else {
            throw new Error(data.message || 'Неизвестная ошибка');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showGlobalMessage(`Ошибка: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Основная инициализация
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded: начал выполнение');

    // Проверяем уведомления из URL
    checkUrlForNotifications();

    try {
        // Инициализация свайпера и модального окна
        const swiper = initSwiper();
        setupModal();
        setupFavorites();

        // Проверка загрузки API Яндекс.Карт
        if (typeof ymaps === 'undefined') {
            showGlobalMessage('Не удалось загрузить карты. Пожалуйста, попробуйте перезагрузить страницу.', 'error');
            document.getElementById('map-fallback').style.display = 'block';
            return;
        }

        // Инициализация карт
        ymaps.ready(function() {
            try {
                // Инициализация карты просмотра только для не-брокеров/не-застройщиков/не-админов
                const isEditor = {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}true{% else %}false{% endif %};
                if (!isEditor && typeof coordinates_json !== 'undefined' && coordinates_json) {
                    console.log('Инициализация карты просмотра...');
                    try {
                        initViewMap();
                    } catch (e) {
                        console.error('Ошибка инициализации карты просмотра:', e);
                        document.getElementById('map-fallback').style.display = 'block';
                    }
                } else if (!isEditor) {
                    console.log('Нет координат для инициализации карты просмотра');
                    showGlobalMessage('Адрес объекта не указан', 'warning');
                    document.getElementById('map-fallback').style.display = 'block';
                }

                {% if request.user.is_authenticated %}
                    {% if request.user == property.broker.user or request.user == property.developer or request.user.is_admin %}
                        console.log('Инициализация карты редактирования...');
                        initEditMap();
                    {% endif %}
                {% endif %}
            } catch (e) {
                console.error('Ошибка инициализации карт:', e);
                showGlobalMessage('Ошибка при загрузке карты. Пожалуйста, попробуйте позже.', 'error');
                document.getElementById('map-fallback').style.display = 'block';
            }
        });
    } catch (e) {
        console.error('Ошибка в основном блоке инициализации:', e);
        showGlobalMessage('Произошла ошибка при загрузке страницы', 'error');
    }
});

// Функция для повторной загрузки
function retryMapLoading() {
    console.log('Попытка перезагрузки карты...');
    showGlobalMessage('Пытаемся загрузить карту...', 'info');
    location.reload();
}
</script>
{% endblock %}