{% extends 'base.html' %}
{% load custom_filters %}

{% block extra_head %}
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<style>
/* Основные стили карточек недвижимости */
.property-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    overflow: hidden;
    background: white;
}

.property-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1);
    border-color: #bfdbfe;
}

.btn-primary {
    @apply bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2;
}

.toggle-favorite {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.toggle-favorite:hover {
    transform: scale(1.1);
}

/* Стили для фильтров и карты */
.filter-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
}

@media (max-width: 1024px) {
    .filter-container {
        grid-template-columns: 1fr;
    }
}

/* Улучшенные стили для боковой панели фильтров */
.filter-sidebar {
    background: white;
    padding: 1.75rem;
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    border: 2px solid #e5e7eb;
    height: fit-content;
    position: sticky;
    top: 1rem;
    transition: all 0.3s ease;
}

.filter-sidebar:hover {
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
    border-color: #d1d5db;
}

/* Стили для секций фильтров */
.filter-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 0.75rem;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    animation: slideIn 0.3s ease-out forwards;
    opacity: 0;
}

.filter-section:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

/* Анимация появления секций */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-15px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Задержки для анимации */
.filter-section:nth-child(1) { animation-delay: 0.1s; }
.filter-section:nth-child(2) { animation-delay: 0.2s; }
.filter-section:nth-child(3) { animation-delay: 0.3s; }
.filter-section:nth-child(4) { animation-delay: 0.4s; }
.filter-section:nth-child(5) { animation-delay: 0.5s; }
.filter-section:nth-child(6) { animation-delay: 0.6s; }
.filter-section:nth-child(7) { animation-delay: 0.7s; }
.filter-section:nth-child(8) { animation-delay: 0.8s; }
.filter-section:nth-child(9) { animation-delay: 0.9s; }
.filter-section:nth-child(10) { animation-delay: 1.0s; }

/* Заголовки секций */
.filter-section h3 {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    color: #111827;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.75rem;
    position: relative;
    transition: color 0.2s;
}

.filter-section:hover h3 {
    color: #1e40af;
}

.filter-section h3::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 50px;
    height: 2px;
    background: #3b82f6;
    transition: width 0.3s ease;
}

.filter-section:hover h3::after {
    width: 80px;
}

/* Поля ввода */
.filter-section input[type="text"],
.filter-section input[type="number"],
.filter-section select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #d1d5db;
    border-radius: 0.75rem;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #374151;
    background: white;
    transition: all 0.3s ease;
}

.filter-section input[type="text"]:focus,
.filter-section input[type="number"]:focus,
.filter-section select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    outline: none;
}

.filter-section input[type="text"]:hover,
.filter-section input[type="number"]:hover,
.filter-section select:hover {
    border-color: #9ca3af;
}

/* Сетка для двойных полей */
.filter-section .grid-cols-2 {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
}

/* Лейблы */
.filter-section label {
    display: block;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 0.5rem;
    transition: color 0.2s;
}

.filter-section:hover label {
    color: #111827;
}

/* Чекбоксы и радиокнопки */
.filter-section .flex.items-center {
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
    margin-bottom: 0.5rem;
}

.filter-section .flex.items-center:hover {
    background: rgba(59, 130, 246, 0.05);
}

.filter-section .flex.items-center input[type="checkbox"],
.filter-section .flex.items-center input[type="radio"] {
    margin-right: 0.75rem;
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    transition: all 0.2s;
    cursor: pointer;
}

.filter-section .flex.items-center input[type="checkbox"]:checked,
.filter-section .flex.items-center input[type="radio"]:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.filter-section .flex.items-center label {
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: color 0.2s;
}

.filter-section .flex.items-center:hover label {
    color: #1e40af;
}

/* Кнопки фильтров */
.filter-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

#apply_filters {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

#apply_filters:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15);
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

#apply_filters:active {
    transform: translateY(0);
}

#reset_filters {
    background: white;
    color: #374151;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 700;
    border: 2px solid #d1d5db;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

#reset_filters:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    border-color: #9ca3af;
    background: #f9fafb;
}

#reset_filters:active {
    transform: translateY(0);
}

/* Иконки для кнопок */
.filter-actions button i {
    font-size: 1.1em;
    transition: transform 0.3s ease;
}

#apply_filters:hover i {
    transform: rotate(5deg) scale(1.1);
}

#reset_filters:hover i {
    transform: rotate(-5deg) scale(1.1);
}

/* Подсветка активных фильтров */
.filter-section:has(input:not([value=""])) {
    background: #f0f7ff;
    border-color: #bfdbfe;
}

.filter-section:has(input:not([value=""])) h3 {
    color: #1e40af;
}

.filter-section:has(input:not([value=""])) h3::after {
    background: #1e40af;
}

/* Стили для карты */
.map-container-wrapper {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    border: 2px solid #e5e7eb;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
}

#all-properties-map {
    width: 100%;
    height: 500px;
    display: block;
    transition: height 0.3s ease;
}

/* Индикатор загрузки карты */
.map-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
    border-radius: 16px;
}

.map-loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1e40af;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Контейнер для карты и поиска */
.map-search-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
}

/* Контейнер для поиска и кнопки добавления */
.search-add-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

@media (min-width: 768px) {
    .search-add-container {
        flex-direction: row;
        align-items: center;
    }
}

.search-form {
    flex-grow: 1;
    max-width: calc(100% - 180px);
}

@media (max-width: 768px) {
    .search-add-container {
        flex-direction: column;
    }
    .search-form {
        max-width: 100%;
        width: 100%;
    }
}

/* Стили для пагинации */
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 2rem;
}

.page-item {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
}

.page-item:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.page-item.bg-blue-600 {
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
}

/* Стили для модального окна городов */
#city-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    padding: 2rem;
    overflow-y: auto;
    backdrop-filter: blur(5px);
    display: none;
}

#city-dropdown > .container {
    background-color: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 800px;
    margin: 2rem auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.city-search-container {
    background-color: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#city-search:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.city-option {
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 1.125rem;
    transition: all 0.2s ease;
    text-align: left;
    background: white;
}

.city-option:hover {
    background-color: #f0f7ff;
    border-color: #bfdbfe;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.city-option.hidden {
    display: none;
}

#close-city-modal {
    font-size: 1.8rem;
    line-height: 1;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0 0.5rem;
}

/* Обновленные стили для модального окна метро */
/* Модальное окно метро */
#metro-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.metro-dropdown-container {
    background-color: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.metro-dropdown-header {
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

.metro-dropdown-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.metro-dropdown-footer {
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* Стили для линий и станций метро */
.metro-lines-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
}

.metro-line-section {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.metro-line-header {
    padding: 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
    background-color: white;
}

.metro-line-header:hover {
    background-color: #f9fafb;
}

.metro-line-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
}

.metro-stations-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.metro-stations-container.expanded {
    max-height: 300px;
}

.metro-station-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    width: 100%;
    cursor: pointer;
    background-color: white;
    border: none;
    text-align: left;
}

.metro-station-option:hover {
    background-color: #f3f4f6;
}

.metro-station-option.selected {
    background-color: #3b82f6;
    color: white;
}

.metro-station-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.metro-line-name {
    font-weight: 600;
    font-size: 0.95rem;
    flex-grow: 1;
}

.metro-station-option {
    display: flex;
    align-items: center;
    padding: 0.6rem 1rem;
    width: 100%;
    text-align: left;
    background: white;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f3f4f6;
}

.metro-station-option:last-child {
    border-bottom: none;
}

.metro-station-option:hover {
    background-color: #f0f7ff;
}

.metro-station-option.selected {
    background-color: #3b82f6 !important;
    color: white !important;
}

.metro-station-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.metro-station-name {
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
}

/* Улучшенный скроллбар */
.metro-lines-container::-webkit-scrollbar,
.metro-stations-container::-webkit-scrollbar {
    width: 6px;
}

.metro-lines-container::-webkit-scrollbar-track,
.metro-stations-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.metro-lines-container::-webkit-scrollbar-thumb,
.metro-stations-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.metro-lines-container::-webkit-scrollbar-thumb:hover,
.metro-stations-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Анимация при открытии/закрытии */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.metro-stations-container.expanded {
    animation: slideDown 0.2s ease-out;
}

/* Адаптивные стили */
@media (max-width: 768px) {
    .metro-lines-container {
        max-height: calc(100vh - 150px);
    }

    .metro-line-header {
        padding: 0.75rem;
    }

    .metro-station-option {
        padding: 0.5rem 0.75rem;
    }

    .metro-stations-container.expanded {
        max-height: 250px;
    }
}

/* Стили для поиска */
.metro-search-container {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

/* Стили для футера */
.metro-dropdown-footer {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    z-index: 10;
}

.metro-action-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

#apply-metro-selection {
    background: #3b82f6;
    color: white;
    border: none;
}

#apply-metro-selection:hover {
    background: #2563eb;
}

#clear-metro-selection {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
}

#clear-metro-selection:hover {
    background: #f3f4f6;
}

/* Адаптивные стили */
@media (max-width: 1024px) {
    .filter-toggle {
        display: block;
        margin-bottom: 1.5rem;
        width: 100%;
    }

    .filter-sidebar {
        display: none;
    }

    .filter-sidebar.active {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
}

@media (max-width: 768px) {
    .sticky-column {
        position: relative;
        top: auto;
    }

    .filter-section {
        padding: 1rem;
    }

    .filter-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Контейнер для карты и поиска -->
    <div class="map-search-container">
        <!-- Заголовок и поиск -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border-2 border-gray-100">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <h1 class="text-3xl font-bold text-gray-800">
                {% if user.is_authenticated and user.is_broker %}
                    Мои объекты
                {% else %}
                    Каталог недвижимости
                {% endif %}
            </h1>

            <div class="w-full md:w-auto flex-1 flex flex-col sm:flex-row gap-4 items-stretch">
                <form class="search-form flex-1">
                    <div class="relative h-full">
                        <input type="search"
                               name="search"
                               placeholder="Поиск по названию или локации..."
                               class="w-full h-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600">
                            <i class="bi bi-search text-xl"></i>
                        </button>
                    </div>
                </form>

                {% if user.is_authenticated and user.is_broker %}
                    <a href="{% url 'properties:select-listing-type' %}"
                       class="btn-primary flex items-center justify-center gap-2 whitespace-nowrap px-6 py-3 rounded-lg transition-all hover:shadow-md">
                        <i class="bi bi-plus-lg"></i> Добавить
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

        <!-- Карта всех объектов -->
      <!-- Карта всех объектов -->


     <div class="flex flex-col lg:flex-row gap-8">
        <aside class="w-full lg:w-64 flex-shrink-0 order-first">
            <div class="bg-white rounded-lg shadow p-6 sticky-column">
                <button class="filter-toggle btn-primary mb-4 lg:hidden">
                    <i class="bi bi-funnel"></i> Фильтры
                </button>
                <div class="filter-sidebar lg:block" id="filter-sidebar">
                    <form method="get" id="filter-form">
                        <!-- Тип недвижимости -->
                        <div class="filter-section">
                            <h3>Тип недвижимости</h3>

<div class="property-type-filter">
    {% for pt in property_types %}
        <div class="property-type-item">
            <input type="checkbox"
                   name="property_type"
                   value="{{ pt.name }}"
                   id="property_type_{{ pt.name }}"
                   {% if pt.name in selected_property_types %}checked{% endif %}>
            <label for="property_type_{{ pt.name }}">
                {{ pt.get_name_display }}
            </label>
        </div>
    {% endfor %}
</div>
                        </div>
                    <div class="filter-section">
    <h3>Вид размещения</h3>
    <div class="flex flex-col gap-2">
        <div class="flex items-center">
            <input type="radio" name="rental_type" value="no" id="rental_type_no"
                   {% if filter.form.rental_type.value != 'monthly' and filter.form.rental_type.value != 'daily' %}checked{% endif %}
                   class="mr-2">
            <label for="rental_type_no" class="text-sm font-medium">Продажа</label>
        </div>
        <div class="flex items-center">
            <input type="radio" name="rental_type" value="monthly" id="rental_type_monthly"
                   {% if filter.form.rental_type.value == 'monthly' %}checked{% endif %}
                   class="mr-2">
            <label for="rental_type_monthly" class="text-sm font-medium">Аренда помесячно</label>
        </div>
        <div class="flex items-center">
            <input type="radio" name="rental_type" value="daily" id="rental_type_daily"
                   {% if filter.form.rental_type.value == 'daily' %}checked{% endif %}
                   class="mr-2">
            <label for="rental_type_daily" class="text-sm font-medium">Аренда посуточно</label>
        </div>
    </div>
</div>
                     <!-- Город -->
                       <!-- В секции фильтра по городу замените текущий input на этот код -->
<div class="filter-section">
    <h3>Город</h3>
    <div class="relative">
        <button type="button"
                id="city-input"
                class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-medium bg-white hover:bg-blue-50 transition-colors text-left relative shadow-sm hover:shadow-md"
                onclick="document.getElementById('city-dropdown').classList.remove('hidden')">
            <span id="selected-city-text" class="text-gray-700">
                {% if filter.form.location.value %}
                    {{ filter.form.location.value }}
                {% else %}
                    Выберите город
                {% endif %}
            </span>
            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        </button>

        <input type="hidden"
               name="location"
               value="{{ filter.form.location.value|default:'' }}"
               id="city-hidden-input">

       <div id="city-dropdown" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Выберите город</h2>
                <button id="close-city-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
    ×
</button>
            </div>

            <div class="mt-4">
                <input type="text"
                       id="city-search"
                       placeholder="Начните вводить название города..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="p-4">
            <button type="button" id="use-custom-city" class="hidden w-full mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                Применить
            </button>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Здесь остаются ваши city-option кнопки -->
                <button type="button"
        class="city-option py-2 px-3 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-base"
        data-city="Москва">
    Москва
</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Московская область">Московская область</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Санкт-Петербург">Санкт-Петербург</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Ленинградская область">Ленинградская область</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Екатеринбург">Екатеринбург</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Краснодар">Краснодар</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Новосибирск">Новосибирск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Красноярск">Красноярск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Челябинск">Челябинск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Ростов-на-Дону">Ростов-на-Дону</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Тюмень">Тюмень</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Уфа">Уфа</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Казань">Казань</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Пермь">Пермь</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Нижний Новгород">Нижний Новгород</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Самара">Самара</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Саратов">Саратов</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Омск">Омск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Балашиха">Балашиха</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Волгоград">Волгоград</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Воронеж">Воронеж</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Иркутск">Иркутск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Хабаровск">Хабаровск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Томск">Томск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Ярославль">Ярославль</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Сочи">Сочи</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Сургут">Сургут</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Подольск">Подольск</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Мытищи">Мытищи</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Владивосток">Владивосток</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Калуга">Калуга</button>
            <button type="button"
                    class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                    data-city="Пятигорск">Пятигорск</button>
        </div>
    </div>
</div>
    </div>
</div>
                       <!-- Метро -->
<!-- В секции фильтра по метро -->
<div class="filter-section">
    <h3>Метро</h3>
    <div class="relative">
        <button type="button"
                id="metro-input"
                class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-medium bg-white hover:bg-blue-50 transition-colors text-left relative shadow-sm hover:shadow-md"
                onclick="document.getElementById('metro-dropdown').classList.remove('hidden')">
            <div id="selected-metro-text" class="text-gray-700 flex items-center flex-wrap gap-1">
                {% if filter.form.metro_station.value %}
                    {% for station in filter.form.metro_station.value|slice:":3" %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ station }}
                        </span>
                    {% endfor %}
                    {% if filter.form.metro_station.value|length > 3 %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            +{{ filter.form.metro_station.value|length|add:"-3" }}
                        </span>
                    {% endif %}
                {% else %}
                    Выберите станции метро
                {% endif %}
            </div>
            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        </button>

      <input type="hidden"
       name="metro_station"
       value="{% if filter.form.metro_station.value %}{{ filter.form.metro_station.value }}{% endif %}"
       id="metro-hidden-input">

        <!-- Модальное окно выбора станций метро -->
     <!-- Модальное окно выбора станций метро -->
<!-- Модальное окно выбора станций метро -->
<div id="metro-dropdown" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Заголовок -->
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Выберите станции метро</h2>
                <button id="close-metro-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    ×
                </button>
            </div>
            <div class="mt-4">
                <input type="text"
                       id="metro-search"
                       placeholder="Начните вводить название станции..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- Контент с прокруткой -->
        <div class="p-4 overflow-y-auto flex-1">
            {% if location %}
                {% if metro_lines %}
                    <!-- Особый вариант для Москвы -->
                    {% if location == "Москва" %}
                    <div class="metro-lines-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 overflow-y-auto max-h-[calc(100vh-200px)]">
                        {% for line in metro_lines %}
                          <div class="metro-line-section border border-gray-200 rounded-lg mb-2 overflow-hidden">
    <div class="metro-line-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
         onclick="toggleMetroLine(this)">
        <div class="flex items-center">
            <div class="metro-line-color w-5 h-5 rounded-full mr-3"
                 style="background-color: {{ line.line_color }}"></div>
            <h3 class="metro-line-name font-medium">{{ line.line|default:"Другие станции" }}</h3>
        </div>
        <i class="bi bi-chevron-down transition-transform duration-200"></i>
    </div>

    <div class="metro-stations-container transition-all duration-300 overflow-y-auto"
         style="max-height: 0">
       <div class="metro-stations-container">
    {% for station in line.stations %}
        <button type="button"
                class="metro-station-option flex items-center px-3 py-1.5 rounded text-sm transition-colors {% if station.name in filter.form.metro_station.value %}bg-blue-100 text-blue-800{% else %}hover:bg-gray-200{% endif %}"
                data-station="{{ station.name }}">
            <div class="metro-station-color w-3 h-3 rounded-full mr-2 flex-shrink-0"
                 style="background-color: {{ station.line_color|default:'#cccccc' }}"></div>
            <span class="metro-station-name truncate">{{ station.name }}</span>
        </button>
    {% endfor %}
</div>
    </div>
</div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <!-- Стандартный вариант для других городов -->
                    <div class="metro-lines-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto max-h-[calc(100vh-200px)]">
                        {% for line in metro_lines %}
                            <div class="metro-line-section">
                                <div class="metro-line-header flex items-center mb-3">
                                    <div class="metro-line-color w-6 h-6 rounded-full mr-2"
                                         style="background-color: {{ line.line_color }}"></div>
                                    <h3 class="metro-line-name text-lg font-semibold">
                                        {{ line.line|default:"Другие станции" }}
                                    </h3>
                                </div>

                                <div class="metro-stations-grid max-h-60 overflow-y-auto pr-2">
                                    {% for station in line.stations %}
                                        <button type="button"
                                                class="metro-station-option flex items-center px-3 py-2 border rounded-lg transition-colors {% if station.name in filter.form.metro_station.value %}bg-blue-100 border-blue-500{% else %}border-gray-200 hover:bg-gray-50{% endif %}"
                                                data-station="{{ station.name }}">
                                            <div class="metro-station-color w-4 h-4 rounded-full mr-2"
                                                 style="background-color: {{ station.line_color|default:'#cccccc' }}"></div>
                                            <span class="metro-station-name text-sm">{{ station.name }}</span>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 py-4 text-center">Для выбранного города нет данных о станциях метро</p>
                {% endif %}
            {% else %}
                <p class="text-gray-500 py-4 text-center">Сначала выберите город</p>
            {% endif %}
        </div>

        <!-- Футер -->
        <div class="sticky bottom-0 bg-white p-4 border-t border-gray-200 flex justify-end gap-3">
            <button type="button"
                    id="clear-metro-selection"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50">
                Очистить
            </button>
            <button type="button"
                    id="apply-metro-selection"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                Применить
            </button>
        </div>
    </div>
</div>



                       <!-- Расстояние до центра -->
                        <div class="filter-section">
                            <h3>Расстояние до центра, км</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_distance_to_center" value="{{ filter.form.min_distance_to_center.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_distance_to_center" value="{{ filter.form.max_distance_to_center.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium" step="0.1">
                                </div>
                            </div>
                        </div>

                        <!-- Радиус на карте -->
                        <input type="hidden" name="radius_filter" id="radius-filter-input">





                        <!-- Цена -->
                        <div class="filter-section">
                            <h3>Цена, ₽</h3>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_price" value="{{ filter.form.min_price.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_price" value="{{ filter.form.max_price.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>

                            <h3>Цена за м², ₽</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_price_per_sqm" value="{{ filter.form.min_price_per_sqm.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_price_per_sqm" value="{{ filter.form.max_price_per_sqm.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <!-- Площадь -->
                        <div class="filter-section">
                            <h3>Площадь, м²</h3>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Общая от</label>
                                    <input type="number" name="min_area" value="{{ filter.form.min_area.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Общая до</label>
                                    <input type="number" name="max_area" value="{{ filter.form.max_area.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Жилая от</label>
                                    <input type="number" name="min_living_area" value="{{ filter.form.min_living_area.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Жилая до</label>
                                    <input type="number" name="max_living_area" value="{{ filter.form.max_living_area.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <!-- Комнаты -->
                        <div class="filter-section">
                            <h3>Количество комнат</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="rooms__gte" value="{{ filter.form.rooms__gte.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="rooms__lte" value="{{ filter.form.rooms__lte.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <!-- Этажи -->
                        <div class="filter-section">
                            <h3>Этаж</h3>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_floor" value="{{ filter.form.min_floor.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_floor" value="{{ filter.form.max_floor.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>

                            <h3>Этажность дома</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_total_floors" value="{{ filter.form.min_total_floors.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_total_floors" value="{{ filter.form.max_total_floors.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <!-- Год постройки -->
                        <div class="filter-section">
                            <h3>Год постройки</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">От</label>
                                    <input type="number" name="min_construction_year" value="{{ filter.form.min_construction_year.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">До</label>
                                    <input type="number" name="max_construction_year" value="{{ filter.form.max_construction_year.value|default:'' }}"
                                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                </div>
                            </div>
                        </div>



                        <!-- Чекбоксы -->
                        <div class="filter-section">
                            <div class="flex items-center mb-2">
                                {{ filter.form.has_finishing }}
                                <label for="{{ filter.form.has_finishing.id_for_label }}" class="ml-2 text-sm font-medium">
                                    Только с отделкой
                                </label>
                            </div>

                            <div class="flex items-center">
                                {{ filter.form.is_delivered }}
                                <label for="{{ filter.form.is_delivered.id_for_label }}" class="ml-2 text-sm font-medium">
                                    Только сданные
                                </label>
                            </div>
                        </div>

                        <!-- Кнопки фильтра -->
                        <div class="filter-actions">
                            <button type="submit" id="apply_filters" class="btn-primary px-4 py-2 text-sm font-semibold">
                                Применить
                            </button>
                            <a href="?" id="reset_filters" class="px-4 py-2 text-sm font-semibold border-2 border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                Сбросить
                            </a>
                        </div>

                    </form>
                </div>
            </div>
        </aside>
        <div style="display:none">API Key: {{ YANDEX_MAPS_API_KEY }}</div>


  <div class="flex-1">
            <!-- Карта всех объектов -->
            <div class="flex justify-end">
                <div class="custom-map-container relative" style="width: 1000px; height: 500px;">
                    <div id="all-properties-map" class="rounded-xl overflow-hidden"></div>
                    <div class="map-loading" id="map-loading">
                        <div class="map-loading-spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Карточки объектов -->
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                {% if properties %}
                    {% for property in properties %}
           <a href="{% url 'properties:property-detail' property.id %}" class="property-card bg-white rounded-xl shadow-sm hover:shadow-md p-6 transition-all block">
    <div class="relative mb-4">
        <img src="{{ property.main_image.url }}"
             class="w-full h-48 object-cover rounded-lg"
             alt="{{ property.title }}">
        {% if property.is_featured %}
        <span class="absolute top-2 right-2 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
            ★ Premium
        </span>
        {% endif %}
    </div>

    <div class="space-y-4">
        <h3 class="text-xl font-bold text-gray-800 truncate">
            {{ property.title }}
        </h3>

        <!-- Убрал border-2 у этого контейнера -->
        <div class="rounded-lg p-3 bg-gray-50">
            <div class="grid grid-cols-2 gap-3">
                <!-- Город -->
                <div class="flex items-center gap-2">
                    <i class="bi bi-geo-alt"></i>
                    <span class="truncate">{{ property.location }}</span>
                </div>

                <!-- Комнаты -->
                <div class="flex items-center gap-2">
                    <i class="bi bi-door-open"></i>
                    <span>{{ property.rooms }} комн.</span>
                </div>

                <!-- Метро -->
                {% if property.metro_station and property.metro_station != "Не указано" %}
                <div class="flex items-center gap-2">
                    <i class="bi bi-subway"></i>
                    <span class="truncate">{{ property.metro_station|cut:"метро " }}</span>
                </div>
                {% else %}
                <div></div>
                {% endif %}

                <!-- Метраж -->
                <div class="flex items-center gap-2">
                    <i class="bi bi-arrows-fullscreen"></i>
                    <span>{{ property.total_area}} м²</span>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between mt-4">
            <span class="text-2xl font-bold text-blue-600">
                {% if property.is_rental == 'monthly' and property.monthly_price %}
                    {{ property.monthly_price|space_format }} ₽/мес
                {% elif property.is_rental == 'daily' and property.daily_price %}
                    {{ property.daily_price|space_format }} ₽/сут
                {% else %}
                    {{ property.price|space_format }} ₽
                {% endif %}
            </span>
            {% if user.is_authenticated %}
            <button class="toggle-favorite" data-property-id="{{ property.id }}" onclick="event.stopPropagation()">
                <i class="bi bi-heart{% if property in user.favorites.all %}-fill text-red-500{% endif %} text-xl"></i>
            </button>
            {% endif %}
        </div>

        <!-- Кнопка "Подробнее" -->
        <div class="mt-4">
            <button class="w-full py-2 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2" onclick="event.stopPropagation()">
                <i class="bi bi-eye"></i> Подробнее
            </button>
        </div>
    </div>
</a>
                    {% endfor %}
                {% else %}
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="bi bi-house-x text-3xl"></i>
                        <p class="mt-2">
                            {% if user.is_authenticated and user.is_broker %}
                                У вас пока нет объектов
                            {% else %}
                                Объекты не найдены
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>

            <!-- Пагинация -->
            {% if is_paginated %}
            <div class="pagination flex justify-center gap-2 mt-8">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}"
                   class="page-item px-4 py-2 rounded-lg border-2 border-gray-200 hover:bg-gray-50">
                    <i class="bi bi-chevron-left"></i>
                </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                <a href="?page={{ num }}"
                   class="page-item px-4 py-2 rounded-lg border-2 {% if num == page_obj.number %}bg-blue-600 text-white border-blue-600{% else %}border-gray-200 hover:bg-gray-50{% endif %}">
                    {{ num }}
                </a>
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}"
                   class="page-item px-4 py-2 rounded-lg border-2 border-gray-200 hover:bg-gray-50">
                    <i class="bi bi-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
  // Функция инициализации карты
  function initMap() {
      console.log("[DEBUG] Начало инициализации карты");

      if (typeof ymaps === 'undefined') {
          console.error('[DEBUG] Yandex Maps API not loaded');
          setTimeout(initMap, 100);
          return;
      }

      // Получаем контейнер карты
      const mapContainer = document.getElementById('all-properties-map');
      const mapWrapper = mapContainer.parentElement;
      mapWrapper.style.width = '1200px';
      mapWrapper.style.height = '300px';

      if (mapContainer.offsetHeight === 0) {
          mapContainer.style.height = mapWrapper.style.height || '500px';
      }
      ymaps.ready(function() {
          const allPropertiesMap = new ymaps.Map('all-properties-map', {
              center: [55.751574, 37.617635],
              zoom: 10,
              controls: ['zoomControl', 'geolocationControl']
          });

          // Настройка контрола геолокации
          allPropertiesMap.controls.get('geolocationControl').options.set({
              position: { top: '15px', right: '15px' },
              size: 'small',
              float: 'none',
              noPlacemark: false
          });

          // Создаем коллекцию для хранения всех объектов
          const objectManager = new ymaps.ObjectManager({
              clusterize: true,
              gridSize: 64,
              clusterDisableClickZoom: true
          });

          // Настройка внешнего вида кластеров
          objectManager.clusters.options.set({
              preset: 'islands#invertedDarkBlueClusterIcons',
              groupByCoordinates: false,
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
          });

          // Настройка внешнего вида меток
          objectManager.objects.options.set({
              preset: 'islands#darkBlueHomeIcon',
              balloonContentLayout: ymaps.templateLayoutFactory.createClass(
                  `<div style="padding: 10px;">
                      <img src="$[properties.image]" style="width: 100%; height: 120px; object-fit: cover; margin-bottom: 10px;">
                      <h3 style="margin: 0 0 5px 0; font-size: 16px;">$[properties.title]</h3>
                      <p style="margin: 0; font-weight: bold; color: #0060f4;">$[properties.price]</p>
                      <a href="$[properties.url]" style="display: inline-block; margin-top: 10px; color: #0060f4;">Подробнее</a>
                  </div>`
              ),
              hideIconOnBalloonOpen: false,
              openBalloonOnClick: true,
              balloonAutoPan: false,
              balloonCloseButton: false
          });

          // Добавляем объекты в менеджер
          const features = [];
          {% for property in properties %}
              {% if property.coordinates %}
                  features.push({
                      type: 'Feature',
                      id: {{ property.id }},
                      geometry: {
                          type: 'Point',
                          coordinates: [parseFloat('{{ property.coordinates.y|stringformat:"f" }}'.replace(',', '.')),
                                     parseFloat('{{ property.coordinates.x|stringformat:"f" }}'.replace(',', '.'))]
                      },
                      properties: {
                          title: '{{ property.title|escapejs }}',
                          price: `{% if property.is_rental == 'monthly' and property.monthly_price %}
                                      {{ property.monthly_price|space_format }} ₽/мес
                                  {% elif property.is_rental == 'daily' and property.daily_price %}
                                      {{ property.daily_price|space_format }} ₽/сут
                                  {% else %}
                                      {{ property.price|space_format }} ₽
                                  {% endif %}`,
                          image: '{{ property.main_image.url }}',
                          url: '{% url 'properties:property-detail' property.id %}'
                      }
                  });
              {% endif %}
          {% endfor %}

          objectManager.add(features);
          allPropertiesMap.geoObjects.add(objectManager);

          // Автомасштабирование
          if (features.length > 0) {
              allPropertiesMap.setBounds(objectManager.getBounds(), {
                  checkZoomRange: true,
                  zoomMargin: 50
              });
          } else {
              allPropertiesMap.setCenter([55.751574, 37.617635], 10);
          }

          // Переменные для управления состоянием
          let currentMapCenter = allPropertiesMap.getCenter();
          let isUserZooming = false;
          let zoomTimeout;
          let balloonsOpened = false;
          let lastZoomLevel = allPropertiesMap.getZoom();

          // Функция для безопасного открытия балунов
          function safeOpenBalloon(objectManager, objectId) {
              try {
                  objectManager.objects.balloon.open(objectId, {
                      autoPan: false,
                      closeButton: false
                  });
              } catch (e) {
                  console.error('Ошибка при открытии балуна:', e);
              }
          }

          // Обработчик изменения масштаба
          allPropertiesMap.events.add('boundschange', function(e) {
              const zoom = e.get('newZoom');
              const oldZoom = lastZoomLevel;
              lastZoomLevel = zoom;

              // Сохраняем текущий центр карты
              currentMapCenter = allPropertiesMap.getCenter();

              // Если пользователь изменяет масштаб
              if (e.get('byUser')) {
                  isUserZooming = true;

                  // Сбрасываем предыдущий таймер
                  clearTimeout(zoomTimeout);

                  // Устанавливаем новый таймер
                  zoomTimeout = setTimeout(() => {
                      isUserZooming = false;
                      // После завершения зума проверяем нужно ли открыть балуны
                      if (zoom >= 15 && !balloonsOpened) {
                          openAllBalloons(objectManager);
                          balloonsOpened = true;
                      }
                  }, 1000);
              }

              if (zoom < 12) {
                  // При маленьком масштабе показываем только кластеры
                  objectManager.objects.options.set({ visible: false });
                  objectManager.clusters.options.set({ visible: true });
                  if (balloonsOpened) {
                      closeAllBalloons(objectManager);
                      balloonsOpened = false;
                  }
              } else {
                  // При среднем и большом масштабе показываем объекты
                  objectManager.objects.options.set({
                      visible: true,
                      preset: 'islands#darkBlueHomeIcon'
                  });
                  objectManager.clusters.options.set({ visible: false });

                  // Открываем балуны только если:
                  // 1. Масштаб >= 15
                  // 2. Пользователь не изменяет масштаб в данный момент
                  // 3. Балуны еще не открыты
                  if (zoom >= 15 && !isUserZooming && !balloonsOpened) {
                      openAllBalloons(objectManager);
                      balloonsOpened = true;
                  } else if (zoom < 15 && balloonsOpened) {
                      closeAllBalloons(objectManager);
                      balloonsOpened = false;
                  }
              }
          });

          // Обработчик клика по объекту
          objectManager.objects.events.add('click', function(e) {
              const objectId = e.get('objectId');
              const centerBefore = allPropertiesMap.getCenter();

              // Закрываем все балуны перед открытием нового
              closeAllBalloons(objectManager);
              balloonsOpened = false;

              // Открываем балун для выбранного объекта
              safeOpenBalloon(objectManager, objectId);
          });

          // Обработчик закрытия балуна
          objectManager.objects.balloon.events.add('close', function() {
              balloonsOpened = false;
          });
      });
  }

  // Функция для открытия всех балунов без перемещения карты
  function openAllBalloons(objectManager) {
      // Получаем все объекты
      const objects = objectManager.objects.getAll();

      // Сначала закрываем все балуны
      objectManager.objects.balloon.close();

      // Затем открываем их с задержкой
      objects.forEach((object, index) => {
          setTimeout(() => {
              try {
                  objectManager.objects.balloon.open(object.id, {
                      autoPan: false,
                      closeButton: false
                  });
              } catch (e) {
                  console.error('Ошибка при открытии балуна:', e);
              }
          }, index * 200); // Увеличили задержку между открытием балунов
      });
  }

  // Функция для закрытия всех балунов
  function closeAllBalloons(objectManager) {
      try {
          objectManager.objects.balloon.close();
      } catch (e) {
          console.error('Ошибка при закрытии балунов:', e);
      }
  }

  // Загружаем Яндекс.Карты динамически
  function loadYandexMaps() {
      console.log("[DEBUG] Начало загрузки Yandex Maps API");

      const script = document.createElement('script');
      script.src = `https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU&onload=initMap`;
      script.type = 'text/javascript';

      script.onload = function() {
          console.log("[DEBUG] Скрипт Yandex Maps API успешно загружен");
      };

      script.onerror = function() {
          console.error("[DEBUG] Ошибка загрузки скрипта Yandex Maps API");
      };

      document.head.appendChild(script);
  }

  // Запускаем загрузку карт после полной загрузки страницы
  document.addEventListener('DOMContentLoaded', function() {
      console.log("[DEBUG] DOM полностью загружен, начинаем загрузку карт");
      loadYandexMaps();

      // Переключение видимости фильтров на мобильных
      const filterToggle = document.querySelector('.filter-toggle');
      const filterSidebar = document.getElementById('filter-sidebar');

      if (filterToggle && filterSidebar) {
          filterToggle.addEventListener('click', function() {
              filterSidebar.classList.toggle('hidden');
          });
      }

      // Обработчик для кнопки "Избранное"
      document.querySelectorAll('.toggle-favorite').forEach(button => {
          button.addEventListener('click', function(e) {
              e.preventDefault();
              const propertyId = this.getAttribute('data-property-id');
              const icon = this.querySelector('i');

              fetch(`/properties/${propertyId}/toggle-favorite/`, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': '{{ csrf_token }}',
                      'Accept': 'application/json',
                  },
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'added') {
                      icon.classList.add('bi-heart-fill', 'text-red-500');
                      icon.classList.remove('bi-heart');
                  } else {
                      icon.classList.remove('bi-heart-fill', 'text-red-500');
                      icon.classList.add('bi-heart');
                  }
              })
              .catch(error => console.error('Error:', error));
          });
      });

      // Обработчик для выбора города
      const cityInput = document.getElementById('city-input');
      const cityDropdown = document.getElementById('city-dropdown');
      const citySearch = document.getElementById('city-search');
      const closeCityModal = document.getElementById('close-city-modal');
      const useCustomCityBtn = document.getElementById('use-custom-city');
      let customCity = '';

      // Открытие модального окна
      cityInput.addEventListener('click', function(e) {
          e.preventDefault();
          cityDropdown.classList.remove('hidden');
          citySearch.focus();
      });

      // Закрытие модального окна
      closeCityModal.addEventListener('click', function() {
          cityDropdown.classList.add('hidden');
      });

      // Закрытие при клике вне контента
      cityDropdown.addEventListener('click', function(e) {
          if (e.target === cityDropdown) {
              cityDropdown.classList.add('hidden');
          }
      });

      // Обработка выбора города из списка
      document.querySelectorAll('.city-option').forEach(option => {
          option.addEventListener('click', function() {
              const city = this.getAttribute('data-city');
              document.getElementById('selected-city-text').textContent = city;
              document.getElementById('city-hidden-input').value = city;
              cityDropdown.classList.add('hidden');
              document.getElementById('apply_filters').click();
          });
      });

      // Обработчик ввода в поле поиска
      citySearch.addEventListener('input', function() {
          const searchTerm = this.value.trim();
          customCity = searchTerm;

          // Показываем/скрываем кнопку для ручного ввода
          if (searchTerm.length > 2) {
              useCustomCityBtn.classList.remove('hidden');
              useCustomCityBtn.textContent = `Использовать "${searchTerm}"`;
          } else {
              useCustomCityBtn.classList.add('hidden');
          }

          // Фильтрация стандартных городов
          document.querySelectorAll('.city-option').forEach(option => {
              const city = option.getAttribute('data-city').toLowerCase();
              if (city.includes(searchTerm.toLowerCase())) {
                  option.classList.remove('hidden');
              } else {
                  option.classList.add('hidden');
              }
          });
      });

      // Обработчик выбора ручного ввода
      useCustomCityBtn.addEventListener('click', function() {
          if (customCity) {
              document.getElementById('selected-city-text').textContent = customCity;
              document.getElementById('city-hidden-input').value = customCity;
              cityDropdown.classList.add('hidden');
              document.getElementById('apply_filters').click();
          }
      });

      // Обработчик Enter в поле поиска
      citySearch.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && customCity) {
              e.preventDefault();
              document.getElementById('selected-city-text').textContent = customCity;
              document.getElementById('city-hidden-input').value = customCity;
              cityDropdown.classList.add('hidden');
              document.getElementById('apply_filters').click();
          }
      });

      // Обработчик Enter в основном поле
      cityInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
              e.preventDefault();
              document.getElementById('apply_filters').click();
          }
      });

      // Обработчик для выбора станций метро
      const metroInput = document.getElementById('metro-input');
      const metroDropdown = document.getElementById('metro-dropdown');
      const metroSearch = document.getElementById('metro-search');
      const closeMetroModal = document.getElementById('close-metro-modal');
      const applyMetroBtn = document.getElementById('apply-metro-selection');
      const clearMetroBtn = document.getElementById('clear-metro-selection');
      const metroHiddenInput = document.getElementById('metro-hidden-input');
      const selectedMetroText = document.getElementById('selected-metro-text');

      let selectedStations = [];

      // Инициализация выбранных станций
      if (metroHiddenInput.value) {
          selectedStations = metroHiddenInput.value.split(',');
      }

      // Открытие модального окна
      metroInput.addEventListener('click', function(e) {
          e.preventDefault();
          metroDropdown.classList.remove('hidden');
          metroSearch.focus();
          updateSelectedStationsInModal();
      });

      // Закрытие модального окна
      closeMetroModal.addEventListener('click', function() {
          metroDropdown.classList.add('hidden');
      });

      // Закрытие при клике вне контента
      metroDropdown.addEventListener('click', function(e) {
          if (e.target === metroDropdown) {
              metroDropdown.classList.add('hidden');
          }
      });

      // Поиск станций
  metroSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();

    document.querySelectorAll('.metro-line-section').forEach(section => {
        const header = section.querySelector('.metro-line-header');
        const stationsContainer = section.querySelector('.metro-stations-container');
        let hasVisibleStations = false;

        // Показываем/скрываем станции
        section.querySelectorAll('.metro-station-option').forEach(option => {
            const stationName = option.querySelector('.metro-station-name').textContent.toLowerCase();
            if (stationName.includes(searchTerm)) {
                option.classList.remove('hidden');
                hasVisibleStations = true;
            } else {
                option.classList.add('hidden');
            }
        });

        // Показываем/скрываем всю линию
        if (searchTerm.length > 0) {
            if (hasVisibleStations) {
                section.classList.remove('hidden');
                header.classList.add('expanded');
                stationsContainer.classList.add('expanded');
                header.querySelector('.bi-chevron-down').classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
            }
        } else {
            section.classList.remove('hidden');
            header.classList.remove('expanded');
            stationsContainer.classList.remove('expanded');
            header.querySelector('.bi-chevron-down').classList.remove('rotate-180');
        }
    });
});

      // Выбор/отмена выбора станции
       document.addEventListener('click', function(e) {
      if (e.target.closest('.metro-station-option')) {
          const option = e.target.closest('.metro-station-option');
          const station = option.querySelector('.metro-station-name').textContent;

          if (selectedStations.includes(station)) {
              selectedStations = selectedStations.filter(s => s !== station);
              option.classList.remove('selected');
          } else {
              if (selectedStations.length < 5) {
                  selectedStations.push(station);
                  option.classList.add('selected');
              } else {
                  alert('Можно выбрать не более 5 станций');
              }
          }
      }
  });

      // Очистка выбора
      clearMetroBtn.addEventListener('click', function() {
          selectedStations = [];
          updateSelectedStationsInModal();
      });

      // Применение выбора
      applyMetroBtn.addEventListener('click', function() {
          metroHiddenInput.value = selectedStations.join(',');
          updateSelectedStationsText();
          metroDropdown.classList.add('hidden');
          document.getElementById('apply_filters').click();
      });

      // Обновление отображения выбранных станций в модальном окне
      function updateSelectedStationsInModal() {
          document.querySelectorAll('.metro-station-option').forEach(option => {
              const station = option.getAttribute('data-station');
              if (selectedStations.includes(station)) {
                  option.classList.add('bg-blue-100', 'border-blue-500');
                  option.classList.remove('border-gray-200', 'hover:bg-gray-50');
              } else {
                  option.classList.remove('bg-blue-100', 'border-blue-500');
                  option.classList.add('border-gray-200', 'hover:bg-gray-50');
              }
          });
      }

      // Обновите функцию updateSelectedStationsText:
  function updateSelectedStationsText() {
      const selectedStations = metroHiddenInput.value ?
          metroHiddenInput.value.split(',') : [];

      if (selectedStations.length === 0) {
          selectedMetroText.innerHTML = 'Выберите станции метро';
          return;
      }

      let html = '';
      selectedStations.slice(0, 3).forEach(station => {
          html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      ${station}
                  </span>`;
      });

      if (selectedStations.length > 3) {
          html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                      +${selectedStations.length - 3}
                  </span>`;
      }

      selectedMetroText.innerHTML = html;
  }

      // Инициализация текста при загрузке
      updateSelectedStationsText();
  });

  // Обновляем статус карты в интерфейсе
  function updateMapStatus(status) {
      const statusElement = document.getElementById('map-status-text');
      if (statusElement) {
          statusElement.textContent = status;

          // Добавляем цвет в зависимости от статуса
          if (status.includes('успешно')) {
              statusElement.style.color = 'green';
          } else if (status.includes('ошибка')) {
              statusElement.style.color = 'red';
          } else {
              statusElement.style.color = 'orange';
          }
      }
  }
// Функция для переключения видимости станций метро
// Функция для переключения видимости станций метро
function toggleMetroLine(header) {
    const lineSection = header.closest('.metro-line-section');
    const stationsContainer = lineSection.querySelector('.metro-stations-container');
    const chevron = header.querySelector('.bi-chevron-down');
    const linesContainer = document.querySelector('.metro-lines-container');

    // Получаем текущее состояние (до изменения)
    const wasExpanded = header.classList.contains('expanded');

    // Закрываем все другие открытые линии
    document.querySelectorAll('.metro-line-section').forEach(section => {
        if (section !== lineSection) {
            section.querySelector('.metro-stations-container').style.maxHeight = '0';
            section.querySelector('.metro-line-header').classList.remove('expanded');
            section.querySelector('.bi-chevron-down').classList.remove('rotate-180');
        }
    });

    // Переключаем текущую линию
    if (!wasExpanded) {
        stationsContainer.style.maxHeight = '300px';
        header.classList.add('expanded');
        chevron.classList.add('rotate-180');

        // Прокручиваем контейнер так, чтобы заголовок оставался видимым
        const containerRect = linesContainer.getBoundingClientRect();
        const headerRect = header.getBoundingClientRect();

        // Если заголовок близко к верху, прокручиваем немного вниз
        if (headerRect.top < containerRect.top + 50) {
            linesContainer.scrollBy({
                top: headerRect.top - containerRect.top - 50,
                behavior: 'smooth'
            });
        }
    } else {
        stationsContainer.style.maxHeight = '0';
        header.classList.remove('expanded');
        chevron.classList.remove('rotate-180');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Открываем линии с выбранными станциями
    const selectedStations = document.getElementById('metro-hidden-input').value
        ? document.getElementById('metro-hidden-input').value.split(',')
        : [];

    if (selectedStations.length > 0) {
        document.querySelectorAll('.metro-station-option').forEach(option => {
            if (selectedStations.includes(option.getAttribute('data-station'))) {
                const lineSection = option.closest('.metro-line-section');
                const stationsContainer = lineSection.querySelector('.metro-stations-container');
                const header = lineSection.querySelector('.metro-line-header');

                header.classList.add('expanded');
                stationsContainer.style.maxHeight = '300px';
                lineSection.querySelector('.bi-chevron-down').classList.add('rotate-180');
            }
        });
    }


    // Обработчик выбора станции
    document.addEventListener('click', function(e) {
        const stationOption = e.target.closest('.metro-station-option');
        if (stationOption) {
            e.preventDefault();
            const station = stationOption.getAttribute('data-station');
            let selectedStations = document.getElementById('metro-hidden-input').value
                ? document.getElementById('metro-hidden-input').value.split(',')
                : [];

            if (selectedStations.includes(station)) {
                // Удаляем станцию
                selectedStations = selectedStations.filter(s => s !== station);
                stationOption.classList.remove('bg-blue-100', 'text-blue-800');
                stationOption.classList.add('hover:bg-gray-200');
            } else {
                // Добавляем станцию (максимум 5)
                if (selectedStations.length < 5) {
                    selectedStations.push(station);
                    stationOption.classList.add('bg-blue-100', 'text-blue-800');
                    stationOption.classList.remove('hover:bg-gray-200');
                } else {
                    alert('Можно выбрать не более 5 станций');
                    return;
                }
            }

            document.getElementById('metro-hidden-input').value = selectedStations.join(',');
            updateSelectedStationsText();
        }
    });

    function updateSelectedStationsText() {
        const selectedStations = document.getElementById('metro-hidden-input').value
            ? document.getElementById('metro-hidden-input').value.split(',')
            : [];
        const selectedMetroText = document.getElementById('selected-metro-text');

        if (selectedStations.length === 0) {
            selectedMetroText.innerHTML = 'Выберите станции метро';
            return;
        }

        let html = '';
        selectedStations.slice(0, 3).forEach(station => {
            html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">
                        ${station}
                    </span>`;
        });

        if (selectedStations.length > 3) {
            html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        +${selectedStations.length - 3}
                    </span>`;
        }

        selectedMetroText.innerHTML = html;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Открываем линии с выбранными станциями
    const selectedStations = document.getElementById('metro-hidden-input').value
        ? document.getElementById('metro-hidden-input').value.split(',')
        : [];

    if (selectedStations.length > 0) {
        document.querySelectorAll('.metro-station-option').forEach(option => {
            if (selectedStations.includes(option.getAttribute('data-station'))) {
                const lineSection = option.closest('.metro-line-section');
                const stationsContainer = lineSection.querySelector('.metro-stations-container');
                const header = lineSection.querySelector('.metro-line-header');

                header.classList.add('expanded');
                stationsContainer.style.maxHeight = stationsContainer.scrollHeight + 'px';
                lineSection.querySelector('.bi-chevron-down').classList.add('rotate-180');
            }
        });
    }
});
</script>


{% endblock %}