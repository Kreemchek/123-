{% extends 'base.html' %}
{% load custom_filters %}

{% block extra_head %}
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ */
.property-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    overflow: hidden;
    background: white;
}

.property-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1);
    border-color: #bfdbfe;
}

.btn-primary {
    @apply bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2;
}

.toggle-favorite {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.toggle-favorite:hover {
    transform: scale(1.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –∫–∞—Ä—Ç—ã */
.filter-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
}

@media (max-width: 1024px) {
    .filter-container {
        grid-template-columns: 1fr;
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-sidebar {
    background: white;
    padding: 1.75rem;
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    border: 2px solid #e5e7eb;
    height: fit-content;
    position: sticky;
    top: 1rem;
    transition: all 0.3s ease;
}

.filter-sidebar:hover {
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
    border-color: #d1d5db;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 0.75rem;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    animation: slideIn 0.3s ease-out forwards;
    opacity: 0;
}

.filter-section:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-15px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* –ó–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
.filter-section:nth-child(1) { animation-delay: 0.1s; }
.filter-section:nth-child(2) { animation-delay: 0.2s; }
.filter-section:nth-child(3) { animation-delay: 0.3s; }
.filter-section:nth-child(4) { animation-delay: 0.4s; }
.filter-section:nth-child(5) { animation-delay: 0.5s; }
.filter-section:nth-child(6) { animation-delay: 0.6s; }
.filter-section:nth-child(7) { animation-delay: 0.7s; }
.filter-section:nth-child(8) { animation-delay: 0.8s; }
.filter-section:nth-child(9) { animation-delay: 0.9s; }
.filter-section:nth-child(10) { animation-delay: 1.0s; }

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
.filter-section h3 {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    color: #111827;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.75rem;
    position: relative;
    transition: color 0.2s;
}

.filter-section:hover h3 {
    color: #1e40af;
}

.filter-section h3::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 50px;
    height: 2px;
    background: #3b82f6;
    transition: width 0.3s ease;
}

.filter-section:hover h3::after {
    width: 80px;
}

/* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
.filter-section input[type="text"],
.filter-section input[type="number"],
.filter-section select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #d1d5db;
    border-radius: 0.75rem;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #374151;
    background: white;
    transition: all 0.3s ease;
}

.filter-section input[type="text"]:focus,
.filter-section input[type="number"]:focus,
.filter-section select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    outline: none;
}

.filter-section input[type="text"]:hover,
.filter-section input[type="number"]:hover,
.filter-section select:hover {
    border-color: #9ca3af;
}

/* –°–µ—Ç–∫–∞ –¥–ª—è –¥–≤–æ–π–Ω—ã—Ö –ø–æ–ª–µ–π */
.filter-section .grid-cols-2 {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
}

/* –õ–µ–π–±–ª—ã */
.filter-section label {
    display: block;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 0.5rem;
    transition: color 0.2s;
}

.filter-section:hover label {
    color: #111827;
}

/* –ß–µ–∫–±–æ–∫—Å—ã –∏ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ */
.filter-section .flex.items-center {
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
    margin-bottom: 0.5rem;
}

.filter-section .flex.items-center:hover {
    background: rgba(59, 130, 246, 0.05);
}

.filter-section .flex.items-center input[type="checkbox"],
.filter-section .flex.items-center input[type="radio"] {
    margin-right: 0.75rem;
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    transition: all 0.2s;
    cursor: pointer;
}

.filter-section .flex.items-center input[type="checkbox"]:checked,
.filter-section .flex.items-center input[type="radio"]:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.filter-section .flex.items-center label {
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: color 0.2s;
}

.filter-section .flex.items-center:hover label {
    color: #1e40af;
}

/* –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

#apply_filters {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

#apply_filters:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15);
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

#apply_filters:active {
    transform: translateY(0);
}

#reset_filters {
    background: white;
    color: #374151;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 700;
    border: 2px solid #d1d5db;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

#reset_filters:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    border-color: #9ca3af;
    background: #f9fafb;
}

#reset_filters:active {
    transform: translateY(0);
}

/* –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.filter-actions button i {
    font-size: 1.1em;
    transition: transform 0.3s ease;
}

#apply_filters:hover i {
    transform: rotate(5deg) scale(1.1);
}

#reset_filters:hover i {
    transform: rotate(-5deg) scale(1.1);
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-section:has(input:not([value=""])) {
    background: #f0f7ff;
    border-color: #bfdbfe;
}

.filter-section:has(input:not([value=""])) h3 {
    color: #1e40af;
}

.filter-section:has(input:not([value=""])) h3::after {
    background: #1e40af;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
.map-container-wrapper {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    border: 2px solid #e5e7eb;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
}

#all-properties-map {
    width: 100%;
    height: 500px;
    display: block;
    transition: height 0.3s ease;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã */
.map-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
    border-radius: 16px;
}

.map-loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1e40af;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã –∏ –ø–æ–∏—Å–∫–∞ */
.map-search-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
.search-add-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

@media (min-width: 768px) {
    .search-add-container {
        flex-direction: row;
        align-items: center;
    }
}

.search-form {
    flex-grow: 1;
    max-width: calc(100% - 180px);
}

@media (max-width: 768px) {
    .search-add-container {
        flex-direction: column;
    }
    .search-form {
        max-width: 100%;
        width: 100%;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 2rem;
}

.page-item {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
}

.page-item:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.page-item.bg-blue-600 {
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–æ—Ä–æ–¥–æ–≤ */
#city-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    padding: 2rem;
    overflow-y: auto;
    backdrop-filter: blur(5px);
    display: none;
}

#city-dropdown > .container {
    background-color: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 800px;
    margin: 2rem auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.city-search-container {
    background-color: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#city-search:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.city-option {
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 1.125rem;
    transition: all 0.2s ease;
    text-align: left;
    background: white;
}

.city-option:hover {
    background-color: #f0f7ff;
    border-color: #bfdbfe;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.city-option.hidden {
    display: none;
}

#close-city-modal {
    font-size: 1.8rem;
    line-height: 1;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0 0.5rem;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ */
/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ—Ç—Ä–æ */
#metro-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.metro-dropdown-container {
    background-color: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.metro-dropdown-header {
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

.metro-dropdown-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.metro-dropdown-footer {
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ª–∏–Ω–∏–π –∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ */
.metro-lines-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
}

.metro-line-section {
    border: none !important; /* –£–±–∏—Ä–∞–µ–º –æ–±–≤–æ–¥–∫—É */
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 8px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏ */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é —Ç–µ–Ω—å –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
}

.metro-line-header {
    padding: 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
    background-color: white;
}

.metro-line-header:hover {
    background-color: #f9fafb;
}

.metro-line-header .metro-line-color {
    width: 4px;
    height: 16px;
    border-radius: 0;
    margin-right: 10px;
    flex-shrink: 0;
}

.metro-stations-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.metro-stations-container.expanded {
    max-height: 300px;
}

.metro-station-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    width: 100%;
    cursor: pointer;
    background-color: white;
    border: none;
    text-align: left;
}

.metro-station-option:hover {
    background-color: #f3f4f6;
}

.metro-station-option.selected {
    background-color: #3b82f6;
    color: white;
}

.metro-station-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.metro-line-name {
    font-weight: 600;
    font-size: 0.25rem;!important;
    flex-grow: 1;
}

.metro-station-option {
    display: flex;
    align-items: center;
    padding: 0.6rem 1rem;
    width: 100%;
    text-align: left;
    background: white;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f3f4f6;
     margin-bottom: 0;
}

.metro-station-option:last-child {
    border-bottom: none;
}

.metro-station-option:hover {
    background-color: #f0f7ff;
}

.metro-station-option.selected {
    background-color: #3b82f6 !important;
    color: white !important;
}

.metro-station-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.metro-station-name {
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
.metro-lines-container::-webkit-scrollbar,
.metro-stations-container::-webkit-scrollbar {
    width: 6px;
}

.metro-lines-container::-webkit-scrollbar-track,
.metro-stations-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.metro-lines-container::-webkit-scrollbar-thumb,
.metro-stations-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.metro-lines-container::-webkit-scrollbar-thumb:hover,
.metro-stations-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.metro-stations-container.expanded {
    animation: slideDown 0.2s ease-out;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 768px) {
    .metro-lines-container {
        max-height: calc(100vh - 150px);
    }

    .metro-line-header {
        padding: 0.75rem;
    }

    .metro-station-option {
        padding: 0.5rem 0.75rem;
    }

    .metro-stations-container.expanded {
        max-height: 250px;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
.metro-search-container {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ */
.metro-dropdown-footer {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    z-index: 10;
}

.metro-action-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

#apply-metro-selection {
    background: #3b82f6;
    color: white;
    border: none;
}

#apply-metro-selection:hover {
    background: #2563eb;
}

#clear-metro-selection {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
}

#clear-metro-selection:hover {
    background: #f3f4f6;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 1024px) {
    .filter-toggle {
        display: block;
        margin-bottom: 1.5rem;
        width: 100%;
    }

    .filter-sidebar {
        display: none;
    }

    .filter-sidebar.active {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
}

@media (max-width: 768px) {
    .sticky-column {
        position: relative;
        top: auto;
    }

    .filter-section {
        padding: 1rem;
    }

    .filter-actions {
        flex-direction: column;
    }
}
#metro-dropdown .metro-line-header .metro-line-color {
    width: 4px !important;
    height: 16px !important;
    border-radius: 0 !important;
    margin-right: 10px !important;
    flex-shrink: 0 !important;
}

#metro-dropdown .metro-station-option .metro-station-color {
    width: 3px !important;
    height: 12px !important;
    border-radius: 0 !important;
    margin-right: 8px !important;
    flex-shrink: 0 !important;
}
#metro-dropdown .metro-line-section {
    border: none !important;
}
/* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ª–∏–Ω–∏–π */
.metro-line-header .metro-line-name {
    font-size: 0.85rem !important;
    font-weight: 600 !important;
}

.checkbox-section {
    margin-bottom: 10rem !important;
    padding-bottom: 1.5rem !important;
}

/* –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö –û–ë–™–ï–ö–¢–û–í */
.listings {
    margin-top: 18px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 18px;
}

.card {
    border-radius: 14px !important;
    padding: 12px !important;
    background: white !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
    display: flex !important;
    gap: 12px !important;
    align-items: flex-start !important;
    transition: transform 0.3s ease, box-shadow 0.3s ease !important;
    text-decoration: none !important;
    color: inherit !important;
}

.card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12) !important;
    text-decoration: none !important;
    color: inherit !important;
}

.thumb {
    width: 150px !important;
    height: 110px !important;
    border-radius: 10px !important;
    flex-shrink: 0 !important;
    background-size: cover !important;
    background-position: center !important;
    border: 1px solid rgba(0,0,0,0.06) !important;
}

.meta {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 6px !important;
}

.meta .type {
    font-size: 12px !important;
    color: #64748b !important;
    margin: 0 !important;
}

.meta h3 {
    margin: 0 !important;
    font-size: 16px !important;
    color: #1e293b !important;
}

.meta .meta-row {
    display: flex !important;
    gap: 10px !important;
    align-items: center !important;
    color: #64748b !important;
    font-size: 13px !important;
    margin: 0 !important;
}

.price {
    font-weight: 800 !important;
    font-size: 16px !important;
    color: #7b61ff !important;
}

.btn {
    background: white !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    padding: 8px 12px !important;
    border-radius: 8px !important;
    color: #64748b !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    font-size: 12px !important;
    transition: all 0.2s ease !important;
    text-decoration: none !important;
    display: inline-block !important;
}

.btn:hover {
    background: rgba(0,0,0,0.02) !important;
}

.toggle-favorite {
    background: none !important;
    border: none !important;
    cursor: pointer !important;
    color: #9ca3af !important;
    transition: color 0.2s ease !important;
    padding: 4px !important;
}

.toggle-favorite:hover {
    color: #ef4444 !important;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
@media (max-width: 768px) {
    .listings {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }

    .card {
        flex-direction: column !important;
    }

    .thumb {
        width: 100% !important;
        height: 200px !important;
    }
}
/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –∏–∑ filtry.html */
:root{
  --bg: #f8fafc; /* light background */
  --panel: #ffffff; /* card background */
  --muted: #64748b;
  --text: #1e293b;
  --accent-1: linear-gradient(135deg,#7b61ff 0%, #36d1dc 100%);
  --glass: rgba(0,0,0,0.04);
  --glass-2: rgba(0,0,0,0.02);
  --glass-3: rgba(0,0,0,0.06);
  --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
  --glass-border: rgba(0,0,0,0.08);
  --success: #10b981;
  --danger: #ef4444;
  --glass-border-2: rgba(0,0,0,0.06);
  --glass-highlight: rgba(0,0,0,0.02);
}

*{box-sizing:border-box}
html,body{height:100%}
body.properties-page{
  margin:0;
  background: radial-gradient(1200px 600px at 10% 10%, rgba(55,102,255,0.04), transparent),
              radial-gradient(900px 450px at 95% 80%, rgba(54,209,220,0.03), transparent),
              var(--bg);
  color:var(--text);
  font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:28px;
}

/* layout */
.properties-page .shell{
  max-width:1320px;
  margin:0 auto;
  display:grid;
  grid-template-columns:320px 1fr;
  gap:28px;
  align-items:start;
}

.properties-page header.topbar{
  grid-column:1 / -1;
  display:flex;
  gap:18px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}

.properties-page .brand{
  display:flex;align-items:center;gap:12px
}
.properties-page .logo{
  width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#6f53ff,#2bd7db);
  display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(77,52,255,0.15);
  font-weight:800;color:white;font-family:Manrope;font-size:18px
}
.properties-page .brand h1{font-size:18px;margin:0;color:var(--text)}
.properties-page .brand p{margin:0;color:var(--muted);font-size:13px}

/* top search */
.properties-page .searchbar{
  flex:1;max-width:820px;display:flex;align-items:center;gap:12px;background:white;
  border-radius:12px;padding:10px 14px;border:1px solid var(--glass-border);
  box-shadow: var(--card-shadow);
}
.properties-page .searchbar input{flex:1;background:transparent;border:0;color:var(--text);font-size:15px;padding:10px;outline:none}
.properties-page .search-actions{display:flex;gap:8px}
.properties-page .btn{
  background:white;
  border:1px solid var(--glass-border);
  padding:10px 14px;border-radius:10px;color:var(--muted);font-weight:600;cursor:pointer;font-size:14px;
  transition: all 0.2s ease;
}
.properties-page .btn:hover{
  background:var(--glass-highlight);
}
.properties-page .btn-accent{
  background:var(--accent-1);border:0;color:white;padding:10px 16px;border-radius:12px;font-weight:700;box-shadow:0 6px 30px rgba(99,72,255,0.15);
}
.properties-page .btn-accent:hover{
  transform: translateY(-1px);
  box-shadow:0 8px 35px rgba(99,72,255,0.2);
}

/* left filters */
.properties-page aside.filters{
  background:white;padding:18px;border-radius:16px;border:1px solid var(--glass-border-2);
  position:sticky;top:28px;height:calc(100vh - 56px);overflow:auto;box-shadow:var(--card-shadow)
}
.properties-page aside h2{font-size:16px;margin:0 0 10px 0;color:var(--text)}
.properties-page .filter-group{background:var(--glass-highlight);border-radius:12px;padding:12px;margin-bottom:12px;border:1px solid var(--glass-border)}
.properties-page label.field{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.properties-page select,.properties-page input[type=text],.properties-page input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:white;color:var(--text);font-size:14px}
.properties-page .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.properties-page .range{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.properties-page .checkbox-row{display:flex;flex-wrap:wrap;gap:8px}
.properties-page .chip{padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);font-size:13px;background:white;color:var(--muted);cursor:pointer;transition: all 0.2s ease;}
.properties-page .chip:hover{
  border-color: #7b61ff;
  color: #7b61ff;
}
.properties-page .chip.active{background:linear-gradient(90deg,#3aa7ff22,#6f53ff22);border:1px solid rgba(120,110,255,0.3);color:#4c37d4}

.properties-page .filters-footer{display:flex;gap:8px;position:sticky;bottom:18px;padding-top:8px;background:linear-gradient(180deg, transparent, rgba(255,255,255,0.9));}

/* main content */
.properties-page main.content{min-height:60vh}
.properties-page .map{
  border-radius:16px;height:320px;background:linear-gradient(135deg, rgba(120,80,255,0.06), rgba(54,209,220,0.04));border:1px solid var(--glass-border);display:flex;flex-direction:column;overflow:hidden;position:relative;box-shadow:var(--card-shadow)
}
.properties-page .map .placeholder{
  display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;color:var(--muted);
  background:repeating-linear-gradient(45deg, rgba(0,0,0,0.02) 0 2px, transparent 2px 6px);
}
.properties-page .map .placeholder .title{font-size:18px;font-weight:700;color:var(--text)}
.properties-page .map .controls{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px}
.properties-page .map .pin{width:48px;height:48px;border-radius:12px;background:var(--accent-1);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}

.properties-page .listings{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:18px}
.properties-page .card{
  border-radius:14px;padding:12px;background:white;border:1px solid var(--glass-border);box-shadow:var(--card-shadow);display:flex;gap:12px;align-items:flex-start;transition:transform .24s cubic-bezier(.2,.9,.3,1),box-shadow .24s
}
.properties-page .card:hover{transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,0,0,0.12)}
.properties-page .thumb{width:150px;height:110px;border-radius:10px;flex-shrink:0;background-size:cover;background-position:center;border:1px solid rgba(0,0,0,0.06)}
.properties-page .meta{flex:1;display:flex;flex-direction:column;gap:6px}
.properties-page .meta .type{font-size:12px;color:var(--muted)}
.properties-page .meta h3{margin:0;font-size:16px;color:var(--text)}
.properties-page .meta .meta-row{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
.properties-page .price{font-weight:800;font-size:16px;color:#7b61ff}
.properties-page .badge{padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03);border:1px solid var(--glass-border);font-size:12px;color:var(--muted)}
.properties-page .card .actions{display:flex;gap:8px;align-items:center}

.properties-page footer.lic{grid-column:1 / -1;margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;align-items:center}

/* tiny responsiveness */
@media (max-width:980px){
  .properties-page .shell{grid-template-columns:1fr;}
  .properties-page aside.filters{position:relative;height:auto}
  .properties-page header.topbar{flex-direction:column;align-items:flex-start;gap:12px}
  .properties-page .searchbar{max-width:100%}
}

/* micro interactions */
.properties-page .pulse{animation:pulse 4s infinite}
@keyframes pulse{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}

/* nice scrollbar for filters */
.properties-page aside.filters::-webkit-scrollbar{width:10px}
.properties-page aside.filters::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1);border-radius:10px;border:2px solid transparent;background-clip:padding-box}
.properties-page aside.filters::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0.2);border-radius:10px;border:2px solid transparent;background-clip:padding-box}
.properties-page aside.filters::-webkit-scrollbar-track{background:transparent}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 980px) {
    .properties-page .filter-toggle {
        display: block;
        margin-bottom: 1rem;
        width: 100%;
        padding: 12px;
        background: var(--accent-1);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
    }

    .properties-page aside.filters {
        display: none;
        margin-bottom: 1rem;
    }

    .properties-page aside.filters.active {
        display: block;
        animation: slideDown 0.3s ease-out;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
.properties-page .icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    vertical-align: middle;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.properties-page .loading {
    opacity: 0.7;
    pointer-events: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.properties-page .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 18px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 4px solid var(--success);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1000;
}

.properties-page .notification.show {
    transform: translateX(0);
}

.properties-page .notification.error {
    border-left-color: var(--danger);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.properties-page .selected-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.properties-page .selected-filter {
    background: linear-gradient(90deg,#3aa7ff22,#6f53ff22);
    border: 1px solid rgba(120,110,255,0.3);
    color: #4c37d4;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.properties-page .selected-filter button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-weight: bold;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.properties-page .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
}

.properties-page .empty-state h3 {
    margin-bottom: 10px;
    color: var(--text);
}

.properties-page .empty-state p {
    margin-bottom: 20px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫–µ–ª–µ—Ç–æ–Ω–∞ (–∑–∞–≥—Ä—É–∑–∫–∞) */
.properties-page .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

.properties-page .card.skeleton .thumb {
    background: #f0f0f0;
}

.properties-page .card.skeleton .meta h3 {
    height: 20px;
    margin-bottom: 10px;
}

.properties-page .card.skeleton .meta .type {
    height: 14px;
    width: 60%;
    margin-bottom: 8px;
}

.properties-page .card.skeleton .meta .price {
    height: 18px;
    width: 40%;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö */
.properties-page .filter-accordion {
    margin-bottom: 12px;
}

.properties-page .filter-accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
}

.properties-page .filter-accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.properties-page .filter-accordion.active .filter-accordion-content {
    max-height: 500px;
}

.properties-page .filter-accordion-header::after {
    content: "‚ñº";
    font-size: 10px;
    transition: transform 0.3s ease;
}

.properties-page .filter-accordion.active .filter-accordion-header::after {
    transform: rotate(180deg);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤ –∫–Ω–æ–ø–∫–∞—Ö */
.properties-page .btn i {
    margin-right: 6px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
@media (prefers-color-scheme: dark) {
    .properties-page {
        --bg: #0f172a;
        --panel: #1e293b;
        --muted: #94a3b8;
        --text: #f1f5f9;
        --glass: rgba(255,255,255,0.04);
        --glass-2: rgba(255,255,255,0.02);
        --glass-3: rgba(255,255,255,0.06);
        --card-shadow: 0 4px 20px rgba(0,0,0,0.2);
        --glass-border: rgba(255,255,255,0.08);
        --glass-border-2: rgba(255,255,255,0.06);
        --glass-highlight: rgba(255,255,255,0.02);
    }

    .properties-page body {
        background: radial-gradient(1200px 600px at 10% 10%, rgba(55,102,255,0.08), transparent),
                    radial-gradient(900px 450px at 95% 80%, rgba(54,209,220,0.06), transparent),
                    var(--bg);
    }

    .properties-page .searchbar,
    .properties-page aside.filters,
    .properties-page .card,
    .properties-page .btn {
        background: var(--panel);
        border-color: var(--glass-border);
    }

    .properties-page .chip {
        background: var(--panel);
    }

    .properties-page .badge {
        background: rgba(255,255,255,0.05);
    }

    .properties-page .map .placeholder {
        background: repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0 2px, transparent 2px 6px);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.properties-page ::-webkit-scrollbar {
    width: 8px;
}

.properties-page ::-webkit-scrollbar-track {
    background: transparent;
}

.properties-page ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

.properties-page ::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.2);
}

@media (prefers-color-scheme: dark) {
    .properties-page ::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
    }

    .properties-page ::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.2);
    }
}
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ */
    .search-container input:focus ~ .search-gradient-border {
        opacity: 1;
        animation: pulse-glow 2s infinite;
    }

    .search-container input:focus ~ .search-hints {
        opacity: 1;
    }

    @keyframes pulse-glow {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }

    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
    .search-container input::placeholder {
        transition: color 0.3s ease;
    }

    .search-container input:focus::placeholder {
        color: transparent;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .search-container input {
            padding: 14px 16px;
            font-size: 16px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        .search-hints {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        .search-container button {
            padding: 10px;
        }
    }
/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
.search-container input:focus ~ .search-gradient-border {
    opacity: 1;
    animation: pulse-glow 2s infinite;
    transform: scale(1.02);
}

.search-container input:focus ~ .search-hints {
    opacity: 1;
    transform: translateY(5px);
}

@keyframes pulse-glow {
    0% {
        opacity: 0.7;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    50% {
        opacity: 1;
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
    }
    100% {
        opacity: 0.7;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
}

/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã */
.search-container input::placeholder {
    transition: all 0.3s ease;
}

.search-container input:focus::placeholder {
    color: transparent;
    transform: translateY(-5px);
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞ */
.search-container:hover .search-gradient-border {
    opacity: 0.3;
}

.search-container:hover input {
    transform: translateY(-1px);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 1024px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .bg-gradient-to-r {
        padding: 1.5rem;
    }

    .search-container input {
        padding: 1rem 1.25rem;
        font-size: 1rem;
    }

    .search-hints {
        display: none;
    }

    .text-4xl {
        font-size: 2rem;
    }
}

@media (max-width: 768px) {
    .flex-col {
        gap: 1.5rem;
    }

    .search-container input {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
    }

    .btn-primary {
        padding: 0.875rem 1.5rem;
        font-size: 0.95rem;
    }
}

/* –ú–∏–∫—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ */
.search-container button:hover i {
    animation: bounce 0.6s ease;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
.gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.mobile-filters-sidebar {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
}

.mobile-filters-sidebar::-webkit-scrollbar {
    width: 6px;
}

.mobile-filters-sidebar::-webkit-scrollbar-track {
    background: #f7fafc;
}

.mobile-filters-sidebar::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.mobile-filter-content {
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
}

.mobile-filter-content:not(.hidden) {
    max-height: 500px;
}

.rotate-180 {
    transform: rotate(180deg);
}

/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 1023px) {
    .filter-sidebar {
        display: none !important;
    }

    .filter-toggle {
        display: none !important;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å */
    .properties-page .filter-toggle {
        display: none !important;
    }
}

/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞ –ü–ö –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é —Å–∫—Ä—ã—Ç–æ */
@media (min-width: 1024px) {
    .mobile-filters-overlay,
    .mobile-filters-sidebar {
        display: none !important;
    }

    #mobile-filters-btn {
        display: none !important;
    }
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
#mobile-city-dropdown,
#mobile-metro-dropdown {
    z-index: 9999 !important; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º z-index */
    position: fixed !important;
}
/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Ç–∞–∫–∂–µ –∏–º–µ—é—Ç –≤—ã—Å–æ–∫–∏–π z-index */
#mobile-city-dropdown > div,
#mobile-metro-dropdown > div {
    z-index: 10000 !important;
    position: relative;
}
#mobile-city-dropdown .city-option,
#mobile-metro-dropdown .metro-station-option {
    padding: 1rem;
    font-size: 1rem;
}

#mobile-metro-dropdown .metro-line-section {
    margin-bottom: 0.5rem;
}

#mobile-metro-dropdown .metro-stations-container {
    transition: max-height 0.3s ease;
    overflow: hidden;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
@media (max-width: 640px) {
    #mobile-city-dropdown,
    #mobile-metro-dropdown {
        padding: 0.5rem;
    }

    #mobile-city-dropdown .city-option,
    #mobile-metro-dropdown .metro-station-option {
        padding: 0.75rem;
        font-size: 0.9rem;
    }
}
/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 1023px) {
    .filter-sidebar {
        display: none !important;
    }

    .filter-toggle {
        display: none !important;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å */
    .properties-page .filter-toggle {
        display: none !important;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å aside —Å –ü–ö —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ */
    aside.w-full.lg\\:w-80 {
        display: none !important;
    }
}

/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞ –ü–ö –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é —Å–∫—Ä—ã—Ç–æ */
@media (min-width: 1024px) {
    .mobile-filters-overlay,
    .mobile-filters-sidebar {
        display: none !important;
    }

    #mobile-filters-btn {
        display: none !important;
    }
}
/* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 1023px) {
    #mobile-filters-btn {
        font-size: 18px !important;
        padding: 16px 20px !important;
        height: auto !important;
        min-height: 60px !important;
    }

    #mobile-filters-btn svg {
        width: 24px !important;
        height: 24px !important;
    }

    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    #mobile-filters-btn .bg-red-500 {
        width: 28px !important;
        height: 28px !important;
        font-size: 14px !important;
        margin-left: 8px !important;
    }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 640px) {
    #mobile-filters-btn {
        font-size: 20px !important;
        padding: 18px 22px !important;
        min-height: 65px !important;
    }

    #mobile-filters-btn svg {
        width: 26px !important;
        height: 26px !important;
        margin-right: 12px !important;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
{% endblock %}

{% block content %}
<body class="properties-page">
<div class="container mx-auto px-4 py-6">

    <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
    <div class="mb-8">
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 shadow-lg border border-blue-100/50">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="text-center lg:text-left">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
                        {% if user.is_authenticated and user.is_broker %}
                            –ú–æ–∏ –æ–±—ä–µ–∫—Ç—ã
                        {% else %}
                            –ö–∞—Ç–∞–ª–æ–≥ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
                        {% endif %}
                    </h1>
                    <p class="text-gray-600 text-lg">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å —Å—Ä–µ–¥–∏ —Ç—ã—Å—è—á –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>
                </div>

                <!-- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
                <div class="w-full lg:w-auto flex-1 max-w-2xl">
                    <form class="search-form relative">
                        <div class="relative">
                            <div class="search-container relative">
                                <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ -->
                                <div class="search-gradient-border absolute inset-0 rounded-2xl bg-gradient-to-r from-blue-500 via-purple-500 to-cyan-500 p-0.5 opacity-0 transition-all duration-500"></div>

                                <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
                                <input type="search"
                                       name="search"
                                       placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ª–æ–∫–∞—Ü–∏–∏, —Ü–µ–Ω–µ –∏–ª–∏ —Ç–∏–ø—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏..."
                                       class="w-full h-full px-6 py-5 rounded-2xl border-0 bg-white/95 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-blue-200/50 shadow-xl transition-all duration-300 relative z-10 text-lg">

                                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
                                <button type="submit"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-xl shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300/50 z-20">
                                    <i class="bi bi-search text-xl"></i>
                                </button>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                                <div class="search-hints absolute -bottom-10 left-0 right-0 flex justify-center gap-4 text-sm text-gray-600 opacity-0 transition-all duration-500 pointer-events-none">
                                    <span class="bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full">–∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ</span>
                                    <span class="bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full">—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω</span>
                                    <span class="bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                {% if user.is_authenticated and user.is_broker %}
                    <div class="lg:flex-shrink-0">
                        <a href="{% url 'properties:select-listing-type' %}"
                           class="btn-primary flex items-center justify-center gap-3 whitespace-nowrap px-8 py-5 rounded-2xl transition-all duration-300 hover:scale-105 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold shadow-xl hover:shadow-2xl text-lg">
                            <i class="bi bi-plus-lg text-xl"></i>
                            <span>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</span>
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>



<!-- –ú–æ–±–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<!-- –ú–æ–±–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div class="lg:hidden mb-4">
    <button class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300 font-medium flex items-center justify-center shadow-lg" id="mobile-filters-btn">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
        </svg>
        –§–∏–ª—å—Ç—Ä—ã
        {% if request.GET.search or request.GET.property_type or request.GET.rental_type or request.GET.location or request.GET.min_price or request.GET.max_price %}
        <span class="ml-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">!</span>
        {% endif %}
    </button>
</div>

<!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div class="mobile-filters-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden" id="mobile-filters-overlay"></div>

<div class="mobile-filters-sidebar fixed left-0 top-0 h-full w-80 bg-white shadow-xl z-50 transform -translate-x-full transition-transform duration-300 overflow-y-auto" id="mobile-filters-sidebar">
    <div class="sticky top-0 bg-white border-b border-gray-200 z-10">
        <div class="flex justify-between items-center p-4">
            <h2 class="text-xl font-semibold text-gray-900">–§–∏–ª—å—Ç—Ä—ã</h2>
            <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors" id="mobile-filters-close">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="p-4">
        <form method="get" class="space-y-6" id="mobile-filter-form">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–ü–æ–∏—Å–∫</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <input type="text" name="search" value="{{ request.GET.search }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å...">
                </div>
            </div>

            <!-- –¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="space-y-2">
                        {% for value, label in property_type_choices %}
                        <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" name="property_type" value="{{ value }}"
                                   {% if value in request.GET.getlist %}checked{% endif %}
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">
                            <span class="text-sm text-gray-700">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- –í–∏–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–í–∏–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="space-y-2">
                        <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" name="rental_type" value="no"
                                   {% if "no" in request.GET.getlist %}checked{% endif %}
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">
                            <span class="text-sm text-gray-700">–ö—É–ø–∏—Ç—å</span>
                        </label>
                        <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" name="rental_type" value="monthly"
                                   {% if "monthly" in request.GET.getlist %}checked{% endif %}
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">
                            <span class="text-sm text-gray-700">–ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—Å—è—á–Ω–æ</span>
                        </label>
                        <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" name="rental_type" value="daily"
                                   {% if "daily" in request.GET.getlist %}checked{% endif %}
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">
                            <span class="text-sm text-gray-700">–ê—Ä–µ–Ω–¥–∞ –ø–æ—Å—É—Ç–æ—á–Ω–æ</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- –ì–æ—Ä–æ–¥ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–ì–æ—Ä–æ–¥</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="relative">
                        <button type="button" id="mobile-city-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium bg-white hover:bg-gray-50 transition-colors text-left">
                            <span id="mobile-selected-city-text">
                                {% if filter.form.location.value %}
                                    {{ filter.form.location.value }}
                                {% else %}
                                    –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
                                {% endif %}
                            </span>
                            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </button>
                        <input type="hidden" name="location" value="{{ filter.form.location.value|default:'' }}" id="mobile-city-hidden-input">
                    </div>
                </div>
            </div>

            <!-- –ú–µ—Ç—Ä–æ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–ú–µ—Ç—Ä–æ</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="relative">
                        <button type="button" id="mobile-metro-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium bg-white hover:bg-gray-50 transition-colors text-left">
                            <div id="mobile-selected-metro-text">
                                {% if filter.form.metro_station.value %}
                                    {% for station in filter.form.metro_station.value|slice:":2" %}
                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">
                                            {{ station }}
                                        </span>
                                    {% endfor %}
                                    {% if filter.form.metro_station.value|length > 2 %}
                                        <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">
                                            +{{ filter.form.metro_station.value|length|add:"-2" }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
                                {% endif %}
                            </div>
                            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </button>
                        <input type="hidden" name="metro_station" value="{% if filter.form.metro_station.value %}{{ filter.form.metro_station.value }}{% endif %}" id="mobile-metro-hidden-input">
                    </div>
                </div>
            </div>

            <!-- –¶–µ–Ω–∞ -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–¶–µ–Ω–∞</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–û—Ç, ‚ÇΩ</label>
                            <input type="number" name="min_price" value="{{ request.GET.min_price }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–î–æ, ‚ÇΩ</label>
                            <input type="number" name="max_price" value="{{ request.GET.max_price }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="–õ—é–±–∞—è">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–ª–æ—â–∞–¥—å -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–ü–ª–æ—â–∞–¥—å, –º¬≤</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–û—Ç</label>
                            <input type="number" name="min_area" value="{{ request.GET.min_area }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–î–æ</label>
                            <input type="number" name="max_area" value="{{ request.GET.max_area }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="–õ—é–±–∞—è">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–º–Ω–∞—Ç—ã -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–ö–æ–º–Ω–∞—Ç—ã</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–û—Ç</label>
                            <input type="number" name="rooms__gte" value="{{ request.GET.rooms__gte }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–î–æ</label>
                            <input type="number" name="rooms__lte" value="{{ request.GET.rooms__lte }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="–õ—é–±–∞—è">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –≠—Ç–∞–∂ -->
            <div class="mobile-filter-section">
                <div class="flex justify-between items-center py-3 cursor-pointer border-b border-gray-200" onclick="toggleMobileFilterSection(this)">
                    <span class="font-medium text-gray-900">–≠—Ç–∞–∂</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="mobile-filter-content hidden pt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–û—Ç</label>
                            <input type="number" name="min_floor" value="{{ request.GET.min_floor }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–î–æ</label>
                            <input type="number" name="max_floor" value="{{ request.GET.max_floor }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="–õ—é–±–∞—è">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="sticky bottom-0 bg-white pt-4 pb-6 border-t border-gray-200 mt-6">
                <div class="flex gap-3">
                    <button type="button" onclick="resetMobileFilters()" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                        –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors font-medium">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
<div id="mobile-city-dropdown" class="fixed inset-0 z-60 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</h2>
                <button id="mobile-close-city-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    √ó
                </button>
            </div>

            <div class="mt-4">
                <input type="text"
                       id="mobile-city-search"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="p-4">
            <button type="button" id="mobile-use-custom-city" class="hidden w-full mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
            </button>


        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–æ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
<div id="mobile-metro-dropdown" class="fixed inset-0 z-60 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ</h2>
                <button id="mobile-close-metro-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    √ó
                </button>
            </div>
            <div class="mt-4">
                <input type="text"
                       id="mobile-metro-search"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="p-4 overflow-y-auto flex-1">
            {% if location %}
                {% if metro_lines %}
                    <div class="metro-lines-container space-y-3 overflow-y-auto max-h-[calc(100vh-200px)]">
                        {% for line in metro_lines %}
                            <div class="metro-line-section border rounded-lg overflow-hidden">
                                <div class="metro-line-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                                    onclick="toggleMobileMetroLine(this)">
                                    <div class="flex items-center min-w-0">
                                        <div class="metro-line-color w-4 h-4 rounded-full mr-2 flex-shrink-0"
                                            style="background-color: {{ line.line_color }}"></div>
                                        <h3 class="metro-line-name font-medium text-sm truncate">{{ line.line|default:"–î—Ä—É–≥–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏" }}</h3>
                                    </div>
                                    <i class="bi bi-chevron-down transition-transform duration-200 flex-shrink-0"></i>
                                </div>

                                <div class="metro-stations-container transition-all duration-300 overflow-hidden"
                                    style="max-height: 0">
                                    {% for station in line.stations %}
                                        <button type="button"
                                                class="metro-station-option flex items-center px-3 py-2 w-full text-left hover:bg-gray-50 transition-colors {% if station.name in filter.form.metro_station.value %}bg-blue-100 text-blue-800{% endif %}"
                                                data-station="{{ station.name }}">
                                            <div class="metro-station-color w-3 h-3 rounded-full mr-3 flex-shrink-0"
                                                style="background-color: {{ station.line_color|default:'#cccccc' }}"></div>
                                            <span class="metro-station-name truncate">{{ station.name }}</span>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 py-4 text-center">–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö –º–µ—Ç—Ä–æ</p>
                {% endif %}
            {% else %}
                <p class="text-gray-500 py-4 text-center">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</p>
            {% endif %}
        </div>

        <div class="sticky bottom-0 bg-white p-4 border-t border-gray-200 flex justify-end gap-3">
            <button type="button"
                    id="mobile-clear-metro-selection"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50">
                –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <button type="button"
                    id="mobile-apply-metro-selection"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>




     <div class="flex flex-col lg:flex-row gap-8">
<aside class="w-full lg:w-80 flex-shrink-0 order-first">
    <div class="bg-white rounded-lg shadow p-6 sticky-column">
        <button class="filter-toggle btn-primary mb-4 lg:hidden">
            <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã
        </button>
        <div class="filter-sidebar lg:block" id="filter-sidebar">
            <form method="get" id="filter-form">
                <!-- –¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
            <!-- –¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
<!-- –¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->


<!-- –ó–∞–º–µ–Ω–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫ "–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏" –Ω–∞ —ç—Ç–æ—Ç –∫–æ–¥ -->
<!-- –ó–∞–º–µ–Ω–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫ "–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏" –Ω–∞ —ç—Ç–æ—Ç –∫–æ–¥ -->
<div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
    <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-100">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h3>
    <div class="checkbox-row" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px">
        <!-- –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ -->
        <label class="chip {% if 'new_flat' in selected_property_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="property_type" value="new_flat"
                   {% if 'new_flat' in selected_property_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>

        <!-- –í—Ç–æ—Ä–∏—á–∫–∞ -->
        <label class="chip {% if 'resale_flat' in selected_property_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="property_type" value="resale_flat"
                   {% if 'resale_flat' in selected_property_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–í—Ç–æ—Ä–∏—á–∫–∞</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>

        <!-- –î–æ–º -->
        <label class="chip {% if 'house' in selected_property_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="property_type" value="house"
                   {% if 'house' in selected_property_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–î–æ–º</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>

        <!-- –ù–µ–∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ -->
        <label class="chip {% if 'commercial' in selected_property_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="property_type" value="commercial"
                   {% if 'commercial' in selected_property_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–ù–µ–∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>
    </div>

    <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-100" style="margin-top: 16px;">–í–∏–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
    <div class="checkbox-row" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px">
        <!-- –ö—É–ø–∏—Ç—å -->
        <label class="chip {% if 'no' in selected_rental_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="rental_type" value="no"
                   {% if 'no' in selected_rental_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–ö—É–ø–∏—Ç—å</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>

        <!-- –ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—Å—è—á–Ω–æ -->
        <label class="chip {% if 'monthly' in selected_rental_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: white; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="rental_type" value="monthly"
                   {% if 'monthly' in selected_rental_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—Å—è—á–Ω–æ</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>

        <!-- –ê—Ä–µ–Ω–¥–∞ –ø–æ—Å—É—Ç–æ—á–Ω–æ -->
        <label class="chip {% if 'daily' in selected_rental_types %}active{% endif %}"
               style="cursor: pointer; padding: 8px 10px; border-radius: 10px; font-size: 13px; background: #ffffff; color: #64748b; transition: all 0.2s ease; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">
            <input type="checkbox" name="rental_type" value="daily"
                   {% if 'daily' in selected_rental_types %}checked{% endif %}
                   style="display: none;">
            <span class="relative z-10">–ê—Ä–µ–Ω–¥–∞ –ø–æ—Å—É—Ç–æ—á–Ω–æ</span>
            <div class="chip-hover-gradient" style="position: absolute; inset: 0; background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); opacity: 0; transition: opacity 0.2s ease; z-index: 1;"></div>
        </label>
    </div>
</div>

                <!-- –ì–æ—Ä–æ–¥ –∏ –ú–µ—Ç—Ä–æ -->
                <div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px">–ì–æ—Ä–æ–¥</label>
                    <div class="relative">
                        <button type="button" id="city-input" class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-medium bg-white hover:bg-blue-50 transition-colors text-left relative shadow-sm hover:shadow-md">
                            <span id="selected-city-text">
                                {% if filter.form.location.value %}
                                    {{ filter.form.location.value }}
                                {% else %}
                                    –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
                                {% endif %}
                            </span>
                            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </button>
                        <input type="hidden" name="location" value="{{ filter.form.location.value|default:'' }}" id="city-hidden-input">
                    </div>

                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; margin-top: 8px">–ú–µ—Ç—Ä–æ</label>
                    <div class="relative">
                        <button type="button" id="metro-input" class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-medium bg-white hover:bg-blue-50 transition-colors text-left relative shadow-sm hover:shadow-md">
                            <div id="selected-metro-text">
                                {% if filter.form.metro_station.value %}
                                    {% for station in filter.form.metro_station.value|slice:":3" %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ station }}
                                        </span>
                                    {% endfor %}
                                    {% if filter.form.metro_station.value|length > 3 %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            +{{ filter.form.metro_station.value|length|add:"-3" }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
                                {% endif %}
                            </div>
                            <i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </button>
                        <input type="hidden" name="metro_station" value="{% if filter.form.metro_station.value %}{{ filter.form.metro_station.value }}{% endif %}" id="metro-hidden-input">
                    </div>

                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; margin-top: 8px">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞, –∫–º</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_distance_to_center" value="{{ filter.form.min_distance_to_center.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_distance_to_center" value="{{ filter.form.max_distance_to_center.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>
                </div>

                <!-- –¶–µ–Ω–∞ -->
                <div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px">–¶–µ–Ω–∞, ‚ÇΩ</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_price" value="{{ filter.form.min_price.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_price" value="{{ filter.form.max_price.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>

                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; margin-top: 8px">–¶–µ–Ω–∞ –∑–∞ –º¬≤, ‚ÇΩ</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_price_per_sqm" value="{{ filter.form.min_price_per_sqm.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_price_per_sqm" value="{{ filter.form.max_price_per_sqm.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>
                </div>

                <!-- –ü–ª–æ—â–∞–¥—å -->
                <div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px">
                        <input type="number" name="min_area" value="{{ filter.form.min_area.value|default:'' }}" placeholder="–û–±—â–∞—è –æ—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_area" value="{{ filter.form.max_area.value|default:'' }}" placeholder="–û–±—â–∞—è –¥–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>

                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_living_area" value="{{ filter.form.min_living_area.value|default:'' }}" placeholder="–ñ–∏–ª–∞—è –æ—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_living_area" value="{{ filter.form.max_living_area.value|default:'' }}" placeholder="–ñ–∏–ª–∞—è –¥–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>
                </div>

                <!-- –ö–æ–º–Ω–∞—Ç—ã –∏ –≠—Ç–∞–∂ -->
                <div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="rooms__gte" value="{{ filter.form.rooms__gte.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="rooms__lte" value="{{ filter.form.rooms__lte.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>

                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; margin-top: 8px">–≠—Ç–∞–∂</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px">
                        <input type="number" name="min_floor" value="{{ filter.form.min_floor.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_floor" value="{{ filter.form.max_floor.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>

                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; margin-top: 8px">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_total_floors" value="{{ filter.form.min_total_floors.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_total_floors" value="{{ filter.form.max_total_floors.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>
                </div>

                <!-- –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –∏ –ß–µ–∫–±–æ–∫—Å—ã -->
                <div class="filter-group" style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                    <label class="field" style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px">–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</label>
                    <div class="two" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
                        <input type="number" name="min_construction_year" value="{{ filter.form.min_construction_year.value|default:'' }}" placeholder="–û—Ç" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                        <input type="number" name="max_construction_year" value="{{ filter.form.max_construction_year.value|default:'' }}" placeholder="–î–æ" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #1e293b; font-size: 14px" />
                    </div>

                    <div style="margin-top: 12px">
                    <!-- –ó–∞–º–µ–Ω–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–µ–∫–±–æ–∫—Å—ã –Ω–∞: -->
<label class="checkbox-row" style="display: flex; align-items: center; margin-bottom: 8px">
    <input type="checkbox" id="has_finishing" name="has_finishing" value="true"
           {% if filter.form.has_finishing.value %}checked{% endif %} />
    <span style="vertical-align: middle; color: #64748b">–¢–æ–ª—å–∫–æ —Å –æ—Ç–¥–µ–ª–∫–æ–π</span>
</label>
<label class="checkbox-row" style="display: flex; align-items: center">
    <input type="checkbox" id="is_delivered" name="is_delivered" value="true"
           {% if filter.form.is_delivered.value %}checked{% endif %} />
    <span style="vertical-align: middle; color: #64748b">–¢–æ–ª—å–∫–æ —Å–¥–∞–Ω–Ω—ã–µ</span>
</label>
                    </div>
                </div>

                <div class="filters-footer" style="display: flex; gap: 8px; position: sticky; bottom: 18px; padding-top: 8px; background: linear-gradient(180deg, transparent, rgba(255,255,255,0.9));">
                    <a href="?" class="btn" style="background: white; border: 1px solid #e5e7eb; padding: 10px 14px; border-radius: 10px; color: #64748b; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    <button type="submit" class="btn btn-accent" style="background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%); border: 0; color: white; padding: 10px 16px; border-radius: 12px; font-weight: 700; box-shadow: 0 6px 30px rgba(99, 72, 255, 0.15);">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</aside>

<!-- –°—Ç–∞—Ä—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –≥–æ—Ä–æ–¥–∞ –∏ –º–µ—Ç—Ä–æ -->
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ -->
<div id="city-dropdown" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</h2>
                <button id="close-city-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    √ó
                </button>
            </div>

            <div class="mt-4">
                <input type="text"
                       id="city-search"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="p-4">
            <button type="button" id="use-custom-city" class="hidden w-full mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫">–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ß–µ–ª—è–±–∏–Ω—Å–∫">–ß–µ–ª—è–±–∏–Ω—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É">–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–¢—é–º–µ–Ω—å">–¢—é–º–µ–Ω—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–£—Ñ–∞">–£—Ñ–∞</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ö–∞–∑–∞–Ω—å">–ö–∞–∑–∞–Ω—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ü–µ—Ä–º—å">–ü–µ—Ä–º—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–°–∞–º–∞—Ä–∞">–°–∞–º–∞—Ä–∞</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–°–∞—Ä–∞—Ç–æ–≤">–°–∞—Ä–∞—Ç–æ–≤</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–û–º—Å–∫">–û–º—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ë–∞–ª–∞—à–∏—Ö–∞">–ë–∞–ª–∞—à–∏—Ö–∞</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–í–æ–ª–≥–æ–≥—Ä–∞–¥">–í–æ–ª–≥–æ–≥—Ä–∞–¥</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–í–æ—Ä–æ–Ω–µ–∂">–í–æ—Ä–æ–Ω–µ–∂</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ò—Ä–∫—É—Ç—Å–∫">–ò—Ä–∫—É—Ç—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–•–∞–±–∞—Ä–æ–≤—Å–∫">–•–∞–±–∞—Ä–æ–≤—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–¢–æ–º—Å–∫">–¢–æ–º—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–Ø—Ä–æ—Å–ª–∞–≤–ª—å">–Ø—Ä–æ—Å–ª–∞–≤–ª—å</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–°–æ—á–∏">–°–æ—á–∏</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–°—É—Ä–≥—É—Ç">–°—É—Ä–≥—É—Ç</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ü–æ–¥–æ–ª—å—Å–∫">–ü–æ–¥–æ–ª—å—Å–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ú—ã—Ç–∏—â–∏">–ú—ã—Ç–∏—â–∏</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫">–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ö–∞–ª—É–≥–∞">–ö–∞–ª—É–≥–∞</button>
                <button type="button"
                        class="city-option py-3 px-4 text-left hover:bg-blue-50 rounded-lg border border-gray-200 text-lg"
                        data-city="–ü—è—Ç–∏–≥–æ—Ä—Å–∫">–ü—è—Ç–∏–≥–æ—Ä—Å–∫</button>
            </div>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–æ -->
<div id="metro-dropdown" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="sticky top-0 bg-white p-4 border-b border-gray-200 z-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ</h2>
                <button id="close-metro-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    √ó
                </button>
            </div>
            <div class="mt-4">
                <input type="text"
                       id="metro-search"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="p-4 overflow-y-auto flex-1">
            {% if location %}
                {% if metro_lines %}
                    {% if location == "–ú–æ—Å–∫–≤–∞" %}
                    <div class="metro-lines-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 overflow-y-auto max-h-[calc(100vh-200px)]">
                        {% for line in metro_lines %}
                            <div class="metro-line-section" style="border: none !important; border-radius: 8px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                <div class="metro-line-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                                    onclick="toggleMetroLine(this)">
                                    <div class="flex items-center min-w-0">
                                        <div class="metro-line-color w-4 h-4 rounded-full mr-2 flex-shrink-0"
                                            style="background-color: {{ line.line_color }}"></div>
                                        <h3 class="metro-line-name font-medium text-sm truncate">{{ line.line|default:"–î—Ä—É–≥–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏" }}</h3>
                                    </div>
                                    <i class="bi bi-chevron-down transition-transform duration-200 flex-shrink-0"></i>
                                </div>

                                <div class="metro-stations-container transition-all duration-300 overflow-y-auto"
                                    style="max-height: 0">
                                    <div class="metro-stations-container">
                                        {% for station in line.stations %}
                                            <button type="button"
                                                    class="metro-station-option flex items-center px-3 py-1.5 rounded text-sm transition-colors {% if station.name in filter.form.metro_station.value %}bg-blue-100 text-blue-800{% else %}hover:bg-gray-200{% endif %}"
                                                    data-station="{{ station.name }}">
                                                <div class="metro-station-color w-3 h-3 rounded-full mr-2 flex-shrink-0"
                                                    style="background-color: {{ station.line_color|default:'#cccccc' }}"></div>
                                                <span class="metro-station-name truncate">{{ station.name }}</span>
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="metro-lines-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto max-h-[calc(100vh-200px)]">
                        {% for line in metro_lines %}
                            <div class="metro-line-section">
                                <div class="metro-line-header flex items-center mb-3">
                                    <div class="metro-line-color w-4 h-4 rounded-full mr-2"
                                        style="background-color: {{ line.line_color }}"></div>
                                    <h3 class="metro-line-name text-lg font-semibold">
                                        {{ line.line|default:"–î—Ä—É–≥–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏" }}
                                    </h3>
                                </div>

                                <div class="metro-stations-grid max-h-60 overflow-y-auto pr-2">
                                    {% for station in line.stations %}
                                        <button type="button"
                                                class="metro-station-option flex items-center px-3 py-1.5 rounded text-sm transition-colors {% if station.name in filter.form.metro_station.value %}bg-blue-100 text-blue-800{% else %}hover:bg-gray-200{% endif %}"
                                                data-station="{{ station.name }}">
                                            <div class="metro-station-color w-3 h-3 rounded-full mr-2 flex-shrink-0"
                                                style="background-color: {{ station.line_color|default:'#cccccc' }}"></div>
                                            <span class="metro-station-name truncate">{{ station.name }}</span>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 py-4 text-center">–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö –º–µ—Ç—Ä–æ</p>
                {% endif %}
            {% else %}
                <p class="text-gray-500 py-4 text-center">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</p>
            {% endif %}
        </div>

        <div class="sticky bottom-0 bg-white p-4 border-t border-gray-200 flex justify-end gap-3">
            <button type="button"
                    id="clear-metro-selection"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50">
                –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <button type="button"
                    id="apply-metro-selection"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>
        <div style="display:none">API Key: {{ YANDEX_MAPS_API_KEY }}</div>


   <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="flex-1">
                        <!-- –ö–∞—Ä—Ç–∞ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ -->
            <div class="flex justify-end">
                <div class="custom-map-container relative" style="width: 1000px; height: 500px;">
                    <div id="all-properties-map" class="rounded-xl overflow-hidden"></div>
                    <div class="map-loading" id="map-loading">
                        <div class="map-loading-spinner"></div>
                    </div>

                </div>
            </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π -->
       <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π -->
<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ -->
<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ -->
<section class="listings" aria-label="–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤" style="margin-top: 18px; display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
<style>
@media (max-width: 768px) {
    .listings {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
}
@media (min-width: 769px) and (max-width: 1024px) {
    .listings {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    }
}
</style>
    {% if properties %}
        {% for property in properties %}
            <article class="property-card" style="
                border-radius: 20px;
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                border: 1px solid rgba(255, 255, 255, 0.8);
                box-shadow:
                    0 4px 20px rgba(0, 0, 0, 0.08),
                    0 1px 0 rgba(255, 255, 255, 0.8) inset,
                    0 -1px 0 rgba(0, 0, 0, 0.02) inset;
                overflow: hidden;
                position: relative;
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                backdrop-filter: blur(10px);
            ">
                <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç -->
                <div class="card-accent" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(90deg, #7b61ff 0%, #36d1dc 50%, #7b61ff 100%);
                    background-size: 200% 100%;
                    animation: shimmer 3s ease-in-out infinite;
                "></div>

                <!-- –ë–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ -->
                <div class="status-badge" style="
                    position: absolute;
                    top: 16px;
                    right: 16px;
                    z-index: 10;
                    padding: 6px 12px;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.6);
                ">
                    {% if property.is_rental == 'monthly' %}
                        <span style="color: #10b981;">–ê—Ä–µ–Ω–¥–∞</span>
                    {% elif property.is_rental == 'daily' %}
                        <span style="color: #f59e0b;">–ü–æ—Å—É—Ç–æ—á–Ω–æ</span>
                    {% else %}
                        <span style="color: #7b61ff;">–ü—Ä–æ–¥–∞–∂–∞</span>
                    {% endif %}
                </div>

                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º –æ–≤–µ—Ä–ª–µ–µ–º -->
                <div class="image-container" style="
                    position: relative;
                    height: 200px;
                    overflow: hidden;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                ">
                    <div class="property-image" style="
                        width: 100%;
                        height: 100%;
                        background-image: url('{{ property.main_image.url }}');
                        background-size: cover;
                        background-position: center;
                        transition: transform 0.6s ease;
                    "></div>

                    <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π -->
                    <div class="image-overlay" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(
                            to bottom,
                            rgba(0, 0, 0, 0.1) 0%,
                            transparent 30%,
                            rgba(0, 0, 0, 0.15) 100%
                        );
                    "></div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->

                </div>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="card-content" style="padding: 24px;">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–∏–ø -->
                    <div class="property-header" style="margin-bottom: 16px;">
                        <div class="property-type" style="
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            color: #7b61ff;
                            margin-bottom: 6px;
                        ">
                            {{ property.get_property_type_display }}
                        </div>
                        <h3 class="property-title" style="
                            margin: 0;
                            font-size: 20px;
                            font-weight: 700;
                            line-height: 1.3;
                            color: #1e293b;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                            overflow: hidden;
                        ">
                            {{ property.title }}
                        </h3>
                    </div>

                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="property-info" style="margin-bottom: 20px;">
                        <div class="info-grid" style="
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 12px;
                        ">
                            <!-- –ö–æ–º–Ω–∞—Ç—ã -->
                            <div class="info-item" style="display: flex; align-items: center; gap: 8px;">
                                <div class="info-icon" style="
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    background: rgba(123, 97, 255, 0.1);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    <i class="bi bi-door-open" style="color: #7b61ff; font-size: 14px;"></i>
                                </div>
                                <div>
                                    <div class="info-value" style="font-size: 16px; font-weight: 700; color: #1e293b;">
                                        {{ property.rooms }} –∫–æ–º–Ω.
                                    </div>
                                    <div class="info-label" style="font-size: 12px; color: #64748b;">–ö–æ–º–Ω–∞—Ç—ã</div>
                                </div>
                            </div>

                            <!-- –ü–ª–æ—â–∞–¥—å -->
                            <div class="info-item" style="display: flex; align-items: center; gap: 8px;">
                                <div class="info-icon" style="
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    background: rgba(54, 209, 220, 0.1);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    <i class="bi bi-arrows-fullscreen" style="color: #36d1dc; font-size: 14px;"></i>
                                </div>
                                <div>
                                    <div class="info-value" style="font-size: 16px; font-weight: 700; color: #1e293b;">
                                        {{ property.total_area }} –º¬≤
                                    </div>
                                    <div class="info-label" style="font-size: 12px; color: #64748b;">–ü–ª–æ—â–∞–¥—å</div>
                                </div>
                            </div>

                            <!-- –ú–µ—Ç—Ä–æ -->
                            {% if property.metro_station and property.metro_station != "–ù–µ —É–∫–∞–∑–∞–Ω–æ" %}
                            <div class="info-item" style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
                                <div class="info-icon" style="
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    background: rgba(239, 68, 68, 0.1);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    <i class="bi bi-train-front" style="color: #ef4444; font-size: 14px;"></i>
                                </div>
                                <div>
                                    <div class="info-value" style="font-size: 16px; font-weight: 700; color: #1e293b;">
                                        {{ property.metro_station }}
                                    </div>
                                    <div class="info-label" style="font-size: 12px; color: #64748b;">–ú–µ—Ç—Ä–æ</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –¶–µ–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
                    <div class="property-footer" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding-top: 16px;
                        border-top: 1px solid rgba(0, 0, 0, 0.05);
                    ">
                        <div class="price-section">
                            <div class="price" style="
                                font-size: 24px;
                                font-weight: 800;
                                color: #7b61ff;
                                line-height: 1.2;
                            ">
                                {% if property.is_rental == 'monthly' and property.monthly_price %}
                                    {{ property.monthly_price|space_format }} ‚ÇΩ/–º–µ—Å
                                {% elif property.is_rental == 'daily' and property.daily_price %}
                                    {{ property.daily_price|space_format }} ‚ÇΩ/—Å—É—Ç
                                {% else %}
                                    {{ property.price|space_format }} ‚ÇΩ
                                {% endif %}
                            </div>
                            <div class="price-per-sqm" style="font-size: 12px; color: #64748b;">
                                {{ property.price_per_sqm|space_format }} ‚ÇΩ/–º¬≤
                            </div>
                        </div>

                        <a href="{% url 'properties:property-detail' property.id %}"
                           class="details-btn"
                           style="
                                padding: 12px 20px;
                                background: linear-gradient(135deg, #7b61ff 0%, #36d1dc 100%);
                                color: white;
                                border-radius: 12px;
                                font-weight: 600;
                                text-decoration: none;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 15px rgba(123, 97, 255, 0.3);
                                display: flex;
                                align-items: center;
                                gap: 6px;
                           "
                           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(123, 97, 255, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(123, 97, 255, 0.3)';">
                            <span>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
                            <i class="bi bi-arrow-right-short" style="font-size: 16px;"></i>
                        </a>
                    </div>
                </div>

                <!-- –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                <style>
                    .property-card:hover {
                        transform: translateY(-8px) scale(1.02);
                        box-shadow:
                            0 25px 50px rgba(0, 0, 0, 0.15),
                            0 1px 0 rgba(255, 255, 255, 0.8) inset,
                            0 -1px 0 rgba(0, 0, 0, 0.02) inset;
                    }

                    .property-card:hover .property-image {
                        transform: scale(1.1);
                    }

                    .favorite-btn:hover {
                        background: rgba(255, 255, 255, 1);
                        transform: scale(1.1);
                        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
                    }

                    .favorite-btn:hover i {
                        color: #ef4444 !important;
                    }

                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                </style>
            </article>
        {% endfor %}
    {% else %}
        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ -->
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
            <div style="
                width: 120px;
                height: 120px;
                margin: 0 auto 24px;
                background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 4px solid white;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            ">
                <i class="bi bi-house-x" style="font-size: 48px; color: #94a3b8;"></i>
            </div>
            <h3 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">
                {% if user.is_authenticated and user.is_broker %}
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤
                {% else %}
                    –û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                {% endif %}
            </h3>
            <p style="font-size: 16px; color: #64748b; max-width: 400px; margin: 0 auto; line-height: 1.5;">
                {% if user.is_authenticated and user.is_broker %}
                    –ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—ä–µ–∫—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ –≤–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ
                {% else %}
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                {% endif %}
            </p>
        </div>
    {% endif %}
</section>

                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                {% if is_paginated %}
                <div class="pagination flex justify-center gap-2 mt-8">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}"
                       class="page-item px-4 py-2 rounded-lg border-2 border-gray-200 hover:bg-gray-50">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    <a href="?page={{ num }}"
                       class="page-item px-4 py-2 rounded-lg border-2 {% if num == page_obj.number %}bg-blue-600 text-white border-blue-600{% else %}border-gray-200 hover:bg-gray-50{% endif %}">
                        {{ num }}
                    </a>
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}"
                       class="page-item px-4 py-2 rounded-lg border-2 border-gray-200 hover:bg-gray-50">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</body>


<script>
// –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function initMobileFilters() {
    const mobileFiltersBtn = document.getElementById('mobile-filters-btn');
    const mobileFiltersSidebar = document.getElementById('mobile-filters-sidebar');
    const mobileFiltersOverlay = document.getElementById('mobile-filters-overlay');
    const mobileFiltersClose = document.getElementById('mobile-filters-close');

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤
    window.closeMobileFilters = function() {
        if (mobileFiltersSidebar) {
            mobileFiltersSidebar.classList.add('-translate-x-full');
        }
        if (mobileFiltersOverlay) {
            mobileFiltersOverlay.classList.add('hidden');
        }
        document.body.style.overflow = '';
    };

    function openMobileFilters() {
        if (mobileFiltersSidebar) {
            mobileFiltersSidebar.classList.remove('-translate-x-full');
        }
        if (mobileFiltersOverlay) {
            mobileFiltersOverlay.classList.remove('hidden');
        }
        document.body.style.overflow = 'hidden';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (mobileFiltersBtn) {
        mobileFiltersBtn.addEventListener('click', openMobileFilters);
    }

    if (mobileFiltersClose) {
        mobileFiltersClose.addEventListener('click', closeMobileFilters);
    }

    if (mobileFiltersOverlay) {
        mobileFiltersOverlay.addEventListener('click', closeMobileFilters);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMobileFilters();
            // –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã
            document.querySelectorAll('#mobile-city-dropdown, #mobile-metro-dropdown').forEach(modal => {
                modal.classList.add('hidden');
            });
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    initMobileModals();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≥–æ—Ä–æ–¥—É
function loadMetroStationsForCity(city) {
    if (!city) return;

    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${city}`);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const metroInput = document.getElementById('metro-input');
    if (metroInput) {
        metroInput.innerHTML = '<span class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ...</span>';
        metroInput.disabled = true;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —á–µ—Ä–µ–∑ AJAX
    fetch(`/properties/api/metro-stations/?city=${encodeURIComponent(city)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('–ü–æ–ª—É—á–µ–Ω—ã —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ:', data);
            updateMetroDropdown(data.metro_stations);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            if (metroInput) {
                metroInput.disabled = false;
                updateSelectedStationsText(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
                const selectedMetroText = document.getElementById('selected-metro-text');
                if (selectedMetroText) {
                    metroInput.innerHTML = selectedMetroText.outerHTML +
                        '<i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>';
                }
            }

            showNotification(`–°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è ${city} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, 'success');
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ:', error);
            if (metroInput) {
                metroInput.disabled = false;
                metroInput.innerHTML = '<span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–æ</span>' +
                    '<i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>';
            }
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ', 'error');
        });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ
function updateMetroDropdown(metroStations) {
    const metroDropdown = document.getElementById('metro-dropdown');
    if (!metroDropdown) return;

    const metroContent = metroDropdown.querySelector('.metro-lines-container');
    if (!metroContent) return;

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –ª–∏–Ω–∏—è–º
    const linesMap = {};
    metroStations.forEach(station => {
        const line = station.line || '–î—Ä—É–≥–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏';
        if (!linesMap[line]) {
            linesMap[line] = {
                line: line,
                line_color: station.line_color || '#cccccc',
                stations: []
            };
        }
        linesMap[line].stations.push(station);
    });

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –ª–∏–Ω–∏–π –∏ —Å—Ç–∞–Ω—Ü–∏–π
    let html = '';
    Object.values(linesMap).forEach(lineData => {
        html += `
            <div class="metro-line-section border rounded-lg overflow-hidden">
                <div class="metro-line-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                    onclick="toggleMetroLine(this)">
                    <div class="flex items-center min-w-0">
                        <div class="metro-line-color w-4 h-4 rounded-full mr-2 flex-shrink-0"
                            style="background-color: ${lineData.line_color}"></div>
                        <h3 class="metro-line-name font-medium text-sm truncate">${lineData.line}</h3>
                    </div>
                    <i class="bi bi-chevron-down transition-transform duration-200 flex-shrink-0"></i>
                </div>

                <div class="metro-stations-container transition-all duration-300 overflow-hidden"
                    style="max-height: 0">
                    ${lineData.stations.map(station => `
                        <button type="button"
                                class="metro-station-option flex items-center px-3 py-1.5 rounded text-sm transition-colors border-gray-200 hover:bg-gray-200"
                                data-station="${station.name}">
                            <div class="metro-station-color w-3 h-3 rounded-full mr-2 flex-shrink-0"
                                style="background-color: ${station.line_color || '#cccccc'}"></div>
                            <span class="metro-station-name truncate">${station.name}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    });

    metroContent.innerHTML = html;

    // –ï—Å–ª–∏ —Å—Ç–∞–Ω—Ü–∏–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (metroStations.length === 0) {
        metroContent.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="bi bi-train-front text-4xl mb-4"></i>
                <p>–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö –º–µ—Ç—Ä–æ</p>
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
function loadMobileMetroStationsForCity(city) {
    if (!city) return;

    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏: ${city}`);

    const metroInput = document.getElementById('mobile-metro-input');
    if (metroInput) {
        metroInput.innerHTML = '<span class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ...</span>';
        metroInput.disabled = true;
    }

    fetch(`/properties/api/metro-stations/?city=${encodeURIComponent(city)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('–ü–æ–ª—É—á–µ–Ω—ã —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏:', data);
            updateMobileMetroDropdown(data.metro_stations);

            if (metroInput) {
                metroInput.disabled = false;
                updateMobileSelectedStationsText(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
                const selectedMetroText = document.getElementById('mobile-selected-metro-text');
                if (selectedMetroText) {
                    metroInput.innerHTML = selectedMetroText.outerHTML +
                        '<i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>';
                }
            }

            showNotification(`–°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è ${city} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, 'success');
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏:', error);
            if (metroInput) {
                metroInput.disabled = false;
                metroInput.innerHTML = '<span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–æ</span>' +
                    '<i class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>';
            }
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ', 'error');
        });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ
function updateMobileMetroDropdown(metroStations) {
    const metroDropdown = document.getElementById('mobile-metro-dropdown');
    if (!metroDropdown) return;

    const metroContent = metroDropdown.querySelector('.metro-lines-container');
    if (!metroContent) return;

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –ª–∏–Ω–∏—è–º (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ü–ö –≤–µ—Ä—Å–∏–∏)
    const linesMap = {};
    metroStations.forEach(station => {
        const line = station.line || '–î—Ä—É–≥–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏';
        if (!linesMap[line]) {
            linesMap[line] = {
                line: line,
                line_color: station.line_color || '#cccccc',
                stations: []
            };
        }
        linesMap[line].stations.push(station);
    });

    let html = '';
    Object.values(linesMap).forEach(lineData => {
        html += `
            <div class="metro-line-section border rounded-lg overflow-hidden">
                <div class="metro-line-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                    onclick="toggleMobileMetroLine(this)">
                    <div class="flex items-center min-w-0">
                        <div class="metro-line-color w-4 h-4 rounded-full mr-2 flex-shrink-0"
                            style="background-color: ${lineData.line_color}"></div>
                        <h3 class="metro-line-name font-medium text-sm truncate">${lineData.line}</h3>
                    </div>
                    <i class="bi bi-chevron-down transition-transform duration-200 flex-shrink-0"></i>
                </div>

                <div class="metro-stations-container transition-all duration-300 overflow-hidden"
                    style="max-height: 0">
                    ${lineData.stations.map(station => `
                        <button type="button"
                                class="metro-station-option flex items-center px-3 py-1.5 rounded text-sm transition-colors border-gray-200 hover:bg-gray-200"
                                data-station="${station.name}">
                            <div class="metro-station-color w-3 h-3 rounded-full mr-2 flex-shrink-0"
                                style="background-color: ${station.line_color || '#cccccc'}"></div>
                            <span class="metro-station-name truncate">${station.name}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    });

    metroContent.innerHTML = html;

    if (metroStations.length === 0) {
        metroContent.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="bi bi-train-front text-4xl mb-4"></i>
                <p>–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö –º–µ—Ç—Ä–æ</p>
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'info' ? 'bg-blue-500 text-white' :
        type === 'success' ? 'bg-green-500 text-white' :
        'bg-red-500 text-white'
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function ensureMetroStationsLoaded() {
    const selectedCity = document.getElementById('city-hidden-input')?.value;
    if (selectedCity) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ —É–∂–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
        const metroContent = document.querySelector('#metro-dropdown .metro-lines-container');
        if (!metroContent || metroContent.innerHTML.includes('–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') || metroContent.children.length === 0) {
            console.log('–°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º...');
            loadMetroStationsForCity(selectedCity);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
function ensureMobileMetroStationsLoaded() {
    const selectedCity = document.getElementById('mobile-city-hidden-input')?.value;
    if (selectedCity) {
        const metroContent = document.querySelector('#mobile-metro-dropdown .metro-lines-container');
        if (!metroContent || metroContent.innerHTML.includes('–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') || metroContent.children.length === 0) {
            console.log('–°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º...');
            loadMobileMetroStationsForCity(selectedCity);
        }
    }
}

// –ú–æ–±–∏–ª—å–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –≥–æ—Ä–æ–¥–∞ –∏ –º–µ—Ç—Ä–æ
function initMobileModals() {
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
    function openMobileModal(modal) {
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        closeAllMobileModals();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ–∫–∏–π z-index
        modal.style.zIndex = '9999';
        modal.classList.remove('hidden');

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
    }

    function closeAllMobileModals() {
        document.querySelectorAll('#mobile-city-dropdown, #mobile-metro-dropdown').forEach(modal => {
            modal.classList.add('hidden');
            modal.style.zIndex = '';
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
        document.body.style.overflow = '';
        document.body.classList.remove('modal-open');
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–æ—Ä–æ–¥–∞
    const mobileCityInput = document.getElementById('mobile-city-input');
    const mobileCityDropdown = document.getElementById('mobile-city-dropdown');
    const mobileCitySearch = document.getElementById('mobile-city-search');
    const mobileCloseCityModal = document.getElementById('mobile-close-city-modal');
    const mobileUseCustomCityBtn = document.getElementById('mobile-use-custom-city');

    let mobileCustomCity = '';

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–æ—Ä–æ–¥–∞
    if (mobileCityInput) {
        mobileCityInput.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof closeMobileFilters === 'function') {
                closeMobileFilters();
            }
            if (mobileCityDropdown) {
                openMobileModal(mobileCityDropdown);
                setTimeout(() => {
                    if (mobileCitySearch) mobileCitySearch.focus();
                }, 100);
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–æ—Ä–æ–¥–∞
    if (mobileCloseCityModal) {
        mobileCloseCityModal.addEventListener('click', function() {
            closeAllMobileModals();
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (mobileCityDropdown) {
        mobileCityDropdown.addEventListener('click', function(e) {
            if (e.target === mobileCityDropdown) {
                closeAllMobileModals();
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
    document.querySelectorAll('#mobile-city-dropdown .city-option').forEach(option => {
        option.addEventListener('click', function() {
            const city = this.getAttribute('data-city');
            const selectedCityText = document.getElementById('mobile-selected-city-text');
            const cityHiddenInput = document.getElementById('mobile-city-hidden-input');

            if (selectedCityText) selectedCityText.textContent = city;
            if (cityHiddenInput) cityHiddenInput.value = city;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –°–†–ê–ó–£
            loadMobileMetroStationsForCity(city);

            closeAllMobileModals();
        });
    });

    // –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤
    if (mobileCitySearch) {
        mobileCitySearch.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            mobileCustomCity = searchTerm;

            if (searchTerm.length > 2 && mobileUseCustomCityBtn) {
                mobileUseCustomCityBtn.classList.remove('hidden');
                mobileUseCustomCityBtn.textContent = `–ü—Ä–∏–º–µ–Ω–∏—Ç—å "${searchTerm}"`;
            } else if (mobileUseCustomCityBtn) {
                mobileUseCustomCityBtn.classList.add('hidden');
            }

            document.querySelectorAll('#mobile-city-dropdown .city-option').forEach(option => {
                const city = option.getAttribute('data-city').toLowerCase();
                if (city.includes(searchTerm.toLowerCase())) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        });
    }

    // –†—É—á–Ω–æ–π –≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞
    if (mobileUseCustomCityBtn) {
        mobileUseCustomCityBtn.addEventListener('click', function() {
            if (mobileCustomCity) {
                const selectedCityText = document.getElementById('mobile-selected-city-text');
                const cityHiddenInput = document.getElementById('mobile-city-hidden-input');

                if (selectedCityText) selectedCityText.textContent = mobileCustomCity;
                if (cityHiddenInput) cityHiddenInput.value = mobileCustomCity;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –°–†–ê–ó–£
                loadMobileMetroStationsForCity(mobileCustomCity);

                closeAllMobileModals();
            }
        });
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ—Ç—Ä–æ
    const mobileMetroInput = document.getElementById('mobile-metro-input');
    const mobileMetroDropdown = document.getElementById('mobile-metro-dropdown');
    const mobileMetroSearch = document.getElementById('mobile-metro-search');
    const mobileCloseMetroModal = document.getElementById('mobile-close-metro-modal');
    const mobileApplyMetroBtn = document.getElementById('mobile-apply-metro-selection');
    const mobileClearMetroBtn = document.getElementById('mobile-clear-metro-selection');

    let mobileSelectedStations = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
    const mobileMetroHiddenInput = document.getElementById('mobile-metro-hidden-input');
    if (mobileMetroHiddenInput && mobileMetroHiddenInput.value) {
        mobileSelectedStations = mobileMetroHiddenInput.value.split(',');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ä–æ–¥–∞
    if (mobileMetroInput) {
        mobileMetroInput.addEventListener('click', function(e) {
            e.preventDefault();

            const selectedCity = document.getElementById('mobile-city-hidden-input')?.value;
            if (!selectedCity) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥', 'warning');
                return;
            }

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            ensureMobileMetroStationsLoaded();

            if (typeof closeMobileFilters === 'function') {
                closeMobileFilters();
            }
            if (mobileMetroDropdown) {
                openMobileModal(mobileMetroDropdown);
                setTimeout(() => {
                    if (mobileMetroSearch) mobileMetroSearch.focus();
                }, 100);
                updateMobileSelectedStationsInModal();
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ
    if (mobileCloseMetroModal) {
        mobileCloseMetroModal.addEventListener('click', function() {
            closeAllMobileModals();
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (mobileMetroDropdown) {
        mobileMetroDropdown.addEventListener('click', function(e) {
            if (e.target === mobileMetroDropdown) {
                closeAllMobileModals();
            }
        });
    }

    // –ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ
    if (mobileMetroSearch) {
        mobileMetroSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            document.querySelectorAll('#mobile-metro-dropdown .metro-line-section').forEach(section => {
                let hasVisibleStations = false;

                section.querySelectorAll('.metro-station-option').forEach(option => {
                    const stationName = option.querySelector('.metro-station-name').textContent.toLowerCase();
                    if (stationName.includes(searchTerm)) {
                        option.classList.remove('hidden');
                        hasVisibleStations = true;
                    } else {
                        option.classList.add('hidden');
                    }
                });

                if (searchTerm.length > 0) {
                    if (hasVisibleStations) {
                        section.classList.remove('hidden');
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –ª–∏–Ω–∏—é –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
                        const header = section.querySelector('.metro-line-header');
                        const stationsContainer = section.querySelector('.metro-stations-container');
                        if (header && stationsContainer) {
                            header.classList.add('expanded');
                            stationsContainer.style.maxHeight = stationsContainer.scrollHeight + 'px';
                        }
                    } else {
                        section.classList.add('hidden');
                    }
                } else {
                    section.classList.remove('hidden');
                }
            });
        });
    }

    // –í—ã–±–æ—Ä/–æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–Ω—Ü–∏–∏
    document.addEventListener('click', function(e) {
        if (e.target.closest('#mobile-metro-dropdown .metro-station-option')) {
            const option = e.target.closest('.metro-station-option');
            const station = option.getAttribute('data-station');

            if (mobileSelectedStations.includes(station)) {
                mobileSelectedStations = mobileSelectedStations.filter(s => s !== station);
                option.classList.remove('selected');
            } else {
                if (mobileSelectedStations.length < 5) {
                    mobileSelectedStations.push(station);
                    option.classList.add('selected');
                } else {
                    alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Å—Ç–∞–Ω—Ü–∏–π');
                }
            }
        }
    });

    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–æ
    if (mobileClearMetroBtn) {
        mobileClearMetroBtn.addEventListener('click', function() {
            mobileSelectedStations = [];
            updateMobileSelectedStationsInModal();
        });
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–æ
    if (mobileApplyMetroBtn) {
        mobileApplyMetroBtn.addEventListener('click', function() {
            if (mobileMetroHiddenInput) {
                mobileMetroHiddenInput.value = mobileSelectedStations.join(',');
                updateMobileSelectedStationsText();
            }
            closeAllMobileModals();
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    function updateMobileSelectedStationsInModal() {
        document.querySelectorAll('#mobile-metro-dropdown .metro-station-option').forEach(option => {
            const station = option.getAttribute('data-station');
            if (mobileSelectedStations.includes(station)) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
    function updateMobileSelectedStationsText() {
        const selectedMetroText = document.getElementById('mobile-selected-metro-text');
        if (!selectedMetroText) return;

        if (mobileSelectedStations.length === 0) {
            selectedMetroText.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ';
            return;
        }

        let html = '';
        mobileSelectedStations.slice(0, 2).forEach(station => {
            html += `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${station}</span>`;
        });

        if (mobileSelectedStations.length > 2) {
            html += `<span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">+${mobileSelectedStations.length - 2}</span>`;
        }

        selectedMetroText.innerHTML = html;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∏–Ω–∏–π –º–µ—Ç—Ä–æ –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    window.toggleMobileMetroLine = function(header) {
        const lineSection = header.closest('.metro-line-section');
        const stationsContainer = lineSection.querySelector('.metro-stations-container');
        const chevron = header.querySelector('.bi-chevron-down');

        const isExpanded = header.classList.contains('expanded');

        if (isExpanded) {
            stationsContainer.style.maxHeight = '0';
            header.classList.remove('expanded');
            chevron.classList.remove('rotate-180');
        } else {
            stationsContainer.style.maxHeight = stationsContainer.scrollHeight + 'px';
            header.classList.add('expanded');
            chevron.classList.add('rotate-180');
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateMobileSelectedStationsText();
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
function toggleMobileFilterSection(header) {
    const section = header.parentElement;
    const content = section.querySelector('.mobile-filter-content');
    const icon = header.querySelector('svg');

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.mobile-filter-section').forEach(otherSection => {
        if (otherSection !== section) {
            const otherContent = otherSection.querySelector('.mobile-filter-content');
            const otherIcon = otherSection.querySelector('svg');
            otherContent.classList.add('hidden');
            otherIcon.classList.remove('rotate-180');
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ–∫—Ü–∏—é
    content.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');
}

// –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
function resetMobileFilters() {
    const form = document.getElementById('mobile-filter-form');
    if (form) {
        form.reset();
        form.submit();
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function openActiveFilterSections() {
    const urlParams = new URLSearchParams(window.location.search);

    const sectionsToOpen = [];

    if (urlParams.has('search')) sectionsToOpen.push('–ü–æ–∏—Å–∫');
    if (urlParams.has('property_type')) sectionsToOpen.push('–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏');
    if (urlParams.has('rental_type')) sectionsToOpen.push('–í–∏–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
    if (urlParams.has('location')) sectionsToOpen.push('–ì–æ—Ä–æ–¥');
    if (urlParams.has('min_price') || urlParams.has('max_price')) sectionsToOpen.push('–¶–µ–Ω–∞');

    sectionsToOpen.forEach(sectionName => {
        document.querySelectorAll('.mobile-filter-section').forEach(section => {
            const header = section.querySelector('.font-medium');
            if (header && header.textContent.trim() === sectionName) {
                const content = section.querySelector('.mobile-filter-content');
                const icon = section.querySelector('svg');
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            }
        });
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    initMobileFilters();
    openActiveFilterSections();

    // –°–∫—Ä—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if (window.innerWidth < 1024) {
        const pcFilters = document.querySelector('.filter-sidebar');
        if (pcFilters) {
            pcFilters.style.display = 'none';
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', function() {
    const pcFilters = document.querySelector('.filter-sidebar');
    if (pcFilters) {
        if (window.innerWidth < 1024) {
            pcFilters.style.display = 'none';
        } else {
            pcFilters.style.display = 'block';
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
 function initMap() {
    console.log("[DEBUG] –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã");

    if (typeof ymaps === 'undefined') {
        console.error('[DEBUG] Yandex Maps API not loaded');
        setTimeout(initMap, 100);
        return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã
    const mapContainer = document.getElementById('all-properties-map');
    const mapWrapper = mapContainer.parentElement;
    mapWrapper.style.width = '1200px';
    mapWrapper.style.height = '300px';

    if (mapContainer.offsetHeight === 0) {
        mapContainer.style.height = mapWrapper.style.height || '500px';
    }

    ymaps.ready(function() {
        const allPropertiesMap = new ymaps.Map('all-properties-map', {
            center: [55.751574, 37.617635],
            zoom: 10,
            controls: ['zoomControl', 'geolocationControl']
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        allPropertiesMap.controls.get('geolocationControl').options.set({
            position: { top: '15px', right: '15px' },
            size: 'small',
            float: 'none',
            noPlacemark: false
        });

        // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        const objectManager = new ymaps.ObjectManager({
            clusterize: true,
            gridSize: 64,
            clusterDisableClickZoom: true
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
        objectManager.clusters.options.set({
            preset: 'islands#invertedDarkBlueClusterIcons',
            groupByCoordinates: false,
            clusterDisableClickZoom: true,
            clusterHideIconOnBalloonOpen: false,
            geoObjectHideIconOnBalloonOpen: false
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –º–µ—Ç–æ–∫
        objectManager.objects.options.set({
            preset: 'islands#darkBlueHomeIcon',
            balloonContentLayout: ymaps.templateLayoutFactory.createClass(
                `<div style="padding: 15px; max-width: 280px;">
                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                    <img src="$[properties.image]" style="width: 100%; height: 160px; object-fit: cover; margin-bottom: 12px; border-radius: 8px;">

                    <h3 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold; color: #1e293b;">$[properties.title]</h3>

                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-house" style="color: #64748b; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #374151;">$[properties.type]</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-arrows-fullscreen" style="color: #64748b; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #374151;">$[properties.area] –º¬≤</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-building" style="color: #64748b; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #374151;">$[properties.floor]</span>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ -->
                    <a href="$[properties.url]"
                       style="display: block; text-align: center; padding: 8px 12px; background: #2563eb; color: white; border-radius: 6px; font-weight: 500; text-decoration: none; margin-top: 12px; font-size: 14px;">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>`
            ),
            hideIconOnBalloonOpen: false,
            openBalloonOnClick: true,
            balloonAutoPan: true,
            balloonCloseButton: true
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ –º–µ–Ω–µ–¥–∂–µ—Ä
        const features = [];
        {% for property in properties %}
            {% if property.coordinates %}
                features.push({
                    type: 'Feature',
                    id: {{ property.id }},
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat('{{ property.coordinates.y|stringformat:"f" }}'.replace(',', '.')),
                                   parseFloat('{{ property.coordinates.x|stringformat:"f" }}'.replace(',', '.'))]
                    },
                    properties: {
                        title: '{{ property.title|escapejs }}',
                        type: '{% if property.property_type == "studio" %}–°—Ç—É–¥–∏—è{% else %}{{ property.rooms }}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è{% endif %}',
                        area: '{{ property.total_area }}',
                        floor: '{{ property.floor }}/{{ property.total_floors }} —ç—Ç–∞–∂',
                        image: '{{ property.main_image.url }}',
                        url: '{% url 'properties:property-detail' property.id %}'
                    }
                });
            {% endif %}
        {% endfor %}

        objectManager.add(features);
        allPropertiesMap.geoObjects.add(objectManager);

        // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        if (features.length > 0) {
            allPropertiesMap.setBounds(objectManager.getBounds(), {
                checkZoomRange: true,
                zoomMargin: 50
            });
        } else {
            allPropertiesMap.setCenter([55.751574, 37.617635], 10);
        }

        // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –±–∞–ª—É–Ω–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Å—à—Ç–∞–±–∞
        allPropertiesMap.events.add('boundschange', function(e) {
            const zoom = e.get('newZoom');

            // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞
            if (zoom < 12) {
                objectManager.objects.options.set({ visible: false });
                objectManager.clusters.options.set({ visible: true });
            } else {
                objectManager.objects.options.set({
                    visible: true,
                    preset: 'islands#darkBlueHomeIcon'
                });
                objectManager.clusters.options.set({ visible: false });
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –æ–±—ä–µ–∫—Ç—É - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É
        objectManager.objects.events.add('click', function(e) {
            const objectId = e.get('objectId');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –±–∞–ª—É–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–≥–æ
            objectManager.objects.balloon.close();

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            objectManager.objects.balloon.open(objectId, {
                autoPan: true,
                closeButton: true
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É - —Ç–æ–∂–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        objectManager.clusters.events.add('click', function(e) {
            // –ü—Ä–æ—Å—Ç–æ –∑—É–º–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä, –Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω—ã
            const cluster = e.get('target');
            allPropertiesMap.setCenter(cluster.geometry.getCoordinates(), allPropertiesMap.getZoom() + 2);
        });
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
function loadYandexMaps() {
    console.log("[DEBUG] –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ Yandex Maps API");

    const script = document.createElement('script');
    script.src = `https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU&onload=initMap`;
    script.type = 'text/javascript';

    script.onload = function() {
        console.log("[DEBUG] –°–∫—Ä–∏–ø—Ç Yandex Maps API —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω");
    };

    script.onerror = function() {
        console.error("[DEBUG] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ Yandex Maps API");
    };

    document.head.appendChild(script);
}

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
      console.log("[DEBUG] DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç");
      loadYandexMaps();

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      const filterToggle = document.querySelector('.filter-toggle');
      const filterSidebar = document.getElementById('filter-sidebar');

      if (filterToggle && filterSidebar) {
          filterToggle.addEventListener('click', function() {
              filterSidebar.classList.toggle('hidden');
          });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
      document.querySelectorAll('.toggle-favorite').forEach(button => {
          button.addEventListener('click', function(e) {
              e.preventDefault();
              const propertyId = this.getAttribute('data-property-id');
              const icon = this.querySelector('i');

              fetch(`/properties/${propertyId}/toggle-favorite/`, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': '{{ csrf_token }}',
                      'Accept': 'application/json',
                  },
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'added') {
                      icon.classList.add('bi-heart-fill', 'text-red-500');
                      icon.classList.remove('bi-heart');
                  } else {
                      icon.classList.remove('bi-heart-fill', 'text-red-500');
                      icon.classList.add('bi-heart');
                  }
              })
              .catch(error => console.error('Error:', error));
          });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ (–ü–ö –≤–µ—Ä—Å–∏—è) - –ò–ó–ú–ï–ù–ï–ù
      document.querySelectorAll('.city-option').forEach(option => {
          option.addEventListener('click', function() {
              const city = this.getAttribute('data-city');

              console.log(`–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥: ${city}`);

              // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
              document.getElementById('selected-city-text').textContent = city;
              document.getElementById('city-hidden-input').value = city;

              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –°–†–ê–ó–£
              loadMetroStationsForCity(city);

              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
              document.getElementById('city-dropdown').classList.add('hidden');
          });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ - –ò–ó–ú–ï–ù–ï–ù
      document.getElementById('use-custom-city')?.addEventListener('click', function() {
          const cityInput = document.getElementById('city-search');
          if (cityInput && cityInput.value.trim()) {
              const city = cityInput.value.trim();

              console.log(`–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥ —á–µ—Ä–µ–∑ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥: ${city}`);

              document.getElementById('selected-city-text').textContent = city;
              document.getElementById('city-hidden-input').value = city;

              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –°–†–ê–ó–£
              loadMetroStationsForCity(city);

              document.getElementById('city-dropdown').classList.add('hidden');
          }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
      const cityInput = document.getElementById('city-input');
      const cityDropdown = document.getElementById('city-dropdown');
      const citySearch = document.getElementById('city-search');
      const closeCityModal = document.getElementById('close-city-modal');
      const useCustomCityBtn = document.getElementById('use-custom-city');
      let customCity = '';

      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      cityInput.addEventListener('click', function(e) {
          e.preventDefault();
          cityDropdown.classList.remove('hidden');
          citySearch.focus();
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      closeCityModal.addEventListener('click', function() {
          cityDropdown.classList.add('hidden');
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      cityDropdown.addEventListener('click', function(e) {
          if (e.target === cityDropdown) {
              cityDropdown.classList.add('hidden');
          }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
      citySearch.addEventListener('input', function() {
          const searchTerm = this.value.trim();
          customCity = searchTerm;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
          if (searchTerm.length > 2) {
              useCustomCityBtn.classList.remove('hidden');
              useCustomCityBtn.textContent = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "${searchTerm}"`;
          } else {
              useCustomCityBtn.classList.add('hidden');
          }

          // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤
          document.querySelectorAll('.city-option').forEach(option => {
              const city = option.getAttribute('data-city').toLowerCase();
              if (city.includes(searchTerm.toLowerCase())) {
                  option.classList.remove('hidden');
              } else {
                  option.classList.add('hidden');
              }
          });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
      useCustomCityBtn.addEventListener('click', function() {
          if (customCity) {
              document.getElementById('selected-city-text').textContent = customCity;
              document.getElementById('city-hidden-input').value = customCity;
              cityDropdown.classList.add('hidden');
              document.getElementById('apply_filters').click();
          }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
      citySearch.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && customCity) {
              e.preventDefault();
              document.getElementById('selected-city-text').textContent = customCity;
              document.getElementById('city-hidden-input').value = customCity;
              cityDropdown.classList.add('hidden');
              document.getElementById('apply_filters').click();
          }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ–ª–µ
      cityInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
              e.preventDefault();
              document.getElementById('apply_filters').click();
          }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ
      const metroInput = document.getElementById('metro-input');
      const metroDropdown = document.getElementById('metro-dropdown');
      const metroSearch = document.getElementById('metro-search');
      const closeMetroModal = document.getElementById('close-metro-modal');
      const applyMetroBtn = document.getElementById('apply-metro-selection');
      const clearMetroBtn = document.getElementById('clear-metro-selection');
      const metroHiddenInput = document.getElementById('metro-hidden-input');
      const selectedMetroText = document.getElementById('selected-metro-text');

      let selectedStations = [];

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
      if (metroHiddenInput.value) {
          selectedStations = metroHiddenInput.value.split(',');
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç—Ä–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ä–æ–¥–∞
      metroInput.addEventListener('click', function(e) {
          e.preventDefault();

          const selectedCity = document.getElementById('city-hidden-input')?.value;
          if (!selectedCity) {
              showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥', 'warning');
              return;
          }

          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          ensureMetroStationsLoaded();

          metroDropdown.classList.remove('hidden');
          // metroSearch.focus();
          updateSelectedStationsInModal();
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      closeMetroModal.addEventListener('click', function() {
          metroDropdown.classList.add('hidden');
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      metroDropdown.addEventListener('click', function(e) {
          if (e.target === metroDropdown) {
              metroDropdown.classList.add('hidden');
          }
      });

      // –ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–π
  metroSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();

    document.querySelectorAll('.metro-line-section').forEach(section => {
        const header = section.querySelector('.metro-line-header');
        const stationsContainer = section.querySelector('.metro-stations-container');
        let hasVisibleStations = false;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏
        section.querySelectorAll('.metro-station-option').forEach(option => {
            const stationName = option.querySelector('.metro-station-name').textContent.toLowerCase();
            if (stationName.includes(searchTerm)) {
                option.classList.remove('hidden');
                hasVisibleStations = true;
            } else {
                option.classList.add('hidden');
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –ª–∏–Ω–∏—é
        if (searchTerm.length > 0) {
            if (hasVisibleStations) {
                section.classList.remove('hidden');
                header.classList.add('expanded');
                stationsContainer.classList.add('expanded');
                header.querySelector('.bi-chevron-down').classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
            }
        } else {
            section.classList.remove('hidden');
            header.classList.remove('expanded');
            stationsContainer.classList.remove('expanded');
            header.querySelector('.bi-chevron-down').classList.remove('rotate-180');
        }
    });
});

      // –í—ã–±–æ—Ä/–æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–Ω—Ü–∏–∏
       document.addEventListener('click', function(e) {
      if (e.target.closest('.metro-station-option')) {
          const option = e.target.closest('.metro-station-option');
          const station = option.querySelector('.metro-station-name').textContent;

          if (selectedStations.includes(station)) {
              selectedStations = selectedStations.filter(s => s !== station);
              option.classList.remove('selected');
          } else {
              if (selectedStations.length < 5) {
                  selectedStations.push(station);
                  option.classList.add('selected');
              } else {
                  alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Å—Ç–∞–Ω—Ü–∏–π');
              }
          }
      }
  });

      // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
      clearMetroBtn.addEventListener('click', function() {
          selectedStations = [];
          updateSelectedStationsInModal();
      });

      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
      applyMetroBtn.addEventListener('click', function() {
          metroHiddenInput.value = selectedStations.join(',');
          updateSelectedStationsText();
          metroDropdown.classList.add('hidden');
          document.getElementById('apply_filters').click();
      });

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      function updateSelectedStationsInModal() {
          document.querySelectorAll('.metro-station-option').forEach(option => {
              const station = option.getAttribute('data-station');
              if (selectedStations.includes(station)) {
                  option.classList.add('bg-blue-100', 'border-blue-500');
                  option.classList.remove('border-gray-200', 'hover:bg-gray-50');
              } else {
                  option.classList.remove('bg-blue-100', 'border-blue-500');
                  option.classList.add('border-gray-200', 'hover:bg-gray-50');
              }
          });
      }

      // –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é updateSelectedStationsText:
  function updateSelectedStationsText() {
      const selectedStations = metroHiddenInput.value ?
          metroHiddenInput.value.split(',') : [];

      if (selectedStations.length === 0) {
          selectedMetroText.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ';
          return;
      }

      let html = '';
      selectedStations.slice(0, 3).forEach(station => {
          html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      ${station}
                  </span>`;
      });

      if (selectedStations.length > 3) {
          html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                      +${selectedStations.length - 3}
                  </span>`;
      }

      selectedMetroText.innerHTML = html;
  }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      updateSelectedStationsText();

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –≥–æ—Ä–æ–¥ —É–∂–µ –≤—ã–±—Ä–∞–Ω
      const selectedCity = document.getElementById('city-hidden-input')?.value;
      if (selectedCity) {
          console.log('–ì–æ—Ä–æ–¥ —É–∂–µ –≤—ã–±—Ä–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ:', selectedCity);
          loadMetroStationsForCity(selectedCity);
      }

      const mobileSelectedCity = document.getElementById('mobile-city-hidden-input')?.value;
      if (mobileSelectedCity) {
          console.log('–ì–æ—Ä–æ–¥ —É–∂–µ –≤—ã–±—Ä–∞–Ω –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ:', mobileSelectedCity);
          loadMobileMetroStationsForCity(mobileSelectedCity);
      }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
  function updateMapStatus(status) {
      const statusElement = document.getElementById('map-status-text');
      if (statusElement) {
          statusElement.textContent = status;

          // –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
          if (status.includes('—É—Å–ø–µ—à–Ω–æ')) {
              statusElement.style.color = 'green';
          } else if (status.includes('–æ—à–∏–±–∫–∞')) {
              statusElement.style.color = 'red';
          } else {
              statusElement.style.color = 'orange';
          }
      }
  }
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ
function toggleMetroLine(header) {
    const lineSection = header.closest('.metro-line-section');
    const stationsContainer = lineSection.querySelector('.metro-stations-container');
    const chevron = header.querySelector('.bi-chevron-down');
    const linesContainer = document.querySelector('.metro-lines-container');

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
    const wasExpanded = header.classList.contains('expanded');

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ª–∏–Ω–∏–∏
    document.querySelectorAll('.metro-line-section').forEach(section => {
        if (section !== lineSection) {
            section.querySelector('.metro-stations-container').style.maxHeight = '0';
            section.querySelector('.metro-line-header').classList.remove('expanded');
            section.querySelector('.bi-chevron-down').classList.remove('rotate-180');
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–∏–Ω–∏—é
    if (!wasExpanded) {
        stationsContainer.style.maxHeight = '300px';
        header.classList.add('expanded');
        chevron.classList.add('rotate-180');

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤–∏–¥–∏–º—ã–º
        const containerRect = linesContainer.getBoundingClientRect();
        const headerRect = header.getBoundingClientRect();

        // –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–∏–∑–∫–æ –∫ –≤–µ—Ä—Ö—É, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –≤–Ω–∏–∑
        if (headerRect.top < containerRect.top + 50) {
            linesContainer.scrollBy({
                top: headerRect.top - containerRect.top - 50,
                behavior: 'smooth'
            });
        }
    } else {
        stationsContainer.style.maxHeight = '0';
        header.classList.remove('expanded');
        chevron.classList.remove('rotate-180');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ª–∏–Ω–∏–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏
    const selectedStations = document.getElementById('metro-hidden-input').value
        ? document.getElementById('metro-hidden-input').value.split(',')
        : [];

    if (selectedStations.length > 0) {
        document.querySelectorAll('.metro-station-option').forEach(option => {
            if (selectedStations.includes(option.getAttribute('data-station'))) {
                const lineSection = option.closest('.metro-line-section');
                const stationsContainer = lineSection.querySelector('.metro-stations-container');
                const header = lineSection.querySelector('.metro-line-header');

                header.classList.add('expanded');
                stationsContainer.style.maxHeight = '300px';
                lineSection.querySelector('.bi-chevron-down').classList.add('rotate-180');
            }
        });
    }


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–Ω—Ü–∏–∏
    document.addEventListener('click', function(e) {
        const stationOption = e.target.closest('.metro-station-option');
        if (stationOption) {
            e.preventDefault();
            const station = stationOption.getAttribute('data-station');
            let selectedStations = document.getElementById('metro-hidden-input').value
                ? document.getElementById('metro-hidden-input').value.split(',')
                : [];

            if (selectedStations.includes(station)) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω—Ü–∏—é
                selectedStations = selectedStations.filter(s => s !== station);
                stationOption.classList.remove('bg-blue-100', 'text-blue-800');
                stationOption.classList.add('hover:bg-gray-200');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω—Ü–∏—é (–º–∞–∫—Å–∏–º—É–º 5)
                if (selectedStations.length < 5) {
                    selectedStations.push(station);
                    stationOption.classList.add('bg-blue-100', 'text-blue-800');
                    stationOption.classList.remove('hover:bg-gray-200');
                } else {
                    alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Å—Ç–∞–Ω—Ü–∏–π');
                    return;
                }
            }

            document.getElementById('metro-hidden-input').value = selectedStations.join(',');
            updateSelectedStationsText();
        }
    });

    function updateSelectedStationsText() {
        const selectedStations = document.getElementById('metro-hidden-input').value
            ? document.getElementById('metro-hidden-input').value.split(',')
            : [];
        const selectedMetroText = document.getElementById('selected-metro-text');

        if (selectedStations.length === 0) {
            selectedMetroText.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ';
            return;
        }

        let html = '';
        selectedStations.slice(0, 3).forEach(station => {
            html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">
                        ${station}
                    </span>`;
        });

        if (selectedStations.length > 3) {
            html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        +${selectedStations.length - 3}
                    </span>`;
        }

        selectedMetroText.innerHTML = html;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ª–∏–Ω–∏–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏
    const selectedStations = document.getElementById('metro-hidden-input').value
        ? document.getElementById('metro-hidden-input').value.split(',')
        : [];

    if (selectedStations.length > 0) {
        document.querySelectorAll('.metro-station-option').forEach(option => {
            if (selectedStations.includes(option.getAttribute('data-station'))) {
                const lineSection = option.closest('.metro-line-section');
                const stationsContainer = lineSection.querySelector('.metro-stations-container');
                const header = lineSection.querySelector('.metro-line-header');

                header.classList.add('expanded');
                stationsContainer.style.maxHeight = stationsContainer.scrollHeight + 'px';
                lineSection.querySelector('.bi-chevron-down').classList.add('rotate-180');
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const searchForm = document.querySelector('.search-form');
    let suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden';
    searchForm.appendChild(suggestionsContainer);

    const propertyTypes = {
        '–ö–≤–∞—Ä—Ç–∏—Ä–∞': 'apartment',
        '–î–æ–º': 'house',
        '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è': 'commercial',
        '–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞': 'new_flat',
        '–í—Ç–æ—Ä–∏—á–∫–∞': 'resale_flat'
    };

    const cities = [
        '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
        '–ö–∞–∑–∞–Ω—å', '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–ß–µ–ª—è–±–∏–Ω—Å–∫',
        '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–ü–µ—Ä–º—å', '–í–æ—Ä–æ–Ω–µ–∂',
        '–í–æ–ª–≥–æ–≥—Ä–∞–¥', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–°–æ—á–∏'
    ];

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        suggestionsContainer.innerHTML = '';

        if (query.length < 2) {
            suggestionsContainer.classList.add('hidden');
            return;
        }

        let suggestions = '';

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        Object.keys(propertyTypes).forEach(type => {
            if (type.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-type="${propertyTypes[type]}">${type}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
        cities.forEach(city => {
            if (city.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-city="${city}">${city}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        if (/—Ü–µ–Ω–∞\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ 5-10 –º–ª–Ω">—Ü–µ–Ω–∞ 5-10 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω">—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω">—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω</div>`;
        }

        if (/–ø–ª–æ—â–∞–¥—å\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤">–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤">–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤</div>`;
        }

        if (query.toLowerCase().includes('—Ä—è–¥–æ–º') || query.toLowerCase().includes('–Ω–µ–¥–∞–ª–µ–∫–æ')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-geo="true">—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π</div>`;
        }

        if (query.toLowerCase().includes('–∫–æ–º–Ω–∞—Ç')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
        }

        // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        if (query.toLowerCase().includes('–∫–≤–∞—Ä—Ç–∏—Ä')) {
            cities.forEach(city => {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-query="${query.split(' ')[0]} –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ ${city}">${query.split(' ')[0]} –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ ${city}</div>`;
            });
        }

        if (query.toLowerCase().includes('–∞—Ä–µ–Ω–¥') || query.toLowerCase().includes('—Å–Ω—è—Ç—å')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã">–∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã</div>`;
            cities.forEach(city => {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-query="–∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ ${city}">–∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ ${city}</div>`;
            });
        }

        if (query.toLowerCase().includes('–∫—É–ø') || query.toLowerCase().includes('–ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É">–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É</div>`;
            cities.forEach(city => {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-query="–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ ${city}">–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ ${city}</div>`;
            });
        }

        if (suggestions) {
            suggestionsContainer.innerHTML = suggestions;
            suggestionsContainer.classList.remove('hidden');
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    suggestionsContainer.addEventListener('click', function(e) {
        const suggestion = e.target.closest('[data-type], [data-city], [data-query], [data-geo]');
        if (!suggestion) return;

        if (suggestion.hasAttribute('data-type')) {
            const type = suggestion.getAttribute('data-type');
            searchInput.value = suggestion.textContent;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
            document.querySelector(`input[value="${type}"]`).checked = true;
            document.getElementById('apply_filters').click();
        }
        else if (suggestion.hasAttribute('data-city')) {
            const city = suggestion.getAttribute('data-city');
            searchInput.value = city;
            document.getElementById('city-hidden-input').value = city;
            document.getElementById('selected-city-text').textContent = city;
            document.getElementById('apply_filters').click();
        }
        else if (suggestion.hasAttribute('data-query')) {
            searchInput.value = suggestion.getAttribute('data-query');
            document.getElementById('apply_filters').click();
        }
        else if (suggestion.hasAttribute('data-geo')) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    searchInput.value = `—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∞–¥–∏—É—Å—É
                    document.getElementById('apply_filters').click();
                });
            } else {
                searchInput.value = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            }
        }

        suggestionsContainer.classList.add('hidden');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(e) {
        if (!searchForm.contains(e.target)) {
            suggestionsContainer.classList.add('hidden');
        }
    });
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–∏–ø—Å–æ–≤ —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –≤–∏–¥–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–∏–ø—Å–æ–≤ —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –≤–∏–¥–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–∏–ø—Å–æ–≤
    document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', function(e) {
            e.preventDefault();
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('active', checkbox.checked);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                setTimeout(() => {
                    document.getElementById('filter-form').submit();
                }, 300);
            }
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∏–ø—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        const chip = checkbox.closest('.chip');
        if (chip) {
            chip.classList.toggle('active', checkbox.checked);
        }
    });
});
// –°–∫—Ä—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
if (window.innerWidth < 1024) {
    const pcFilters = document.querySelector('aside.w-full.lg\\:w-80');
    if (pcFilters) {
        pcFilters.style.display = 'none';
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', function() {
    const pcFilters = document.querySelector('aside.w-full.lg\\:w-80');
    const mobileFiltersBtn = document.getElementById('mobile-filters-btn');

    if (window.innerWidth < 1024) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —Å–∫—Ä—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (pcFilters) pcFilters.style.display = 'none';
        if (mobileFiltersBtn) mobileFiltersBtn.style.display = 'block';
    } else {
        // –ù–∞ –ü–ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ü–ö —Ñ–∏–ª—å—Ç—Ä—ã, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (pcFilters) pcFilters.style.display = 'block';
        if (mobileFiltersBtn) mobileFiltersBtn.style.display = 'none';
    }
});

</script>


{% endblock %}