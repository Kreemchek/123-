{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load support_tags %}
{% block content %}
{% if messages %}
<div class="fixed top-4 right-4 z-50">
    {% for message in messages %}
    <div class="bg-red-100 text-red-700 px-4 py-2 rounded-lg shadow-md flex items-center justify-between mb-2">
        {{ message }}
        <button onclick="this.parentElement.remove()">×</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
    /* Стили для кастомного скроллбара */
    .chat-messages-container::-webkit-scrollbar {
        width: 8px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }

    .chat-messages-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #7b61ff, #36d1dc);
        border-radius: 4px;
    }

    .chat-messages-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #6a50e6, #2bb7c2);
    }

    .chat-messages-container {
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: #7b61ff #f5f5f5;
    }
.rating-stars label {
    cursor: pointer;
    transition: all 0.2s ease;
}

.rating-stars label i {
    color: #d1d5db;
    transition: all 0.2s ease-in-out;
    -webkit-text-stroke: 1px transparent;
}

/* Наведение мыши */
.rating-stars label i.hovered {
    color: #f59e0b !important;
    -webkit-text-stroke: 1px #f59e0b;
}

/* Активная звезда */
.rating-stars label i.active-star {
    color: #f59e0b !important;
    -webkit-text-stroke: 1px #f59e0b;
}

/* Стили для кнопок и элементов с градиентом */
.gradient-bg {
    background: linear-gradient(135deg, #7b61ff, #36d1dc);
}

.gradient-text {
    background: linear-gradient(135deg, #7b61ff, #36d1dc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.gradient-border:focus {
    border-color: #7b61ff !important;
    box-shadow: 0 0 0 3px rgba(123, 97, 255, 0.2);
}

.gradient-button {
    background: linear-gradient(135deg, #7b61ff, #36d1dc);
    color: white;
    border: none;
    border-radius: 50rem;
    padding: 1rem 2rem;
    font-weight: 500;
    font-size: 16px;
    transition: all 0.2s ease;
}

.gradient-button:hover {
    background: linear-gradient(135deg, #6a50e6, #2bb7c2);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(123, 97, 255, 0.3);
}

.custom-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 50rem;
    font-size: 16px;
    transition: all 0.2s ease;
}

.custom-input:focus {
    border-color: #7b61ff !important;
    box-shadow: 0 0 0 3px rgba(123, 97, 255, 0.2);
    outline: none;
}
</style>


<div class="max-w-4xl mx-auto p-4 sm:p-6 bg-white rounded-2xl shadow-md border border-purple-100 mt-6">
    <!-- Заголовок -->
    <div class="text-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold gradient-text">
    <i class="fas fa-comments mr-2"></i>Чат с {% if object.broker == request.user %}{{ object.requester.get_full_name }}{% else %}{{ object.broker.get_full_name }}{% endif %}
</h1>
        <span class="inline-block mt-2 px-4 py-1 text-sm font-semibold rounded-full border-2
                     {% if object.status == 'new' %}border-purple-500 bg-purple-50 text-purple-600
                     {% elif object.status == 'in_progress' %}border-purple-300 bg-purple-50 text-purple-500
                     {% else %}border-green-500 bg-green-50 text-green-600{% endif %}">
            {{ object.get_status_display }}
        </span>
    </div>

    <!-- Сообщения со скроллером -->
    <div class="relative">
        <div class="chat-messages-container border border-gray-200 rounded-xl p-4 mb-6 max-h-[60vh] overflow-y-auto bg-white">
            {% for message in chat_messages %}
            <div class="mb-4 p-4 rounded-lg border transition-all
                        {% if message.sender == request.user %}border-purple-400 bg-purple-50 shadow-sm{% else %}border-gray-200 bg-white{% endif %}">
                <div class="flex items-start gap-3 mb-2">
                    {% if message.sender.avatar %}
                        <img src="{{ message.sender.avatar.url }}" class="w-12 h-12 rounded-full border-2 border-purple-500 object-cover">
                    {% else %}
                        <div class="w-12 h-12 flex items-center justify-center bg-purple-100 text-purple-500 rounded-full">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    <div>
                        <p class="font-semibold text-sm">
                            {% if message.sender == request.user %}Вы{% else %}{{ message.sender.get_full_name }}{% endif %}
                        </p>
                        <p class="text-xs text-gray-500">{{ message.created_at|date:"d M Y H:i" }}</p>
                    </div>
                </div>
                <p class="text-gray-800 text-sm">{{ message.text }}</p>
                {% if message.attachment %}
                <a href="{{ message.attachment.url }}" target="_blank"
                   class="inline-flex items-center gradient-text text-sm mt-2 hover:underline">
                    <i class="fas fa-paperclip mr-1"></i>{{ message.get_filename }}
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Кнопки скролла -->
        <div class="absolute right-6 bottom-6 space-y-2">
            <button onclick="scrollToBottom()" id="scrollDownBtn"
                    class="w-10 h-10 gradient-bg text-white rounded-full shadow-lg hover:from-purple-700 hover:to-teal-600 transition-all flex items-center justify-center">
                <i class="fas fa-chevron-down"></i>
            </button>
            <button onclick="scrollToTop()" id="scrollUpBtn"
                    class="w-10 h-10 gradient-bg text-white rounded-full shadow-lg hover:from-purple-700 hover:to-teal-600 transition-all flex items-center justify-center">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
    </div>

    <!-- Управление статусом -->
    {% if object.broker == request.user %}
    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
        {% if object.status == 'new' %}
        <form method="post" action="{% url 'update_request_status' object.pk 'in_progress' %}">
            {% csrf_token %}
            <button type="submit"
                    class="w-full sm:w-auto gradient-button">
                <i class="fas fa-play-circle mr-2"></i>Принять в работу
            </button>
        </form>
        {% elif object.status == 'in_progress' %}
        <form method="post" action="{% url 'update_request_status' object.pk 'completed' %}">
            {% csrf_token %}
            <button type="submit"
                    class="w-full sm:w-auto gradient-button">
                <i class="fas fa-check-circle mr-2"></i>Завершить
            </button>
        </form>
        {% endif %}
    </div>
    {% endif %}

    <!-- Форма сообщения -->
    {% if object.status != 'completed' %}
    <div class="bg-gray-50 border rounded-xl p-4 mb-6">
        <form method="post" action="{% url 'add_message' object.pk %}" enctype="multipart/form-data" id="messageForm">
            {% csrf_token %}
            <div class="flex items-center gap-3 mb-3">
                <input type="file" name="attachment" id="fileInput" class="hidden">
                <label for="fileInput"
                       class="cursor-pointer bg-purple-100 px-4 py-2 rounded-lg hover:bg-purple-200">
                    <i class="fas fa-paperclip gradient-text"></i>
                </label>
                <span id="fileName" class="text-sm text-gray-500"></span>
            </div>
            <textarea name="text" rows="4"
                      class="custom-input"
                      placeholder="Напишите сообщение..." required></textarea>
            <button type="submit"
        class="mt-4 w-full gradient-button"
        id="submitBtn">
                <i class="fas fa-paper-plane mr-2"></i>Отправить сообщение
            </button>
        </form>
    </div>
    {% else %}
    <div class="bg-red-100 text-red-700 p-3 rounded-lg mb-4 flex items-center justify-between">
        <i class="fas fa-exclamation-circle mr-2"></i>Чат завершен, отправка сообщений невозможна
        <button onclick="this.parentElement.remove()">×</button>
    </div>
    {% endif %}

    <!-- История статусов -->
    <div class="border rounded-xl p-4 bg-white">
        <h3 class="text-xl font-bold gradient-text mb-4">
            <i class="fas fa-history mr-2"></i>История статусов
        </h3>
        <div class="space-y-2">
            {% for log in object.status_logs.all %}
            <div class="flex items-center gap-3 text-sm text-gray-600 bg-purple-50 p-2 rounded-lg">
                <i class="fas fa-clock text-gray-400"></i>
                {{ log.timestamp|date:"d M Y H:i" }} —
                <span class="font-medium">{{ log.get_status_display }}</span>
            </div>
            {% empty %}
            <div class="text-center text-gray-400 py-4">
                <i class="fas fa-ban mr-2"></i>Нет истории изменений
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Форма отзыва -->
    {% if object.status == 'completed' and not has_review and request.user == object.requester and not object.is_consultation %}
<div class="bg-yellow-50 p-6 rounded-2xl mt-6">
    <h3 class="text-xl font-bold mb-4">Оставьте отзыв о работе брокера</h3>
    <form method="post" action="{% url 'submit_review' object.pk %}">
        {% csrf_token %}
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Оценка:</label>
            <div class="rating-stars flex gap-2">
                {% for i in "12345" %}
                <input type="radio"
                       name="rating"
                       value="{{ i }}"
                       id="star-{{ i }}"
                       class="hidden"
                       required>
                <label for="star-{{ i }}"
                       class="cursor-pointer text-2xl transition-all">
                    <i class="fas fa-star"></i>
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="mb-4">
            <textarea name="comment" rows="4"
                class="custom-input"
                placeholder="Ваш отзыв..." required></textarea>
        </div>
        <button type="submit"
            class="w-full gradient-button">
            Отправить отзыв
        </button>
    </form>
</div>
{% endif %}
{% if object.status == 'completed' %}
<div class="bg-purple-50 p-6 rounded-2xl mt-6 text-center">
    <h3 class="text-xl font-bold mb-4">Есть вопросы? Напишите нам</h3>
    <div class="flex justify-center">
        <a href="{% url 'contact_support' %}?is_support=true"
           class="gradient-button">
            Написать в поддержку
        </a>
    </div>
</div>
{% endif %}

</div>

<script>
    // Показ имени файла
    document.getElementById('fileInput')?.addEventListener('change', function () {
        const fileName = this.files[0]?.name || '';
        document.getElementById('fileName').textContent = fileName;
    });

    // Автоскролл вниз при загрузке
    const container = document.querySelector('.chat-messages-container');
    if (container) container.scrollTop = container.scrollHeight;

    // ✅ Исправленная логика работы рейтинга
    function setupRatingStars() {
        const ratingContainer = document.querySelector('.rating-stars');
        if (!ratingContainer) return;

        const stars = Array.from(ratingContainer.querySelectorAll('label'));
        const inputs = Array.from(ratingContainer.querySelectorAll('input[type="radio"]'));

        const updateStars = (selectedCount) => {
            stars.forEach((star, index) => {
                const icon = star.querySelector('i');
                if (index < selectedCount) {
                    icon.classList.add('active-star');
                } else {
                    icon.classList.remove('active-star');
                }
                icon.classList.remove('hovered');
            });
        };

        stars.forEach((star, index) => {
            // Наведение
            star.addEventListener('mouseenter', () => {
                stars.forEach((s, i) => {
                    const icon = s.querySelector('i');
                    if (i <= index) {
                        icon.classList.add('hovered');
                    } else {
                        icon.classList.remove('hovered');
                    }
                });
            });

            // Клик
            star.addEventListener('click', () => {
                const inputId = star.getAttribute('for');
                const input = document.getElementById(inputId);
                if (input) {
                    input.checked = true;
                    updateStars(index + 1);
                }
            });
        });

        ratingContainer.addEventListener('mouseleave', () => {
            const checkedInput = ratingContainer.querySelector('input:checked');
            if (checkedInput) {
                const checkedIndex = inputs.indexOf(checkedInput);
                updateStars(checkedIndex + 1);
            } else {
                updateStars(0);
            }
        });

        // Инициализация при загрузке
        const checkedInput = ratingContainer.querySelector('input:checked');
        if (checkedInput) {
            const checkedIndex = inputs.indexOf(checkedInput);
            updateStars(checkedIndex + 1);
        }
    }

    function setupChatScroll() {
        const messagesContainer = document.querySelector('.chat-messages-container');
        const scrollUpBtn = document.getElementById('scrollUpBtn');
        const scrollDownBtn = document.getElementById('scrollDownBtn');

        if (!messagesContainer || !scrollUpBtn || !scrollDownBtn) return;

        const updateScrollButtons = () => {
            const isAtTop = messagesContainer.scrollTop === 0;
            const isAtBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >=
                             messagesContainer.scrollHeight - 1;
            scrollUpBtn.style.display = isAtTop ? 'none' : 'flex';
            scrollDownBtn.style.display = isAtBottom ? 'none' : 'flex';
        };

        messagesContainer.addEventListener('scroll', updateScrollButtons);
        window.addEventListener('resize', updateScrollButtons);
        updateScrollButtons();

        window.scrollToBottom = () => {
            messagesContainer.scrollTo({top: messagesContainer.scrollHeight, behavior: 'smooth'});
        };

        window.scrollToTop = () => {
            messagesContainer.scrollTo({top: 0, behavior: 'smooth'});
        };
    }

    function setupMessageForm() {
        const form = document.getElementById('messageForm');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const btn = document.getElementById('submitBtn');
            const messagesContainer = document.querySelector('.chat-messages-container');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                });

                if (response.ok) {
                    form.reset();
                    document.getElementById('fileName').textContent = '';
                    const newMessageHtml = await response.text();
                    messagesContainer.insertAdjacentHTML('beforeend', newMessageHtml);
                    scrollToBottom();

                    // Простое уведомление об успешной отправке
                    alert('Сообщение успешно отправлено');
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Ошибка при отправке сообщения');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке сообщения');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Отправить сообщение';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupRatingStars();
        setupChatScroll();
        setupMessageForm();
    });
</script>

{% endblock %}