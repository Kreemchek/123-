{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .category-card { animation: fadeIn 0.6s ease; }
    .gradient-bg { background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    #search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        border: 1px solid #e5e7eb;
        border-top: none;
    }
    #search-suggestions div {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }
    #search-suggestions div:hover {
        background-color: #f9fafb;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    #filters-modal {
        transition: opacity 0.3s ease;
    }
    #filters-modal > div {
        transition: transform 0.3s ease;
    }
    #filters-modal:not(.hidden) {
        display: flex;
        opacity: 1;
    }
    #filters-modal:not(.hidden) > div {
        transform: translateY(0);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .toast {
        animation: slideIn 0.3s ease forwards;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
        /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Å—Ç–∏–ª–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫ style */
    .hot-property-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(45deg, #ff4d4d, #f95700);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .hot-property-card {
        border: 2px solid #ff4d4d;
        transition: all 0.3s ease;
    }

    .hot-property-card:hover {
        box-shadow: 0 10px 20px rgba(255, 77, 77, 0.2);
    }
</style>

<!-- –ì–µ—Ä–æ–π-—Å–µ–∫—Ü–∏—è -->
<div class="hero bg-blue-600 text-white py-20">
    <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 animate-pulse">–°–µ—Ä–≤–∏—Å –≤—ã–≥–æ–¥–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ —Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é</h1>
        <p class="text-xl mb-8 opacity-95">–ë–∞–∑–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –±—Ä–æ–∫–µ—Ä–æ–≤ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>

        <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="max-w-3xl mx-auto bg-white rounded-xl p-2 shadow-2xl">
            <form class="flex flex-col" id="search-form"
                  action="{% if user.is_authenticated %}{% url 'properties:property-list' %}{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}{% endif %}"
                  method="get">
                <div class="relative flex items-center">
                    <input type="text"
                           name="search"
                           placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, –º–µ—Ç—Ä–æ, '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '—Ü–µ–Ω–∞ 5-10 –º–ª–Ω', '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π'..."
                           class="flex-grow px-6 py-4 rounded-lg text-gray-800 border-0 focus:ring-4 focus:ring-blue-200"
                           id="location-search"
                           autocomplete="off">

                    <button type="button" id="geolocation-btn" class="absolute right-16 text-gray-500 hover:text-blue-600">
                        <i class="fas fa-location-arrow"></i>
                    </button>

                    <button type="submit"
                            class="bg-blue-700 hover:bg-blue-800 px-6 py-4 rounded-lg
                                   font-bold text-white transition-all duration-300
                                   transform hover:scale-105 ml-2">
                        –ù–∞–π—Ç–∏
                    </button>
                </div>

                <div id="search-suggestions" class="hidden bg-white mt-1 rounded-lg shadow-lg z-10 max-h-60 overflow-auto">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                </div>

                <div class="text-xs text-gray-500 mt-2 pl-2">

                </div>

                <button type="button" id="show-filters" class="mt-2 text-blue-600 text-sm font-medium self-start flex items-center">
                    <i class="fas fa-sliders-h mr-2"></i> –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </form>

            <!-- –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
            <input type="hidden" id="geo-coords" name="radius_filter">
        </div>
    </div>
</div>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div class="container mx-auto px-4 py-16">
    <h2 class="text-4xl font-bold text-center mb-16">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- –ë—Ä–æ–∫–µ—Ä—ã -->
        <a href="{% if user.is_authenticated %}{% url 'broker-list' %}{% else %}{% url 'register' %}?next={% url 'broker-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-blue-600 flex items-center justify-center">
                    <i class="fas fa-user-tie text-white text-6xl"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–ë—Ä–æ–∫–µ—Ä—ã</h3>
                    <p class="text-gray-600">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é</p>
                </div>
            </div>
        </a>

        <!-- –û–±—ä–µ–∫—Ç—ã -->
        <a href="{% if user.is_authenticated %}{% url 'properties:property-list' %}{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-orange-500 flex items-center justify-center relative">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                        <i class="fas fa-home text-white text-6xl"></i>
                    </div>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–û–±—ä–µ–∫—Ç—ã</h3>
                    <p class="text-gray-600">–í—Å—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</p>
                </div>
            </div>
        </a>

        <!-- –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏ -->
        <a href="{% if user.is_authenticated %}{% url 'developer-list' %}{% else %}{% url 'register' %}?next={% url 'developer-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-green-600 flex items-center justify-center">
                    <i class="fas fa-building text-white text-6xl"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</h3>
                    <p class="text-gray-600">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤</p>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã -->
<!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã -->
<!-- –ì–æ—Ä—è—á–∏–µ –æ–±—ä–µ–∫—Ç—ã -->
<!-- –ì–æ—Ä—è—á–∏–µ –æ–±—ä–µ–∫—Ç—ã -->
<!-- –ì–æ—Ä—è—á–∏–µ –æ–±—ä–µ–∫—Ç—ã -->

    <div class="container mx-auto px-4">
        <div class="rounded-3xl border-2 border-red-500 p-6">
            <h2 class="text-4xl font-bold text-center mb-12">üî• –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for property in hot_properties %}
                <div class="bg-white rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 overflow-hidden border-2 border-red-500">
                    <div class="relative h-64 overflow-hidden group">
                        {% if property.main_image %}
                            <img src="{{ property.main_image.url }}"
                                 alt="{{ property.title }}"
                                 class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        {% else %}
                            <div class="w-full h-full bg-gradient-to-r from-red-400 to-red-600 flex items-center justify-center">
                                <i class="fas fa-fire text-white text-6xl"></i>
                            </div>
                        {% endif %}

                        <div class="absolute top-4 right-4 bg-gradient-to-r from-red-500 to-red-700 text-white px-4 py-2
                                   rounded-full text-sm font-bold shadow-md">
                            üî• HOT
                        </div>
                    </div>

                    <div class="p-6">
                        <h3 class="text-2xl font-bold mb-3">{{ property.title }}</h3>
                        <div class="flex items-center mb-4 text-gray-600">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span>{{ property.location }}</span>
                        </div>

                        <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ç—Ä–æ –∏ –∫–æ–º–Ω–∞—Ç–∞—Ö -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            {% if property.metro_station %}
                            <div class="flex items-center text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                <i class="fas fa-subway mr-2"></i>
                                {{ property.metro_station }}
                            </div>
                            {% endif %}

                            <div class="flex items-center text-sm bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                                <i class="fas fa-door-open mr-2"></i>
                                {{ property.rooms }} –∫–æ–º–Ω.
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl font-bold text-red-600">{{ property.price|floatformat:"0" }} ‚ÇΩ</span>
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full">
                                {{ property.total_area|floatformat:"0" }} –º¬≤
                            </span>
                        </div>

                        <a href="{% if user.is_authenticated %}{% url 'properties:property-detail' property.id %}{% else %}{% url 'register' %}?next={% url 'properties:property-detail' property.id %}{% endif %}"
                           class="block w-full bg-red-600 hover:bg-red-700 text-white text-center py-3 rounded-xl
                                  transition-all transform hover:scale-105">
                            üî• –£–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" -->
            <div class="text-center mt-12">
                <a href="{% if user.is_authenticated %}{% url 'properties:property-list' %}?is_hot=true{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}?is_hot=true{% endif %}"
                   class="inline-block bg-gradient-to-r from-red-600 to-red-700 text-white font-bold px-12 py-4
                          rounded-2xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
                    –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div id="filters-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">–£—Ç–æ—á–Ω–∏—Ç—å –ø–æ–∏—Å–∫</h3>
            <button id="close-filters" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                <select name="property_type" class="w-full p-2 border rounded">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="new_flat">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</option>
                    <option value="resale_flat">–í—Ç–æ—Ä–∏—á–∫–∞</option>
                    <option value="house">–î–æ–º</option>
                    <option value="commercial">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_price" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_price" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_area" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_area" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                <div class="flex space-x-2">
                    <input type="number" name="rooms__gte" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="rooms__lte" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–≠—Ç–∞–∂</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_floor" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_floor" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <button type="button" id="apply-filters" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('location-search');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const geolocationBtn = document.getElementById('geolocation-btn');
    const geoCoordsInput = document.getElementById('geo-coords');
    const showFiltersBtn = document.getElementById('show-filters');
    const filtersModal = document.getElementById('filters-modal');
    const closeFiltersBtn = document.getElementById('close-filters');
    const applyFiltersBtn = document.getElementById('apply-filters');

    // –¢–∏–ø—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    const propertyTypes = {
        '–∫–≤–∞—Ä—Ç–∏—Ä–∞': ['new_flat', 'resale_flat'],
        '—Å—Ç—É–¥–∏—è': 'studio',
        '–¥–æ–º': 'house',
        '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è': 'commercial',
        '–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞': 'new_flat',
        '–≤—Ç–æ—Ä–∏—á–∫–∞': 'resale_flat'
    };

    // –ì–æ—Ä–æ–¥–∞ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    const cities = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
                   '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–ú–∞–≥–∞–¥–∞–Ω'];

    // –¢–∏–ø—ã —Å–¥–µ–ª–æ–∫
    const dealTypes = {
        '–∞—Ä–µ–Ω–¥–∞': ['monthly', 'daily'],
        '—Å–Ω—è—Ç—å': ['monthly', 'daily'],
        '–∫—É–ø–∏—Ç—å': 'no',
        '–ø—Ä–æ–¥–∞–∂–∞': 'no'
    };

    // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (query.length < 2) {
            suggestionsContainer.classList.add('hidden');
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        let suggestions = '';

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        Object.keys(propertyTypes).forEach(type => {
            if (type.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-type="${type}">${type}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
        cities.forEach(city => {
            if (city.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-city="${city}">${city}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∞–º —Å–¥–µ–ª–æ–∫
        Object.keys(dealTypes).forEach(deal => {
            if (deal.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-deal="${deal}">${deal}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        if (/—Ü–µ–Ω–∞\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ 5-10 –º–ª–Ω">—Ü–µ–Ω–∞ 5-10 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω">—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω">—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω</div>`;
        }

        if (/–ø–ª–æ—â–∞–¥—å\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤">–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤">–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤</div>`;
        }

        if (query.toLowerCase().includes('—Ä—è–¥–æ–º') || query.toLowerCase().includes('–Ω–µ–¥–∞–ª–µ–∫–æ')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-geo="true">—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π</div>`;
        }

        if (query.toLowerCase().includes('–∫–æ–º–Ω–∞—Ç')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="5-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">5-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
        }

        // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        if (query.toLowerCase().includes('–∫–≤–∞—Ä—Ç–∏—Ä–∞') || query.toLowerCase().includes('—Å—Ç—É–¥–∏—è') || query.toLowerCase().includes('–¥–æ–º')) {
            cities.forEach(city => {
                const type = query.split(' ')[0].toLowerCase();
                if (propertyTypes[type]) {
                    suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                    data-combined="${type} ${city}">${type} –≤ ${city}</div>`;
                }
            });
        }

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ"
        const roomMatch = query.match(/(\d+)-–∫–æ–º–Ω–∞—Ç–Ω–∞—è/i);
        if (roomMatch) {
            cities.forEach(city => {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-combined="${roomMatch[1]} ${city}">${roomMatch[0]} –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ ${city}</div>`;
            });
        }

        if (suggestions) {
            suggestionsContainer.innerHTML = suggestions;
            suggestionsContainer.classList.remove('hidden');
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    suggestionsContainer.addEventListener('click', function(e) {
        if (e.target.dataset.type) {
            searchInput.value = e.target.textContent;
            addHiddenInput('property_type', propertyTypes[e.target.dataset.type]);
        }
        else if (e.target.dataset.city) {
            searchInput.value = e.target.dataset.city;
            addHiddenInput('location', e.target.dataset.city);
        }
        else if (e.target.dataset.deal) {
            searchInput.value = e.target.textContent;
            addHiddenInput('is_rental', dealTypes[e.target.dataset.deal]);
        }
        else if (e.target.dataset.query) {
            searchInput.value = e.target.dataset.query;
        }
        else if (e.target.dataset.geo) {
            searchInput.value = '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π';
            getGeolocation();
        }
        else if (e.target.dataset.combined) {
            const parts = e.target.dataset.combined.split(' ');
            if (parts.length === 2) {
                const [type, city] = parts;
                searchInput.value = `${type} –≤ ${city}`;
                if (propertyTypes[type]) {
                    addHiddenInput('property_type', propertyTypes[type]);
                }
                addHiddenInput('location', city);
            } else if (parts.length === 3) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –ú–æ—Å–∫–≤–∞"
                const rooms = parts[0];
                const city = parts[1];
                searchInput.value = `${rooms}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ ${city}`;
                addHiddenInput('rooms', rooms);
                addHiddenInput('location', city);
                addHiddenInput('property_type', 'new_flat,resale_flat');
            }
        }

        suggestionsContainer.classList.add('hidden');
    });

    // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    geolocationBtn.addEventListener('click', getGeolocation);

    function getGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = `${position.coords.latitude},${position.coords.longitude},5`;
                    geoCoordsInput.value = coords;
                    searchInput.value = '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π';
                    showToast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞', 'success');
                },
                error => {
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
                    console.error('Geolocation error:', error);
                }
            );
        } else {
            showToast('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', 'error');
        }
    }

    // –§–∏–ª—å—Ç—Ä—ã
    showFiltersBtn.addEventListener('click', function() {
        filtersModal.classList.remove('hidden');
    });

    closeFiltersBtn.addEventListener('click', function() {
        filtersModal.classList.add('hidden');
    });

    applyFiltersBtn.addEventListener('click', function() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –∫ —Ñ–æ—Ä–º–µ
        const filters = filtersModal.querySelectorAll('select, input[type="number"]');
        filters.forEach(filter => {
            if (filter.value) {
                const existing = searchForm.querySelector(`[name="${filter.name}"]`);
                if (existing) existing.remove();

                const clone = filter.cloneNode();
                clone.value = filter.value;
                searchForm.appendChild(clone);
            }
        });

        filtersModal.classList.add('hidden');
        searchForm.submit();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const searchValue = searchInput.value.trim();

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        const hiddenInputs = searchForm.querySelectorAll('input[type="hidden"]');
        hiddenInputs.forEach(input => {
            if (!['radius_filter'].includes(input.name)) {
                input.remove();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ"
        const roomsMatch = searchValue.match(/(\d+)\s*-?\s*–∫–æ–º–Ω–∞—Ç–Ω(–∞—è|—ã–µ|—É—é|–æ–π)/i);
        if (roomsMatch) {
            addHiddenInput('rooms', roomsMatch[1]);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        const typeMatch = searchValue.match(/(–∫–≤–∞—Ä—Ç–∏—Ä[–∞—É–µ—ã]|—Å—Ç—É–¥–∏[—é—è]|–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç[—ã–∞]|–¥–æ–º|–∫–æ–º–º–µ—Ä—á–µ—Å–∫[–∞—è–æ–π]|–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫[–∞–∏]|–≤—Ç–æ—Ä–∏—á–∫[–∞—É])/i);
        if (typeMatch) {
            const typeKey = typeMatch[1].toLowerCase();
            if (typeKey.startsWith('–∫–≤–∞—Ä—Ç–∏—Ä') || typeKey.startsWith('–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç')) {
                addHiddenInput('property_type', 'new_flat,resale_flat');
            } else if (typeKey.startsWith('—Å—Ç—É–¥–∏')) {
                addHiddenInput('apartment_type', 'studio');
            } else if (typeKey.startsWith('–¥–æ–º')) {
                addHiddenInput('property_type', 'house');
            } else if (typeKey.startsWith('–∫–æ–º–º–µ—Ä—á–µ—Å–∫')) {
                addHiddenInput('property_type', 'commercial');
            } else if (typeKey.startsWith('–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫')) {
                addHiddenInput('property_type', 'new_flat');
            } else if (typeKey.startsWith('–≤—Ç–æ—Ä–∏—á–∫')) {
                addHiddenInput('property_type', 'resale_flat');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ä–æ–¥–∞
        const cityMatch = searchValue.match(/(–≤|–Ω–∞)\s+(–º–æ—Å–∫–≤[–µ—É]|—Å–∞–Ω–∫—Ç\s*-?\s*–ø–µ—Ç–µ—Ä–±—É—Ä–≥[–µ]|—Å–ø–±|–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥[–µ]|–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫[–µ]|–∫–∞–∑–∞–Ω[–∏]|–Ω–∏–∂–Ω[–µ–∏–π][–π–º]\s*–Ω–æ–≤–≥–æ—Ä–æ–¥[–µ]|—Å–∞–º–∞—Ä[–µ]|–æ–º—Å–∫[–µ]|—á–µ–ª—è–±–∏–Ω—Å–∫[–µ]|—Ä–æ—Å—Ç–æ–≤[–µ]\s*-?\s*–Ω–∞\s*-?\s*–¥–æ–Ω—É|—É—Ñ[–µ]|–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫[–µ]|–ø–µ—Ä–º[–∏]|–≤–æ—Ä–æ–Ω–µ–∂[–µ]|–≤–æ–ª–≥–æ–≥—Ä–∞–¥[–µ]|–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä[–µ]|—Å–æ—á–∏|–ø–æ–¥–æ–ª—å—Å–∫|–º—ã—Ç–∏—â|–±–∞–ª–∞—à–∏—Ö|–ª—é–±–µ—Ä—Ü|—Ö–∏–º–∫|–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥|–º–∞–≥–∞–¥–∞–Ω[–µ])/i);
        if (cityMatch) {
            const cityKey = cityMatch[2].toLowerCase();
            let city = '';

            if (cityKey.startsWith('–º–æ—Å–∫–≤')) city = '–ú–æ—Å–∫–≤–∞';
            else if (cityKey.startsWith('—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥') || cityKey.startsWith('—Å–ø–±')) city = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';
            else if (cityKey.startsWith('–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥')) city = '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥';
            else if (cityKey.startsWith('–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫')) city = '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫';
            else if (cityKey.startsWith('–∫–∞–∑–∞–Ω')) city = '–ö–∞–∑–∞–Ω—å';
            else if (cityKey.startsWith('–Ω–∏–∂–Ω') && cityKey.includes('–Ω–æ–≤–≥–æ—Ä–æ–¥')) city = '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥';
            else if (cityKey.startsWith('—Å–∞–º–∞—Ä')) city = '–°–∞–º–∞—Ä–∞';
            else if (cityKey.startsWith('–æ–º—Å–∫')) city = '–û–º—Å–∫';
            else if (cityKey.startsWith('—á–µ–ª—è–±–∏–Ω—Å–∫')) city = '–ß–µ–ª—è–±–∏–Ω—Å–∫';
            else if (cityKey.startsWith('—Ä–æ—Å—Ç–æ–≤') && cityKey.includes('–¥–æ–Ω—É')) city = '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É';
            else if (cityKey.startsWith('—É—Ñ')) city = '–£—Ñ–∞';
            else if (cityKey.startsWith('–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫')) city = '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫';
            else if (cityKey.startsWith('–ø–µ—Ä–º')) city = '–ü–µ—Ä–º—å';
            else if (cityKey.startsWith('–≤–æ—Ä–æ–Ω–µ–∂')) city = '–í–æ—Ä–æ–Ω–µ–∂';
            else if (cityKey.startsWith('–≤–æ–ª–≥–æ–≥—Ä–∞–¥')) city = '–í–æ–ª–≥–æ–≥—Ä–∞–¥';
            else if (cityKey.startsWith('–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä')) city = '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä';
            else if (cityKey.startsWith('—Å–æ—á–∏')) city = '–°–æ—á–∏';
            else if (cityKey.startsWith('–º–∞–≥–∞–¥–∞–Ω')) city = '–ú–∞–≥–∞–¥–∞–Ω';

            if (city) {
                addHiddenInput('location', city);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞/–ø–æ–∫—É–ø–∫–∞)
        const rentMatch = searchValue.match(/(—Å–Ω—è—Ç—å|–∞—Ä–µ–Ω–¥[–∞—É–µ—ã]|–ø–æ—Å—É—Ç–æ—á–Ω[–∞—è–æ–π]|–ø–æ–º–µ—Å—è—á–Ω[–∞—è–æ–π])/i);
        const buyMatch = searchValue.match(/(–∫—É–ø[–∏–∏—Ç—å]|–ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏|–ø—Ä–æ–¥–∞–∂[–∞–µ]|–ø–æ–∫—É–ø–∫[–∞–µ])/i);

        if (rentMatch) {
            addHiddenInput('is_rental', 'monthly,daily');
        } else if (buyMatch) {
            addHiddenInput('is_rental', 'no');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–µ–Ω—ã
        const priceMatch = searchValue.match(/(—Ü–µ–Ω–∞|—Å—Ç–æ–∏–º–æ—Å—Ç—å)\s*(–æ—Ç|–¥–æ)?\s*(\d+)\s*(–º–ª–Ω|—Ç—ã—Å|—Ç\.?—Ä|—Ä\.?)/i);
        if (priceMatch) {
            let amount = parseFloat(priceMatch[3]);
            const unit = priceMatch[4];

            if (unit.includes('–º–ª–Ω')) amount *= 1000000;
            else if (unit.includes('—Ç—ã—Å')) amount *= 1000;

            if (priceMatch[2] === '–æ—Ç') {
                addHiddenInput('min_price', amount);
            } else if (priceMatch[2] === '–¥–æ') {
                addHiddenInput('max_price', amount);
            } else {
                // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω (+-20%)
                addHiddenInput('min_price', amount * 0.8);
                addHiddenInput('max_price', amount * 1.2);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–æ—â–∞–¥–∏
        const areaMatch = searchValue.match(/(–ø–ª–æ—â–∞–¥—å|–ø–ª–æ—â–∞–¥—å—é|–º–µ—Ç—Ä–∞–∂)\s*(\d+)\s*-?\s*(\d+)?\s*(–º|–º¬≤|–∫–≤\.?\s*–º)/i);
        if (areaMatch) {
            const minArea = parseFloat(areaMatch[2]);
            const maxArea = areaMatch[3] ? parseFloat(areaMatch[3]) : minArea;
            addHiddenInput('min_area', minArea);
            addHiddenInput('max_area', maxArea);
        }

        // –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –µ—Å—Ç—å "—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π" –∏ –µ—Å—Ç—å –≥–µ–æ–¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–∞–¥–∏—É—Å–∞
        if ((searchValue.toLowerCase().includes('—Ä—è–¥–æ–º') ||
             searchValue.toLowerCase().includes('–Ω–µ–¥–∞–ª–µ–∫–æ'))) {
            if (geoCoordsInput.value) {
                // –§–∏–ª—å—Ç—Ä —Ä–∞–¥–∏—É—Å–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ geoCoordsInput
            } else {
                getGeolocation();
                return; // –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö
            }
        }

        this.submit();
    });

    function addHiddenInput(name, value) {
        const existing = searchForm.querySelector(`input[name="${name}"]`);
        if (existing) existing.remove();

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        searchForm.appendChild(input);
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>
{% endblock %}