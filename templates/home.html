{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .category-card { animation: fadeIn 0.6s ease; }
    .gradient-bg { background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    #search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        border: 1px solid #e5e7eb;
        border-top: none;
    }
    #search-suggestions div {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }
    #search-suggestions div:hover {
        background-color: #f9fafb;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    #filters-modal {
        transition: opacity 0.3s ease;
    }
    #filters-modal > div {
        transition: transform 0.3s ease;
    }
    #filters-modal:not(.hidden) {
        display: flex;
        opacity: 1;
    }
    #filters-modal:not(.hidden) > div {
        transform: translateY(0);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .toast {
        animation: slideIn 0.3s ease forwards;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>

<!-- –ì–µ—Ä–æ–π-—Å–µ–∫—Ü–∏—è -->
<div class="hero bg-blue-600 text-white py-20">
    <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 animate-pulse">–°–µ—Ä–≤–∏—Å –≤—ã–≥–æ–¥–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ —Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é</h1>
        <p class="text-xl mb-8 opacity-95">–ë–∞–∑–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –±—Ä–æ–∫–µ—Ä–æ–≤ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>

        <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="max-w-3xl mx-auto bg-white rounded-xl p-2 shadow-2xl">
            <form class="flex flex-col" id="search-form"
                  action="{% if user.is_authenticated %}{% url 'properties:property-list' %}{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}{% endif %}"
                  method="get">
                <div class="relative flex items-center">
                    <input type="text"
                           name="search"
                           placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, –º–µ—Ç—Ä–æ, '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '—Ü–µ–Ω–∞ 5-10 –º–ª–Ω', '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π'..."
                           class="flex-grow px-6 py-4 rounded-lg text-gray-800 border-0 focus:ring-4 focus:ring-blue-200"
                           id="location-search"
                           autocomplete="off">

                    <button type="button" id="geolocation-btn" class="absolute right-16 text-gray-500 hover:text-blue-600">
                        <i class="fas fa-location-arrow"></i>
                    </button>

                    <button type="submit"
                            class="bg-blue-700 hover:bg-blue-800 px-6 py-4 rounded-lg
                                   font-bold text-white transition-all duration-300
                                   transform hover:scale-105 ml-2">
                        –ù–∞–π—Ç–∏
                    </button>
                </div>

                <div id="search-suggestions" class="hidden bg-white mt-1 rounded-lg shadow-lg z-10 max-h-60 overflow-auto">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                </div>

                <div class="text-xs text-gray-500 mt-2 pl-2">
                    –ü—Ä–∏–º–µ—Ä—ã: "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –≤ –ú–æ—Å–∫–≤–µ", "–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç 5 –º–ª–Ω", "–¥–æ–º 100 –º¬≤"
                </div>

                <button type="button" id="show-filters" class="mt-2 text-blue-600 text-sm font-medium self-start flex items-center">
                    <i class="fas fa-sliders-h mr-2"></i> –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </form>

            <!-- –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
            <input type="hidden" id="geo-coords" name="radius_filter">
        </div>
    </div>
</div>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div class="container mx-auto px-4 py-16">
    <h2 class="text-4xl font-bold text-center mb-16">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- –ë—Ä–æ–∫–µ—Ä—ã -->
        <a href="{% if user.is_authenticated %}{% url 'broker-list' %}{% else %}{% url 'register' %}?next={% url 'broker-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-blue-600 flex items-center justify-center">
                    <i class="fas fa-user-tie text-white text-6xl"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–ë—Ä–æ–∫–µ—Ä—ã</h3>
                    <p class="text-gray-600">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é</p>
                </div>
            </div>
        </a>

        <!-- –û–±—ä–µ–∫—Ç—ã -->
        <a href="{% if user.is_authenticated %}{% url 'properties:property-list' %}{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-orange-500 flex items-center justify-center relative">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                        <i class="fas fa-home text-white text-6xl"></i>
                    </div>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–û–±—ä–µ–∫—Ç—ã</h3>
                    <p class="text-gray-600">–í—Å—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</p>
                </div>
            </div>
        </a>

        <!-- –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏ -->
        <a href="{% if user.is_authenticated %}{% url 'developer-list' %}{% else %}{% url 'register' %}?next={% url 'developer-list' %}{% endif %}"
           class="group">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden
                        transition-transform duration-300
                        hover:scale-105 transform">
                <div class="h-48 bg-green-600 flex items-center justify-center">
                    <i class="fas fa-building text-white text-6xl"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</h3>
                    <p class="text-gray-600">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤</p>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã -->
<div class="bg-gray-50 py-20">
    <div class="container mx-auto px-4">
        <h2 class="text-4xl font-bold text-center mb-12">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for property in featured_properties %}
            <div class="bg-white rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 overflow-hidden">
                <div class="relative h-64 overflow-hidden group">
                    {% if property.main_image %}
                        <img src="{{ property.main_image.url }}"
                             alt="{{ property.title }}"
                             class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    {% else %}
                        <div class="w-full h-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-home text-white text-6xl"></i>
                        </div>
                    {% endif %}

                    {% if property.is_premium %}
                    <div class="absolute top-4 right-4 bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-4 py-2
                               rounded-full text-sm font-bold shadow-md">
                        ‚ö° PREMIUM
                    </div>
                    {% endif %}
                </div>

                <div class="p-6">
                    <h3 class="text-2xl font-bold mb-3">{{ property.title }}</h3>
                    <div class="flex items-center mb-4 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        <span>{{ property.location }}</span>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold text-blue-600">{{ property.price|floatformat:"0" }} ‚ÇΩ</span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                            {{ property.total_area|floatformat:"0" }} –º¬≤
                        </span>
                    </div>

                    <a href="{% if user.is_authenticated %}{% url 'properties:property-detail' property.id %}{% else %}{% url 'register' %}?next={% url 'properties:property-detail' property.id %}{% endif %}"
                       class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-3 rounded-xl
                              transition-all transform hover:scale-105">
                        üìå –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ "–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" -->
        <div class="text-center mt-12">
            <a href="{% if user.is_authenticated %}{% url 'properties:property-list' %}{% else %}{% url 'register' %}?next={% url 'properties:property-list' %}{% endif %}"
               class="inline-block bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold px-12 py-4
                      rounded-2xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
                –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
            </a>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div id="filters-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">–£—Ç–æ—á–Ω–∏—Ç—å –ø–æ–∏—Å–∫</h3>
            <button id="close-filters" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                <select name="property_type" class="w-full p-2 border rounded">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="new_flat">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</option>
                    <option value="resale_flat">–í—Ç–æ—Ä–∏—á–∫–∞</option>
                    <option value="house">–î–æ–º</option>
                    <option value="commercial">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_price" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_price" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_area" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_area" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                <div class="flex space-x-2">
                    <input type="number" name="rooms__gte" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="rooms__lte" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">–≠—Ç–∞–∂</label>
                <div class="flex space-x-2">
                    <input type="number" name="min_floor" placeholder="–û—Ç" class="w-1/2 p-2 border rounded">
                    <input type="number" name="max_floor" placeholder="–î–æ" class="w-1/2 p-2 border rounded">
                </div>
            </div>

            <button type="button" id="apply-filters" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('location-search');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const geolocationBtn = document.getElementById('geolocation-btn');
    const geoCoordsInput = document.getElementById('geo-coords');
    const showFiltersBtn = document.getElementById('show-filters');
    const filtersModal = document.getElementById('filters-modal');
    const closeFiltersBtn = document.getElementById('close-filters');
    const applyFiltersBtn = document.getElementById('apply-filters');

    // –¢–∏–ø—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    const propertyTypes = {
        '–∫–≤–∞—Ä—Ç–∏—Ä–∞': 'apartment',
        '–¥–æ–º': 'house',
        '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è': 'commercial',
        '–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞': 'new_flat',
        '–≤—Ç–æ—Ä–∏—á–∫–∞': 'resale_flat'
    };

    // –ì–æ—Ä–æ–¥–∞ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    const cities = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
                   '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É'];

    // –¢–∏–ø—ã —Å–¥–µ–ª–æ–∫
    const dealTypes = {
        '–∞—Ä–µ–Ω–¥–∞': 'rent',
        '–∫—É–ø–∏—Ç—å': 'sale',
        '–ø—Ä–æ–¥–∞–∂–∞': 'sale'
    };

    // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (query.length < 2) {
            suggestionsContainer.classList.add('hidden');
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        let suggestions = '';

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        Object.keys(propertyTypes).forEach(type => {
            if (type.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-type="${propertyTypes[type]}">${type}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
        cities.forEach(city => {
            if (city.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-city="${city}">${city}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∞–º —Å–¥–µ–ª–æ–∫
        Object.keys(dealTypes).forEach(deal => {
            if (deal.toLowerCase().includes(query.toLowerCase())) {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-deal="${dealTypes[deal]}">${deal}</div>`;
            }
        });

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        if (/—Ü–µ–Ω–∞\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ 5-10 –º–ª–Ω">—Ü–µ–Ω–∞ 5-10 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω">—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω">—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω</div>`;
        }

        if (/–ø–ª–æ—â–∞–¥—å\s*\d*/i.test(query)) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤">–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤">–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤</div>`;
        }

        if (query.toLowerCase().includes('—Ä—è–¥–æ–º') || query.toLowerCase().includes('–Ω–µ–¥–∞–ª–µ–∫–æ')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-geo="true">—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π</div>`;
        }

        if (query.toLowerCase().includes('–∫–æ–º–Ω–∞—Ç')) {
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
            suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                            data-query="4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è">4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</div>`;
        }

        // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        if (query.toLowerCase().includes('–∫–≤–∞—Ä—Ç–∏—Ä–∞') || query.toLowerCase().includes('–¥–æ–º')) {
            cities.forEach(city => {
                suggestions += `<div class="p-3 hover:bg-gray-100 cursor-pointer"
                                data-combined="${city}">${query.split(' ')[0]} –≤ ${city}</div>`;
            });
        }

        if (suggestions) {
            suggestionsContainer.innerHTML = suggestions;
            suggestionsContainer.classList.remove('hidden');
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    suggestionsContainer.addEventListener('click', function(e) {
        if (e.target.dataset.type) {
            searchInput.value = e.target.textContent;
            addHiddenInput('property_type', e.target.dataset.type);
        }
        else if (e.target.dataset.city) {
            searchInput.value = e.target.dataset.city;
            addHiddenInput('location', e.target.dataset.city);
        }
        else if (e.target.dataset.deal) {
            searchInput.value = e.target.textContent;
            addHiddenInput('deal_type', e.target.dataset.deal);
        }
        else if (e.target.dataset.query) {
            searchInput.value = e.target.dataset.query;
        }
        else if (e.target.dataset.geo) {
            searchInput.value = '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π';
            getGeolocation();
        }
        else if (e.target.dataset.combined) {
            searchInput.value = e.target.textContent;
            const type = e.target.textContent.split(' ')[0];
            const city = e.target.dataset.combined;

            if (propertyTypes[type.toLowerCase()]) {
                addHiddenInput('property_type', propertyTypes[type.toLowerCase()]);
            }
            addHiddenInput('location', city);
        }

        suggestionsContainer.classList.add('hidden');
    });

    // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    geolocationBtn.addEventListener('click', getGeolocation);

    function getGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = `${position.coords.latitude},${position.coords.longitude},5`;
                    geoCoordsInput.value = coords;
                    searchInput.value = '—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π';
                    showToast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞', 'success');
                },
                error => {
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
                    console.error('Geolocation error:', error);
                }
            );
        } else {
            showToast('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', 'error');
        }
    }

    // –§–∏–ª—å—Ç—Ä—ã
    showFiltersBtn.addEventListener('click', function() {
        filtersModal.classList.remove('hidden');
    });

    closeFiltersBtn.addEventListener('click', function() {
        filtersModal.classList.add('hidden');
    });

    applyFiltersBtn.addEventListener('click', function() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –∫ —Ñ–æ—Ä–º–µ
        const filters = filtersModal.querySelectorAll('select, input[type="number"]');
        filters.forEach(filter => {
            if (filter.value) {
                const existing = searchForm.querySelector(`[name="${filter.name}"]`);
                if (existing) existing.remove();

                const clone = filter.cloneNode();
                clone.value = filter.value;
                searchForm.appendChild(clone);
            }
        });

        filtersModal.classList.add('hidden');
        searchForm.submit();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const searchValue = searchInput.value.trim();

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        const hiddenInputs = searchForm.querySelectorAll('input[type="hidden"]');
        hiddenInputs.forEach(input => {
            if (!['radius_filter'].includes(input.name)) {
                input.remove();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ"
        const roomsMatch = searchValue.match(/(\d+)-–∫–æ–º–Ω–∞—Ç–Ω–∞—è/i);
        if (roomsMatch) {
            addHiddenInput('rooms', roomsMatch[1]);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥–æ—Ä–æ–¥–∞
        cities.forEach(city => {
            if (searchValue.toLowerCase().includes(city.toLowerCase())) {
                addHiddenInput('location', city);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞/–ø–æ–∫—É–ø–∫–∞)
        Object.keys(dealTypes).forEach(deal => {
            if (searchValue.toLowerCase().includes(deal.toLowerCase())) {
                addHiddenInput('deal_type', dealTypes[deal]);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        Object.keys(propertyTypes).forEach(type => {
            if (searchValue.toLowerCase().includes(type.toLowerCase())) {
                addHiddenInput('property_type', propertyTypes[type]);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "—Ü–µ–Ω–∞ 5-10 –º–ª–Ω"
        const priceMatch = searchValue.match(/—Ü–µ–Ω–∞\s*(\d+)\s*-\s*(\d+)\s*–º–ª–Ω/i);
        if (priceMatch) {
            const minPrice = priceMatch[1] + '000000';
            const maxPrice = priceMatch[2] + '000000';
            addHiddenInput('min_price', minPrice);
            addHiddenInput('max_price', maxPrice);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "—Ü–µ–Ω–∞ –¥–æ 5 –º–ª–Ω"
        const priceToMatch = searchValue.match(/—Ü–µ–Ω–∞\s*–¥–æ\s*(\d+)\s*–º–ª–Ω/i);
        if (priceToMatch) {
            const maxPrice = priceToMatch[1] + '000000';
            addHiddenInput('max_price', maxPrice);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "—Ü–µ–Ω–∞ –æ—Ç 10 –º–ª–Ω"
        const priceFromMatch = searchValue.match(/—Ü–µ–Ω–∞\s*–æ—Ç\s*(\d+)\s*–º–ª–Ω/i);
        if (priceFromMatch) {
            const minPrice = priceFromMatch[1] + '000000';
            addHiddenInput('min_price', minPrice);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "–ø–ª–æ—â–∞–¥—å 50-70 –º¬≤"
        const areaMatch = searchValue.match(/–ø–ª–æ—â–∞–¥—å\s*(\d+)\s*-\s*(\d+)\s*–º¬≤/i);
        if (areaMatch) {
            addHiddenInput('min_area', areaMatch[1]);
            addHiddenInput('max_area', areaMatch[2]);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "–ø–ª–æ—â–∞–¥—å –æ—Ç 80 –º¬≤"
        const areaFromMatch = searchValue.match(/–ø–ª–æ—â–∞–¥—å\s*–æ—Ç\s*(\d+)\s*–º¬≤/i);
        if (areaFromMatch) {
            addHiddenInput('min_area', areaFromMatch[1]);
        }

        // –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –µ—Å—Ç—å "—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π" –∏ –µ—Å—Ç—å –≥–µ–æ–¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–∞–¥–∏—É—Å–∞
        if ((searchValue.toLowerCase().includes('—Ä—è–¥–æ–º') ||
             searchValue.toLowerCase().includes('–Ω–µ–¥–∞–ª–µ–∫–æ')) &&
            geoCoordsInput.value) {
            // –§–∏–ª—å—Ç—Ä —Ä–∞–¥–∏—É—Å–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ geoCoordsInput
        }

        this.submit();
    });

    function addHiddenInput(name, value) {
        const existing = searchForm.querySelector(`input[name="${name}"]`);
        if (existing) existing.remove();

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        searchForm.appendChild(input);
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>
{% endblock %}