name: Deploy to Yandex Cloud VM

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 89.169.168.72 >> ~/.ssh/known_hosts

      - name: Create .env
        shell: bash
        run: |
          set -euo pipefail
          cat > .env <<EOF
          DEBUG=False
          SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          CLOUDINARY_CLOUD_NAME=dqgwzhywm
          CLOUDINARY_API_KEY=164662831511784
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

          YOOMONEY_ACCOUNT_ID=1105130
          YOOMONEY_SECRET_KEY=${{ secrets.YOOMONEY_SECRET_KEY }}

          EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
          EMAIL_HOST=smtp.yandex.ru
          EMAIL_PORT=465
          EMAIL_USE_SSL=True
          EMAIL_HOST_USER=goldinpav@yandex.ru
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          DEFAULT_FROM_EMAIL=WinWinDeal <goldinpav@yandex.ru>

          YANDEX_MAPS_API_KEY=${{ secrets.YANDEX_MAPS_API_KEY }}
          YANDEX_GEOCODER_API_KEY=${{ secrets.YANDEX_GEOCODER_API_KEY }}
          YANDEX_GEO_SUGGEST_API_KEY=${{ secrets.YANDEX_GEO_SUGGEST_API_KEY }}

          CSRF_COOKIE_SECURE=True
          SESSION_COOKIE_SECURE=True
          # Включайте True только если HTTPS реально настроен
          SECURE_SSL_REDIRECT=False

          ALLOWED_HOSTS=89.169.168.72,localhost,127.0.0.1,winwindeal.ru,www.winwindeal.ru
          CSRF_TRUSTED_ORIGINS=https://winwindeal.ru,https://www.winwindeal.ru
          EOF
          chmod 600 .env

      - name: Sync project to server
        shell: bash
        run: |
          set -euo pipefail
          rsync -az --delete \
            --exclude '.git/' \
            --exclude 'venv/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude 'media/' \
            --exclude 'staticfiles/' \
            ./ wic@89.169.168.72:/home/wic/real_estate_portal/

      - name: Upload .env
        shell: bash
        run: |
          set -euo pipefail
          scp .env wic@89.169.168.72:/home/wic/real_estate_portal/.env
          ssh wic@89.169.168.72 "chmod 600 /home/wic/real_estate_portal/.env"

      - name: Deploy on server
        shell: bash
        run: |
          set -euo pipefail
          ssh wic@89.169.168.72 <<'SSH'
          set -euo pipefail
          cd /home/wic/real_estate_portal

          # Gunicorn config (порт 3000 под Caddy reverse_proxy)
          cat > gunicorn_config.py << 'EOF'
          bind = "0.0.0.0:3000"
          workers = 3
          loglevel = "info"
          errorlog = "-"
          accesslog = "-"
          EOF

          # venv + deps
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # migrate + static
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput

          # restart app
          sudo systemctl daemon-reload
          sudo systemctl restart real_estate_portal

          # fix Caddy "204" stub -> reverse proxy
          sudo ufw allow 80/tcp || true
          sudo ufw allow 443/tcp || true

          cat << 'EOF' | sudo tee /etc/caddy/Caddyfile > /dev/null
          winwindeal.ru, www.winwindeal.ru {
              encode gzip
              reverse_proxy 127.0.0.1:3000
          }
          EOF

          sudo systemctl restart caddy || sudo systemctl restart caddy.service

          echo "✅✅✅ Deployment completed successfully!"
          SSH
