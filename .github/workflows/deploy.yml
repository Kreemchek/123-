name: Deploy to Yandex Cloud VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: 89.169.168.72
        username: wic
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/wic/real_estate_portal
          
          # Принудительно обновляем до версии из GitHub
          git fetch --all
          git reset --hard origin/main
          git clean -fd
          
          echo "✅ Repository updated to latest version from GitHub"
          
          # Создаем .env файл построчно
          echo "DEBUG=False" > .env
          echo "SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> .env
          echo "DATABASE_URL=postgres://real_estate_user:vladnext232@localhost:5432/real_estate_db" >> .env
          echo "CLOUDINARY_CLOUD_NAME=dqgwzhywm" >> .env
          echo "CLOUDINARY_API_KEY=164662831511784" >> .env
          echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" >> .env
          echo "YOOMONEY_ACCOUNT_ID=1105130" >> .env
          echo "YOOMONEY_SECRET_KEY=test_evMMyWGLIawYaOMUELuBxzSO5XJbnaDcrJeulp2lX8w" >> .env
          echo "EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend" >> .env
          echo "EMAIL_HOST=smtp.yandex.ru" >> .env
          echo "EMAIL_PORT=465" >> .env
          echo "EMAIL_USE_SSL=True" >> .env
          echo "EMAIL_HOST_USER=goldinpav@yandex.ru" >> .env
          echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> .env
          echo "DEFAULT_FROM_EMAIL=WinWinDeal <goldinpav@yandex.ru>" >> .env
          echo "YANDEX_MAPS_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f" >> .env
          echo "YANDEX_GEOCODER_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f" >> .env
          echo "YANDEX_GEO_SUGGEST_API_KEY=7979f3d5-7f35-4fd8-893c-e5f1ecaeb3a4" >> .env
          echo "CSRF_COOKIE_SECURE=True" >> .env
          echo "SESSION_COOKIE_SECURE=True" >> .env
          echo "SECURE_SSL_REDIRECT=False" >> .env
          echo "ALLOWED_HOSTS=89.169.168.72,localhost,127.0.0.1,192.168.1.98" >> .env
          
          # Защищаем .env файл
          chmod 600 .env
          chown wic:wic .env
          
          echo "✅ Environment file created"
          
          # Создаем виртуальное окружение если его нет
          if [ ! -d "venv" ]; then
            python3 -m venv venv
            echo "✅ Virtual environment created"
          fi
          
          # Активируем виртуальное окружение и устанавливаем зависимости Python
          source venv/bin/activate
          
          # Обновляем pip и устанавливаем зависимости
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "✅ Python dependencies installed"
          
          # Применяем миграции БД
          python manage.py migrate --noinput
          
          echo "✅ Database migrations applied"
          
          # Сбор статики Django
          python manage.py collectstatic --noinput
          
          echo "✅ Static files collected"
          
          # Перезапускаем Gunicorn
          sudo systemctl daemon-reload
          sudo systemctl restart real_estate_portal
          
          echo "✅ Gunicorn restarted"
          
          echo "✅✅✅ ✅  Deployment completed successfully!"