name: Deploy to Yandex Cloud VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: 89.169.168.72
        username: wic
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/wic/real_estate_portal
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ –≤–µ—Ä—Å–∏–∏ –∏–∑ GitHub
          git fetch --all
          git reset --hard origin/main
          git clean -fd  # –£–¥–∞–ª—è–µ–º –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
          
          echo "‚úÖ Repository updated to latest version from GitHub"
          
          # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π .env —Ñ–∞–π–ª –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          cat > .env << EOF
DEBUG=0
DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY
DATABASE_URL=postgres://real_estate_user:vladnext232@localhost:5432/real_estate_db
YOOMONEY_ACCOUNT_ID=1105130
YOOMONEY_SECRET_KEY=test_evMMyWGLIawYaOMUELuBxzSO5XJbnaDcrJeulp2lX8w

# Cloudinary
CLOUDINARY_CLOUD_NAME=dqgwzhywm
CLOUDINARY_API_KEY=164662831511784
CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET

# Email
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=465
EMAIL_USE_SSL=True
EMAIL_HOST_USER=goldinpav@yandex.ru
EMAIL_HOST_PASSWORD=$EMAIL_PASSWORD
DEFAULT_FROM_EMAIL=WinWinDeal <goldinpav@yandex.ru>

# Yandex Maps
YANDEX_MAPS_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f
YANDEX_GEOCODER_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f
YANDEX_GEO_SUGGEST_API_KEY=7979f3d5-7f35-4fd8-893c-e5f1ecaeb3a4

# Security
CSRF_COOKIE_SECURE=True
SESSION_COOKIE_SECURE=True
SECURE_SSL_REDIRECT=False

# Hosts
ALLOWED_HOSTS=89.169.168.72,localhost,127.0.0.1,192.168.1.98
EOF
          
          # –ó–∞—â–∏—â–∞–µ–º .env —Ñ–∞–π–ª
          chmod 600 .env
          chown wic:wic .env
          
          echo "‚úÖ Environment file created"
          
          # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -d "venv" ]; then
            python3 -m venv venv
            echo "‚úÖ Virtual environment created"
          fi
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
          source venv/bin/activate
          
          # –û–±–Ω–æ–≤–ª—è–µ–º pip –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "‚úÖ Python dependencies installed"
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
          python manage.py migrate --noinput
          
          echo "‚úÖ Database migrations applied"
          
          # –°–±–æ—Ä —Å—Ç–∞—Ç–∏–∫–∏ Django
          python manage.py collectstatic --noinput
          
          echo "‚úÖ Static files collected"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Gunicorn
          sudo systemctl restart real_estate_portal
          
          echo "‚úÖ Gunicorn restarted"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx
          sudo systemctl reload nginx
          
          echo "‚úÖ Nginx reloaded"
          
          echo "üéâ Deployment completed successfully! All changes from repository applied to production."
      env:
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}