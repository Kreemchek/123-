name: Deploy to Yandex Cloud VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: 89.169.168.72
        username: wic
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/wic/real_estate_portal
          
          # Принудительно обновляем до версии из GitHub (игнорируя локальные изменения)
          git fetch --all
          git reset --hard origin/main
          git clean -fd  # Удаляем неотслеживаемые файлы
          
          echo "✅ Repository updated to latest version from GitHub"
          
          # Создаем безопасный .env файл из секретов
          cat > .env << EOF
# Database
DB_ENGINE=django.contrib.gis.db.backends.postgis
DB_NAME=real_estate_db
DB_USER=real_estate_user
DB_PASSWORD=vladnext232
DB_HOST=localhost
DB_PORT=5432

# Django Secrets
SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}

# Cloudinary
CLOUDINARY_CLOUD_NAME=dqgwzhywm
CLOUDINARY_API_KEY=164662831511784
CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

# YooMoney
YOOMONEY_ACCOUNT_ID=1105130
YOOMONEY_SECRET_KEY=test_evMMyWGLIawYaOMUELuBxzSO5XJbnaDcrJeulp2lX8w

# Email
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=465
EMAIL_USE_SSL=True
EMAIL_HOST_USER=goldinpav@yandex.ru
EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
DEFAULT_FROM_EMAIL=WinWinDeal <goldinpav@yandex.ru>

# Yandex Maps
YANDEX_MAPS_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f
YANDEX_GEOCODER_API_KEY=3585e6f5-6323-4098-8a4d-b279da5b0c4f
YANDEX_GEO_SUGGEST_API_KEY=7979f3d5-7f35-4fd8-893c-e5f1ecaeb3a4

# Environment
DEBUG=False
ENVIRONMENT=production

# Security
CSRF_COOKIE_SECURE=True
SESSION_COOKIE_SECURE=True
SECURE_SSL_REDIRECT=False

# Hosts
ALLOWED_HOSTS=89.169.168.72,localhost,127.0.0.1,192.168.1.98
EOF
          
          # Защищаем .env файл
          chmod 600 .env
          chown wic:wic .env
          
          echo "✅ Environment file created"
          
          # Создаем виртуальное окружение если его нет
          if [ ! -d "venv" ]; then
            python3 -m venv venv
            echo "✅ Virtual environment created"
          fi
          
          # Активируем виртуальное окружение и устанавливаем зависимости Python
          source venv/bin/activate
          
          # Устанавливаем зависимости Python
          pip install -r requirements.txt
          
          echo "✅ Python dependencies installed"
          
          # Применяем миграции БД
          python manage.py migrate --noinput
          
          echo "✅ Database migrations applied"
          
          # Сбор статики Django
          python manage.py collectstatic --noinput
          
          echo "✅ Static files collected"
          
          # Перезапускаем Gunicorn
          sudo systemctl daemon-reload
          sudo systemctl restart real_estate_portal
          
          echo "✅ Gunicorn restarted"
          
          echo "✅✅✅ Deployment completed successfully! All changes from repository applied to production."